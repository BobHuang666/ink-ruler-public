import{R as D,d as ge,u as be,l as p,m as A,n as ke,M as Ve,c as h,a as w,e as a,w as t,r,j as F,g as n,D as m,f as X,b as H,s as Y,P as he,F as Z,x as ee,q as Pe,y as Ce,E as d,A as xe,o as u,_ as Ue}from"./index-DE8jxKp-.js";import{u as Fe,j as De}from"./essay-Bk8B8jm0.js";import{u as Me,g as Le}from"./classic-DnoLlFHH.js";async function ae(y){await D.patch("/users/me",y);const o=(await D.get("/users/me")).data,b=o.membership;return{id:o.id,email:o.email,phone:o.phone,nickname:o.nickname||"",avatar:o.avatar,role:o.role,status:o.status,created_at:o.created_at??"",updated_at:o.updated_at??"",...b&&{membership:{id:0,user_id:o.id,plan:b.plan,started_at:"",expired_at:b.expired_at,status:b.status,created_at:"",updated_at:""}}}}async function Se(){return(await D.get("/memberships/me")).data}async function $e(y){return(await D.post("/memberships/purchase",{plan:y})).data}async function Re(y){await D.post("/users/me/cancel",{password:y})}async function qe(y){return(await D.post("/feedbacks",y)).data}const Ee={class:"profile-page"},Ae={class:"container"},Be={class:"avatar-section"},Ie={class:"header-font"},Ne={class:"email"},je={key:0,class:"membership-info"},Ke={class:"membership-actions"},Te={class:"favorites-list"},ze={class:"favorite-time"},Ge={class:"favorites-list"},He={class:"favorite-meta"},Je={class:"security-section"},Oe=ge({__name:"Profile",setup(y){const L=xe(),o=be(),b=p("info"),B=p(),I=p(),k=p(null),i=A({nickname:"",email:"",phone:"",avatar:""}),c=A({oldPassword:"",newPassword:"",confirmPassword:""}),_=A({content:"",contact:""}),M=p(!1),N=p(!1),P=A({password:""}),x=p([]),S=p(!1),j=p(null),U=p([]),$=p(!1),K=p(null),te={nickname:[{required:!0,message:"请输入昵称",trigger:"blur"},{min:2,max:20,message:"昵称长度在2到20个字符",trigger:"blur"}]},se={oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(l,e,R)=>{e!==c.newPassword?R(new Error("两次输入的密码不一致")):R()},trigger:"blur"}]};ke(async()=>{o.user&&(i.nickname=o.user.nickname,i.email=o.user.email||"",i.phone=o.user.phone||"",i.avatar=o.user.avatar||""),await ie()}),Ve(b,l=>{l==="favorites"&&le(),l==="classicFavorites"&&ne()});async function le(){S.value=!0;try{x.value=await De()}catch{x.value=[]}finally{S.value=!1}}async function oe(l){j.value=l.essay_id;try{await Fe(l.essay_id),x.value=x.value.filter(e=>e.essay_id!==l.essay_id),d.success("已取消收藏")}catch(e){d.error(e.message||"取消收藏失败")}finally{j.value=null}}async function ne(){$.value=!0;try{U.value=await Le()}catch{U.value=[]}finally{$.value=!1}}async function re(l){K.value=l.id;try{await Me(l.id),U.value=U.value.filter(e=>e.id!==l.id),d.success("已取消收藏")}catch(e){d.error(e.message||"取消收藏失败")}finally{K.value=null}}async function ie(){try{k.value=await Se()}catch{}}async function de(){B.value&&await B.value.validate(async l=>{if(l)try{await ae({nickname:i.nickname}),await o.fetchUser(),d.success("更新成功")}catch(e){d.error(e.message||"更新失败")}})}async function ue(){I.value&&await I.value.validate(async l=>{if(l)try{await ae({password_old:c.oldPassword,password_new:c.newPassword}),d.success("密码修改成功"),c.oldPassword="",c.newPassword="",c.confirmPassword=""}catch(e){d.error(e.message||"密码修改失败")}})}async function J(){try{const l=await $e("student");k.value=l,await o.fetchUser(),d.success("会员购买成功")}catch(l){d.error(l.message||"购买失败")}}async function ce(){if(!_.content.trim()){d.warning("请输入反馈内容");return}try{await qe({content:_.content.trim(),contact:_.contact.trim()||void 0}),d.success("反馈提交成功，感谢您的建议！"),_.content="",_.contact=""}catch(l){d.error(l.message||"提交失败")}}function me(){P.password="",M.value=!0}async function T(){if(!P.password.trim()){d.warning("请输入当前密码");return}N.value=!0;try{await Re(P.password),o.clearLocal(),M.value=!1,d.success("账号已注销"),L.replace("/")}catch(l){d.error(l.message||"注销失败")}finally{N.value=!1}}return(l,e)=>{const R=r("el-avatar"),z=r("el-tag"),V=r("el-card"),O=r("el-col"),g=r("el-input"),f=r("el-form-item"),v=r("el-button"),q=r("el-form"),C=r("el-tab-pane"),E=r("el-descriptions-item"),fe=r("el-descriptions"),G=r("el-empty"),Q=r("router-link"),pe=r("el-alert"),ve=r("el-dialog"),_e=r("el-tabs"),we=r("el-row"),W=he("loading");return u(),h("div",Ee,[w("div",Ae,[a(we,{gutter:20},{default:t(()=>[a(O,{span:6},{default:t(()=>[a(V,{shadow:"never",class:"profile-card"},{default:t(()=>[w("div",Be,[a(R,{size:100,src:i.avatar},{default:t(()=>[n(m(i.nickname?.[0]),1)]),_:1},8,["src"]),w("h3",Ie,m(i.nickname),1),w("p",Ne,m(i.email),1),X(o).isMember?(u(),F(z,{key:0,type:"success"},{default:t(()=>[...e[14]||(e[14]=[n("会员",-1)])]),_:1})):(u(),F(z,{key:1,type:"info"},{default:t(()=>[...e[15]||(e[15]=[n("普通用户",-1)])]),_:1}))])]),_:1})]),_:1}),a(O,{span:18},{default:t(()=>[a(_e,{modelValue:b.value,"onUpdate:modelValue":e[13]||(e[13]=s=>b.value=s)},{default:t(()=>[a(C,{label:"个人信息",name:"info"},{default:t(()=>[a(V,{shadow:"never"},{default:t(()=>[a(q,{model:i,rules:te,ref_key:"formRef",ref:B,"label-width":"100px"},{default:t(()=>[a(f,{label:"昵称",prop:"nickname"},{default:t(()=>[a(g,{modelValue:i.nickname,"onUpdate:modelValue":e[0]||(e[0]=s=>i.nickname=s)},null,8,["modelValue"])]),_:1}),a(f,{label:"邮箱"},{default:t(()=>[a(g,{modelValue:i.email,"onUpdate:modelValue":e[1]||(e[1]=s=>i.email=s),disabled:""},null,8,["modelValue"])]),_:1}),a(f,{label:"手机号"},{default:t(()=>[a(g,{modelValue:i.phone,"onUpdate:modelValue":e[2]||(e[2]=s=>i.phone=s),disabled:""},null,8,["modelValue"])]),_:1}),a(f,null,{default:t(()=>[a(v,{type:"primary",onClick:de},{default:t(()=>[...e[16]||(e[16]=[n("保存",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(C,{label:"修改密码",name:"password"},{default:t(()=>[a(V,{shadow:"never"},{default:t(()=>[a(q,{model:c,rules:se,ref_key:"passwordFormRef",ref:I,"label-width":"100px"},{default:t(()=>[a(f,{label:"原密码",prop:"oldPassword"},{default:t(()=>[a(g,{modelValue:c.oldPassword,"onUpdate:modelValue":e[3]||(e[3]=s=>c.oldPassword=s),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(f,{label:"新密码",prop:"newPassword"},{default:t(()=>[a(g,{modelValue:c.newPassword,"onUpdate:modelValue":e[4]||(e[4]=s=>c.newPassword=s),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(f,{label:"确认密码",prop:"confirmPassword"},{default:t(()=>[a(g,{modelValue:c.confirmPassword,"onUpdate:modelValue":e[5]||(e[5]=s=>c.confirmPassword=s),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(f,null,{default:t(()=>[a(v,{type:"primary",onClick:ue},{default:t(()=>[...e[17]||(e[17]=[n("修改密码",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(C,{label:"会员信息",name:"membership"},{default:t(()=>[a(V,{shadow:"never"},{default:t(()=>[k.value?(u(),h("div",je,[a(fe,{column:2,border:""},{default:t(()=>[a(E,{label:"会员计划"},{default:t(()=>[n(m(k.value.plan),1)]),_:1}),a(E,{label:"状态"},{default:t(()=>[a(z,{type:k.value.status==="active"?"success":"info"},{default:t(()=>[n(m(k.value.status==="active"?"有效":"已过期"),1)]),_:1},8,["type"])]),_:1}),a(E,{label:"开始时间"},{default:t(()=>[n(m(new Date(k.value.started_at).toLocaleDateString()),1)]),_:1}),a(E,{label:"到期时间"},{default:t(()=>[n(m(new Date(k.value.expired_at).toLocaleDateString()),1)]),_:1})]),_:1}),w("div",Ke,[X(o).isMember?H("",!0):(u(),F(v,{key:0,type:"primary",onClick:J},{default:t(()=>[...e[18]||(e[18]=[n(" 升级会员 ",-1)])]),_:1}))])])):(u(),F(G,{key:1,description:"您还不是会员"},{default:t(()=>[a(v,{type:"primary",onClick:J},{default:t(()=>[...e[19]||(e[19]=[n("购买会员",-1)])]),_:1})]),_:1}))]),_:1})]),_:1}),a(C,{label:"收藏夹",name:"favorites"},{default:t(()=>[a(V,{shadow:"never"},{default:t(()=>[Y((u(),h("div",Te,[x.value.length?(u(!0),h(Z,{key:0},ee(x.value,s=>(u(),h("div",{key:s.favorite_id,class:"favorite-item"},[a(Q,{to:`/essay/${s.essay_id}`,class:"favorite-title"},{default:t(()=>[n(m(s.title||"无标题"),1)]),_:2},1032,["to"]),w("span",ze,m(new Date(s.essay_created_at).toLocaleString()),1),a(v,{type:"danger",text:"",loading:j.value===s.essay_id,onClick:ye=>oe(s)},{default:t(()=>[...e[20]||(e[20]=[n(" 取消收藏 ",-1)])]),_:1},8,["loading","onClick"])]))),128)):S.value?H("",!0):(u(),F(G,{key:1,description:"暂无收藏"}))])),[[W,S.value]])]),_:1})]),_:1}),a(C,{label:"古籍收藏",name:"classicFavorites"},{default:t(()=>[a(V,{shadow:"never"},{default:t(()=>[Y((u(),h("div",Ge,[U.value.length?(u(!0),h(Z,{key:0},ee(U.value,s=>(u(),h("div",{key:s.id,class:"favorite-item classic-favorite-item"},[a(Q,{to:`/classic/item/${s.id}`,class:"favorite-title classic-title"},{default:t(()=>[n(m(s.original_text?.slice(0,50))+m((s.original_text?.length??0)>50?"…":""),1)]),_:2},1032,["to"]),w("span",He,m(s.author)+" "+m(s.dynasty),1),a(v,{type:"danger",text:"",loading:K.value===s.id,onClick:ye=>re(s)},{default:t(()=>[...e[21]||(e[21]=[n(" 取消收藏 ",-1)])]),_:1},8,["loading","onClick"])]))),128)):$.value?H("",!0):(u(),F(G,{key:1,description:"暂无古籍收藏"},{default:t(()=>[a(v,{type:"primary",onClick:e[6]||(e[6]=s=>l.$router.push("/classic"))},{default:t(()=>[...e[22]||(e[22]=[n("去古籍速览",-1)])]),_:1})]),_:1}))])),[[W,$.value]])]),_:1})]),_:1}),a(C,{label:"反馈建议",name:"feedback"},{default:t(()=>[a(V,{shadow:"never"},{default:t(()=>[a(q,{model:_,"label-width":"100px"},{default:t(()=>[a(f,{label:"反馈内容"},{default:t(()=>[a(g,{modelValue:_.content,"onUpdate:modelValue":e[7]||(e[7]=s=>_.content=s),type:"textarea",rows:6,placeholder:"请输入您的反馈或建议..."},null,8,["modelValue"])]),_:1}),a(f,{label:"联系方式"},{default:t(()=>[a(g,{modelValue:_.contact,"onUpdate:modelValue":e[8]||(e[8]=s=>_.contact=s),placeholder:"邮箱或手机号（可选）"},null,8,["modelValue"])]),_:1}),a(f,null,{default:t(()=>[a(v,{type:"primary",onClick:ce},{default:t(()=>[...e[23]||(e[23]=[n("提交反馈",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(C,{label:"账号安全",name:"security"},{default:t(()=>[a(V,{shadow:"never"},{default:t(()=>[w("div",Je,[e[25]||(e[25]=w("h4",null,"注销账号",-1)),e[26]||(e[26]=w("p",{class:"security-desc"},"注销后账号及关联数据将被删除且无法恢复，请谨慎操作。",-1)),a(v,{type:"danger",plain:"",onClick:me},{default:t(()=>[...e[24]||(e[24]=[n("申请注销账号",-1)])]),_:1})])]),_:1}),a(ve,{modelValue:M.value,"onUpdate:modelValue":e[11]||(e[11]=s=>M.value=s),title:"注销账号",width:"400px","close-on-click-modal":!1,onClosed:e[12]||(e[12]=s=>P.password="")},{footer:t(()=>[a(v,{onClick:e[10]||(e[10]=s=>M.value=!1)},{default:t(()=>[...e[28]||(e[28]=[n("取消",-1)])]),_:1}),a(v,{type:"danger",loading:N.value,onClick:T},{default:t(()=>[...e[29]||(e[29]=[n(" 确认注销 ",-1)])]),_:1},8,["loading"])]),default:t(()=>[a(pe,{type:"warning",closable:!1,"show-icon":"",class:"cancel-dialog-tip"},{default:t(()=>[...e[27]||(e[27]=[n(" 注销后账号及关联数据将被删除且无法恢复，请谨慎操作。确认无误后请输入当前密码并点击「确认注销」。 ",-1)])]),_:1}),a(q,{model:P,"label-width":"80px",onSubmit:Pe(T,["prevent"])},{default:t(()=>[a(f,{label:"当前密码",required:""},{default:t(()=>[a(g,{modelValue:P.password,"onUpdate:modelValue":e[9]||(e[9]=s=>P.password=s),type:"password","show-password":"",placeholder:"请输入当前密码以确认",onKeyup:Ce(T,["enter"])},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})])])}}}),Ze=Ue(Oe,[["__scopeId","data-v-92165f85"]]);export{Ze as default};
//# sourceMappingURL=Profile-BG6hfdkc.js.map
