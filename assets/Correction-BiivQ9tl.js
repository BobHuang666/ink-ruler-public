import{d as W,m as et,l as V,c as y,e as a,r as m,w as s,j as D,a as n,f as r,N as st,g as u,O as at,D as M,o as c,E as _,_ as H,b as C,u as ot,J as j,n as nt,C as lt,P as z,A as rt,Q as it,F as G,R as F,S}from"./index-D4Y8RUFA.js";import{u as ut}from"./essay-D1j_yRNQ.js";import{e as dt,u as ct}from"./essay-BjsHiLFx.js";const ft={class:"essay-editor"},pt={key:1,class:"essay-file-list"},mt={class:"essay-file-item"},vt={class:"essay-file-name"},_t=W({__name:"EssayEditor",emits:["update:content","update:file"],setup(w,{expose:$,emit:l}){const d=l,e=et({title:"",prompt:"",content_text:""}),b=V([]);async function N(g){if(g.raw){if(g.raw.size>1024*1024){_.error("文件大小不能超过1MB"),b.value=[];return}try{const i=await dt(g.raw);e.content_text=i,d("update:content",i),d("update:file",g.raw)}catch{_.error("Word 解析失败，请确认文件格式"),b.value=[]}}}function v(){b.value=[],e.content_text="",d("update:file",null)}return $({form:e,clear:()=>{e.title="",e.prompt="",e.content_text="",b.value=[]}}),(g,i)=>{const I=m("el-input"),h=m("el-form-item"),x=m("el-option"),A=m("el-select"),L=m("el-icon"),B=m("el-upload"),R=m("el-button"),T=m("el-form");return c(),y("div",ft,[a(T,{model:e,"label-width":"80px"},{default:s(()=>[a(h,{label:"题目"},{default:s(()=>[a(I,{modelValue:e.title,"onUpdate:modelValue":i[0]||(i[0]=E=>e.title=E),placeholder:"请输入作文题目（可选）"},null,8,["modelValue"])]),_:1}),a(h,{label:"类型"},{default:s(()=>[a(A,{modelValue:e.prompt,"onUpdate:modelValue":i[1]||(i[1]=E=>e.prompt=E),filterable:"","allow-create":"",clearable:"","default-first-option":"",placeholder:"请选择或输入作文类型（可选）",style:{width:"100%"}},{default:s(()=>[a(x,{label:"议论文",value:"议论文"}),a(x,{label:"记叙文",value:"记叙文"}),a(x,{label:"应用文",value:"应用文"}),a(x,{label:"说明文",value:"说明文"}),a(x,{label:"散文",value:"散文"}),a(x,{label:"其他",value:"其他"})]),_:1},8,["modelValue"])]),_:1}),a(h,{label:"内容"},{default:s(()=>[b.value.length?(c(),y("div",pt,[n("div",mt,[a(L,null,{default:s(()=>[a(r(at))]),_:1}),n("span",vt,M(b.value[0]?.name),1),a(R,{type:"primary",link:"",onClick:v},{default:s(()=>[...i[6]||(i[6]=[u("删除",-1)])]),_:1})])])):(c(),D(B,{key:0,class:"essay-upload","file-list":b.value,"onUpdate:fileList":i[2]||(i[2]=E=>b.value=E),"auto-upload":!1,limit:1,"show-file-list":!1,"on-change":N,accept:".docx,.doc",drag:""},{tip:s(()=>[...i[4]||(i[4]=[n("div",{class:"el-upload__tip"},"支持Word文档，文件大小不超过1MB",-1)])]),default:s(()=>[a(L,{class:"el-icon--upload"},{default:s(()=>[a(r(st))]),_:1}),i[5]||(i[5]=n("div",{class:"el-upload__text"},[u("将Word文件拖到此处，或"),n("em",null,"点击上传")],-1))]),_:1},8,["file-list"])),a(I,{modelValue:e.content_text,"onUpdate:modelValue":i[3]||(i[3]=E=>e.content_text=E),type:"textarea",rows:15,placeholder:"或直接在此输入作文内容...",style:{"margin-top":"var(--spacing-md)"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])}}}),yt=H(_t,[["__scopeId","data-v-78f00568"]]),gt={class:"correction-result"},kt={class:"stats-grid"},bt={class:"stat-item"},wt={class:"stat-value"},xt={class:"stat-item"},Et={class:"stat-value"},Ct={class:"stat-item"},ht={class:"stat-value"},$t={key:0,class:"stat-item"},Vt={class:"stat-value"},Dt={class:"summary-text"},Mt=["innerHTML"],It=W({__name:"CorrectionResult",props:{correction:{}},setup(w){return($,l)=>{const d=m("el-card");return c(),y("div",gt,[a(d,{shadow:"never",class:"stats-card"},{header:s(()=>[...l[0]||(l[0]=[n("h3",{class:"header-font"},"语言学统计",-1)])]),default:s(()=>[n("div",kt,[n("div",bt,[n("div",wt,M(w.correction.stats.word_count),1),l[1]||(l[1]=n("div",{class:"stat-label"},"字数",-1))]),n("div",xt,[n("div",Et,M(w.correction.stats.paragraph_count),1),l[2]||(l[2]=n("div",{class:"stat-label"},"段落数",-1))]),n("div",Ct,[n("div",ht,M(w.correction.stats.typo_count),1),l[3]||(l[3]=n("div",{class:"stat-label"},"错别字",-1))]),w.correction.stats.sentence_count?(c(),y("div",$t,[n("div",Vt,M(w.correction.stats.sentence_count),1),l[4]||(l[4]=n("div",{class:"stat-label"},"句子数",-1))])):C("",!0)])]),_:1}),a(d,{shadow:"never",class:"summary-card"},{header:s(()=>[...l[5]||(l[5]=[n("h3",{class:"header-font"},"评语与建议",-1)])]),default:s(()=>[n("p",Dt,M(w.correction.summary),1)]),_:1}),a(d,{shadow:"never",class:"diff-card"},{header:s(()=>[...l[6]||(l[6]=[n("h3",{class:"header-font"},"修改痕迹",-1)])]),default:s(()=>[n("div",{class:"diff-content",innerHTML:w.correction.diff_html},null,8,Mt)]),_:1})])}}}),At=H(It,[["__scopeId","data-v-7faa380d"]]),Bt={class:"correction-page"},Rt={class:"container"},Ut={class:"page-header"},Ft={key:0,class:"header-actions"},St={key:0},Lt={class:"submit-section"},Nt={key:1,class:"submit-actions"},Tt={key:1},qt={key:2},zt={class:"result-header"},Wt={class:"draft-op-row"},Ht={key:0,class:"drafts-empty-state"},Qt={class:"draft-member-tip-p"},jt=W({__name:"Correction",setup(w){const $=lt(),l=rt(),d=ot(),e=ut(),b=j(()=>(d.user?.ink_drops??0)>=100),N=j(()=>(d.user?.membership?.quota_remaining??0)>0),v=V(),g=V(!1),i=V(!1);function I(o){i.value=!1,l.push(o)}const h=V(null);async function x(){const o=$.params.id;o?await e.fetchEssay(Number(o)):e.clearCurrent()}nt(async()=>{await x(),d.isAuthenticated&&await e.fetchDrafts();const o=$.query.draftId;o&&z(()=>{const t=e.drafts.find(f=>f.id===Number(o));t&&v.value&&(v.value.form.title=t.title??"",v.value.form.content_text=t.content_text??""),l.replace({path:$.path,query:{}})})}),it(()=>$.params.id,async()=>{await x()});async function A(o){if(!v.value)return;const{form:t}=v.value;if(!t.content_text.trim()){_.warning("请输入作文内容");return}if(!d.isMember&&o){if(o==="ink_drops"&&!b.value){await F.alert(S("p",null,["请 ",S("span",{class:"ink-shortage-link",onClick:()=>{F.close(),l.push("/profile?tab=membership")}},"升级会员")," 获得更多服务"]),"墨滴不足",{confirmButtonText:"确定",customClass:"app-dialog"});return}if(o==="quota"&&!N.value){const k=()=>{F.close(),l.push("/profile?tab=membership")};await F.alert(S("p",null,["请 ",S("span",{class:"ink-shortage-link",onClick:k},"兑换次卡")," 或 ",S("span",{class:"ink-shortage-link",onClick:k},"升级会员")," 以获得更多服务"]),"次数不足",{confirmButtonText:"确定",customClass:"app-dialog"});return}}const f={title:t.title,prompt:t.prompt,content_text:t.content_text,source_type:"text"};o&&(f.pay_type=o);try{await e.submitEssay(f),await d.fetchUser();const k=window.setInterval(async()=>{e.currentEssay&&(await e.fetchEssay(e.currentEssay.id),(e.currentEssay.status==="done"||e.currentEssay.status==="failed")&&window.clearInterval(k))},2e3);window.setTimeout(()=>window.clearInterval(k),1e4)}catch(k){const U=k.message||"提交失败";_.error(U),(U.includes("不足")||U.includes("兑换"))&&z(()=>{l.push("/profile?tab=membership")})}}function L(){e.currentEssay&&(h.value={title:e.currentEssay.title??"",prompt:e.currentEssay.prompt??"",content_text:e.currentEssay.content_text??""}),e.clearCurrent(),l.push("/essay/correction").then(()=>{z(()=>{if(v.value&&h.value){const o=h.value;v.value.form.title=o.title,v.value.form.prompt=o.prompt,v.value.form.content_text=o.content_text,h.value=null}})})}const B=V(!1),R=V(!1);async function T(){if(e.currentEssay){B.value=!0;try{await e.favoriteEssay(e.currentEssay.id),e.setCurrentEssayFavorited(!0),_.success("收藏成功"),e.fetchEssay(e.currentEssay.id).catch(()=>{})}catch(o){_.error(o.message||"收藏失败")}finally{B.value=!1}}}async function E(){if(e.currentEssay){R.value=!0;try{await ct(e.currentEssay.id),e.setCurrentEssayFavorited(!1),_.success("已取消收藏"),e.fetchEssay(e.currentEssay.id).catch(()=>{})}catch(o){_.error(o.message||"取消收藏失败")}finally{R.value=!1}}}async function J(){if(!d.isAuthenticated){_.warning("请先登录"),l.push("/login");return}if(!d.isMember){i.value=!0;return}if(!v.value)return;const{form:o}=v.value;if(!o.content_text.trim()){_.warning("请输入作文内容");return}try{await e.createDraft({title:o.title,content_text:o.content_text}),_.success("草稿已保存")}catch(t){_.error(t.message||"保存失败")}}function O(o){v.value&&(v.value.form.title=o.title||"",v.value.form.content_text=o.content_text),g.value=!1}async function P(o){try{await F.confirm("确定要删除这个草稿吗？","提示",{type:"warning"}),await e.deleteDraft(o),_.success("删除成功")}catch(t){t!=="cancel"&&_.error(t.message||"删除失败")}}return(o,t)=>{const f=m("el-button"),k=m("el-link"),U=m("el-alert"),K=m("el-result"),X=m("el-card"),q=m("el-table-column"),Y=m("el-table"),Z=m("el-empty"),Q=m("el-dialog");return c(),y("div",Bt,[n("div",Rt,[a(X,{shadow:"never"},{header:s(()=>[n("div",Ut,[t[13]||(t[13]=n("h2",{class:"header-font"},"作文批改",-1)),!r(e).currentEssay||r(e).currentEssay.status!=="done"&&r(e).currentEssay.status!=="processing"?(c(),y("div",Ft,[r(d).isMember?(c(),D(f,{key:0,onClick:t[0]||(t[0]=p=>g.value=!0)},{default:s(()=>[...t[12]||(t[12]=[u(" 草稿列表 ",-1)])]),_:1})):C("",!0)])):C("",!0)])]),default:s(()=>[!r(e).currentEssay||r(e).currentEssay.status!=="done"&&r(e).currentEssay.status!=="processing"?(c(),y("div",St,[a(yt,{ref_key:"editorRef",ref:v},null,512),n("div",Lt,[r(d).isAuthenticated?C("",!0):(c(),D(U,{key:0,class:"tip-alert",title:"提示",type:"warning",closable:!1,"show-icon":""},{default:s(()=>[t[15]||(t[15]=u(" 未登录用户无法批改作文，",-1)),a(k,{type:"primary",onClick:t[1]||(t[1]=p=>o.$router.push("/login"))},{default:s(()=>[...t[14]||(t[14]=[u(" 立即登录 ",-1)])]),_:1})]),_:1})),r(d).isAuthenticated?(c(),y("div",Nt,[r(d).isMember?(c(),D(f,{key:0,type:"primary",size:"large",loading:r(e).loading,onClick:t[2]||(t[2]=p=>A())},{default:s(()=>[...t[16]||(t[16]=[u(" 提交批改 ",-1)])]),_:1},8,["loading"])):(c(),y(G,{key:1},[a(f,{type:"primary",size:"large",loading:r(e).loading,onClick:t[3]||(t[3]=p=>A("ink_drops"))},{default:s(()=>[...t[17]||(t[17]=[u(" 使用 100 墨滴批改 ",-1)])]),_:1},8,["loading"]),a(f,{type:"primary",size:"large",plain:"",loading:r(e).loading,onClick:t[4]||(t[4]=p=>A("quota"))},{default:s(()=>[...t[18]||(t[18]=[u(" 使用 1 次次卡批改 ",-1)])]),_:1},8,["loading"])],64)),r(d).isAuthenticated?(c(),D(f,{key:2,size:"large",onClick:J},{default:s(()=>[...t[19]||(t[19]=[u(" 保存草稿 ",-1)])]),_:1})):C("",!0)])):C("",!0)])])):r(e).currentEssay&&r(e).currentEssay.status==="processing"?(c(),y("div",Tt,[a(K,{icon:"loading",title:"正在批改中..."},{"sub-title":s(()=>[...t[20]||(t[20]=[n("p",null,"AI正在分析您的作文，请稍候",-1)])]),_:1})])):r(e).currentCorrection?(c(),y("div",qt,[n("div",zt,[a(f,{onClick:L},{default:s(()=>[...t[21]||(t[21]=[u("重新批改",-1)])]),_:1}),r(d).isAuthenticated?(c(),y(G,{key:0},[r(e).currentEssay?.is_favorited?(c(),D(f,{key:1,loading:R.value,onClick:E},{default:s(()=>[...t[23]||(t[23]=[u(" 取消收藏 ",-1)])]),_:1},8,["loading"])):(c(),D(f,{key:0,type:"primary",loading:B.value,onClick:T},{default:s(()=>[...t[22]||(t[22]=[u(" 收藏 ",-1)])]),_:1},8,["loading"]))],64)):C("",!0)]),a(At,{correction:r(e).currentCorrection},null,8,["correction"])])):C("",!0)]),_:1})]),a(Q,{modelValue:g.value,"onUpdate:modelValue":t[6]||(t[6]=p=>g.value=p),title:"草稿列表",width:"600px"},{default:s(()=>[a(Y,{data:r(e).drafts,class:"drafts-table",style:{width:"100%"}},{default:s(()=>[a(q,{prop:"title",label:"标题"}),a(q,{prop:"updated_at",label:"更新时间",width:"180"},{default:s(({row:p})=>[u(M(new Date(p.updated_at).toLocaleString()),1)]),_:1}),a(q,{label:"操作",width:"140",align:"right"},{default:s(({row:p})=>[n("div",Wt,[a(f,{type:"primary",text:"",onClick:tt=>O(p)},{default:s(()=>[...t[24]||(t[24]=[u("加载",-1)])]),_:1},8,["onClick"]),a(f,{type:"danger",text:"",onClick:tt=>P(p.id)},{default:s(()=>[...t[25]||(t[25]=[u("删除",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"]),r(e).drafts.length===0?(c(),y("div",Ht,[a(Z,{description:"暂无草稿"},{default:s(()=>[a(f,{type:"primary",onClick:t[5]||(t[5]=p=>g.value=!1)},{default:s(()=>[...t[26]||(t[26]=[u("开始编辑",-1)])]),_:1})]),_:1})])):C("",!0)]),_:1},8,["modelValue"]),a(Q,{modelValue:i.value,"onUpdate:modelValue":t[11]||(t[11]=p=>i.value=p),title:"开通会员",width:"400px",class:"app-dialog","align-center":""},{footer:s(()=>[a(f,{onClick:t[9]||(t[9]=p=>i.value=!1)},{default:s(()=>[...t[31]||(t[31]=[u("关闭",-1)])]),_:1}),a(f,{type:"primary",onClick:t[10]||(t[10]=p=>I("/profile?tab=membership"))},{default:s(()=>[...t[32]||(t[32]=[u(" 去开通 ",-1)])]),_:1})]),default:s(()=>[n("p",Qt,[a(k,{type:"primary",onClick:t[7]||(t[7]=p=>I("/profile?tab=membership"))},{default:s(()=>[...t[27]||(t[27]=[u(" 开通会员 ",-1)])]),_:1}),t[29]||(t[29]=u(" 可保存草稿，可前往 ",-1)),a(k,{type:"primary",onClick:t[8]||(t[8]=p=>I("/essay/history"))},{default:s(()=>[...t[28]||(t[28]=[u(" 历史记录 ",-1)])]),_:1}),t[30]||(t[30]=u(" 查看草稿。 ",-1))])]),_:1},8,["modelValue"])])}}}),Pt=H(jt,[["__scopeId","data-v-fd42459a"]]);export{Pt as default};
//# sourceMappingURL=Correction-BiivQ9tl.js.map
