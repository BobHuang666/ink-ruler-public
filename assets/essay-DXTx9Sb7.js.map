{"version":3,"file":"essay-DXTx9Sb7.js","sources":["../../src/stores/essay.ts"],"sourcesContent":["import { defineStore } from 'pinia'\nimport { ref } from 'vue'\nimport type { Essay, EssayDetail, Correction, Draft } from '@/types/essay'\nimport * as essayApi from '@/api/essay'\n\nexport const useEssayStore = defineStore('essay', () => {\n  const currentEssay = ref<EssayDetail | null>(null)\n  const currentCorrection = ref<Correction | null>(null)\n  const history = ref<Essay[]>([])\n  const drafts = ref<Draft[]>([])\n  const loading = ref(false)\n  /** 重新批改时暂存原文（因 route.fullPath 导致组件重建，需存 store） */\n  const pendingResetContent = ref<{ title: string; prompt: string; content_text: string } | null>(\n    null\n  )\n\n  async function submitEssay(data: {\n    title?: string\n    prompt?: string\n    content_text?: string\n    file?: File\n    source_type: 'text' | 'docx' | 'image' | 'pdf'\n    pay_type?: 'ink_drops' | 'quota'\n  }) {\n    loading.value = true\n    try {\n      const response = await essayApi.submitEssay(data)\n      const essay = await essayApi.getEssay(response.essay_id)\n      currentEssay.value = essay\n      return essay\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function fetchEssay(id: number) {\n    loading.value = true\n    try {\n      const essay = await essayApi.getEssay(id)\n      currentEssay.value = essay\n      if (essay.status === 'done') {\n        const correction = await essayApi.getCorrection(id)\n        currentCorrection.value = correction\n      } else if (essay.correction) {\n        currentCorrection.value = essay.correction\n      }\n      return essay\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function fetchCorrection(id: number) {\n    loading.value = true\n    try {\n      const correction = await essayApi.getCorrection(id)\n      currentCorrection.value = correction\n      return correction\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function fetchHistory(params?: { page?: number; size?: number; status?: string }) {\n    loading.value = true\n    try {\n      const response = await essayApi.getEssayHistory(params || {})\n      history.value = response.items\n      return response\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function deleteEssay(id: number) {\n    await essayApi.deleteEssay(id)\n    await fetchHistory()\n  }\n\n  async function favoriteEssay(id: number) {\n    await essayApi.favoriteEssay(id)\n  }\n\n  /** 乐观更新：当前作文收藏状态（批改页用） */\n  function setCurrentEssayFavorited(value: boolean) {\n    if (currentEssay.value) {\n      currentEssay.value = { ...currentEssay.value, is_favorited: value }\n    }\n  }\n\n  /** 乐观更新：历史列表中某条的收藏状态（历史页用） */\n  function setHistoryItemFavorited(essayId: number, value: boolean) {\n    history.value = history.value.map((e) => (e.id === essayId ? { ...e, is_favorited: value } : e))\n  }\n\n  async function fetchDrafts() {\n    loading.value = true\n    try {\n      const draftList = await essayApi.getDrafts()\n      drafts.value = draftList\n      return draftList\n    } catch {\n      // 非会员等情况下后端返回 400，不抛出不打断页面\n      drafts.value = []\n      return []\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function createDraft(data: { title?: string; content_text: string }) {\n    const draft = await essayApi.createDraft(data)\n    await fetchDrafts()\n    return draft\n  }\n\n  async function deleteDraft(id: number) {\n    await essayApi.deleteDraft(id)\n    await fetchDrafts()\n  }\n\n  function clearCurrent() {\n    currentEssay.value = null\n    currentCorrection.value = null\n  }\n\n  function setPendingResetContent(data: { title: string; prompt: string; content_text: string }) {\n    pendingResetContent.value = data\n  }\n\n  function takePendingResetContent() {\n    const v = pendingResetContent.value\n    pendingResetContent.value = null\n    return v\n  }\n\n  return {\n    currentEssay,\n    currentCorrection,\n    history,\n    drafts,\n    loading,\n    submitEssay,\n    fetchEssay,\n    fetchCorrection,\n    fetchHistory,\n    deleteEssay,\n    favoriteEssay,\n    setCurrentEssayFavorited,\n    setHistoryItemFavorited,\n    fetchDrafts,\n    createDraft,\n    deleteDraft,\n    clearCurrent,\n    setPendingResetContent,\n    takePendingResetContent,\n  }\n})\n"],"names":["useEssayStore","defineStore","currentEssay","ref","currentCorrection","history","drafts","loading","pendingResetContent","submitEssay","data","response","essayApi.submitEssay","essay","essayApi.getEssay","fetchEssay","id","correction","essayApi.getCorrection","fetchCorrection","fetchHistory","params","essayApi.getEssayHistory","deleteEssay","essayApi.deleteEssay","favoriteEssay","essayApi.favoriteEssay","setCurrentEssayFavorited","value","setHistoryItemFavorited","essayId","e","fetchDrafts","draftList","essayApi.getDrafts","createDraft","draft","essayApi.createDraft","deleteDraft","essayApi.deleteDraft","clearCurrent","setPendingResetContent","takePendingResetContent","v"],"mappings":"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"}