import{V as C,d as Ve,l as d,n as Ce,K as Ue,E as v,c as ne,a as o,e,w as a,r as u,f as $,a6 as De,t as ze,a7 as Le,a8 as Se,s as k,v as E,D as f,g as m,y as Te,a9 as $e,j as I,S as Ee,b as de,o as z,_ as Fe}from"./index-Ce45WVGD.js";async function Ie(){return(await C.get("/admin/metrics")).data}async function Re(i){const n=i.page??1,_=i.size??10,c=await C.get("/admin/users",{params:{q:i.q,role:i.role,status:i.status,page:n,size:_}});return{items:(c.data.list??[]).map(p=>({id:p.id,email:p.email,phone:p.phone,nickname:p.nickname??"",avatar:p.avatar,role:p.role,status:p.status,created_at:p.created_at??"",updated_at:p.updated_at??""})),total:c.data.total??0,page:n,size:_}}async function ue(i,n){await C.patch(`/admin/users/${i}`,n)}async function Me(i){const n=i?.page??1,_=i?.size??20,c=await C.get("/admin/logs",{params:{page:n,size:_}});return{items:c.data.list??[],total:c.data.total??0,page:n,size:_}}async function qe(i){const n=i?.page??1,_=i?.size??10,c=await C.get("/admin/flags",{params:{page:n,size:_}});return{items:c.data.list??[],total:c.data.total??0,page:n,size:_}}async function Be(i,n){await C.patch(`/admin/flags/${i}`,{status:n})}async function je(i,n){return(await C.post("/admin/redemption-codes",{kind:i,count:n})).data}const Ne={class:"admin-page"},Pe={class:"admin-container"},Ke={class:"dashboard-content"},Ge={class:"metric-item"},Oe={class:"metric-value"},Ae={class:"metric-item"},Qe={class:"metric-value"},We={class:"metric-item"},He={class:"metric-value"},Je={class:"metric-item"},Xe={class:"metric-value"},Ye={class:"users-content"},Ze={class:"search-bar"},et={class:"table-scroll-wrap"},tt={class:"content-content"},at={class:"table-scroll-wrap"},lt={class:"redemption-codes-content"},st={key:0,class:"redeem-result"},ot={class:"redeem-result-actions"},nt={class:"logs-content"},dt={class:"table-scroll-wrap"},ut=Ve({__name:"Dashboard",setup(i){const n=d("dashboard"),_=d(3),c=d({user_count:0,active_user_count:0,essay_count:0,token_usage:{total:0,today:0,this_month:0}}),R=d([]),p=d(!1),M=d(""),q=d(""),B=d(""),j=d(1),N=d(10),X=d(0),Y=d([]),P=d(!1),Z=d([]),K=d(!1),L=d(!1),x=d({role:"",status:""}),G=d(null),h=d({kind:"quota_10",count:5}),O=d(!1),ee=d([]),V=d("");function A(){_.value=window.innerWidth>=768?3:1}Ce(async()=>{A(),window.addEventListener("resize",A),await ie(),await U(),await te(),await re()}),Ue(()=>{window.removeEventListener("resize",A)});async function ie(){try{c.value=await Ie()}catch(s){v.error(s.message||"获取数据失败")}}async function U(){p.value=!0;try{const s=await Re({q:M.value,role:q.value,status:B.value,page:j.value,size:N.value});R.value=s.items,X.value=s.total}catch(s){v.error(s.message||"获取用户列表失败")}finally{p.value=!1}}async function te(){P.value=!0;try{const s=await qe({});Y.value=s.items}catch(s){v.error(s.message||"获取内容标记失败")}finally{P.value=!1}}async function re(){K.value=!0;try{const s=await Me({});Z.value=s.items}catch(s){v.error(s.message||"获取日志失败")}finally{K.value=!1}}function ce(s){s!==n.value&&(n.value=s)}function me(s){G.value=s.id,x.value={role:s.role,status:s.status},L.value=!0}async function ve(){if(G.value)try{await ue(G.value,x.value),v.success("更新成功"),L.value=!1,await U()}catch(s){v.error(s.message||"更新失败")}}async function pe(s){try{await ue(s.id,{status:s.status==="active"?"disabled":"active"}),v.success("操作成功"),await U()}catch(t){v.error(t.message||"操作失败")}}async function _e(s){try{await Be(s.id,"resolved"),v.success("标记已处理"),await te()}catch(t){v.error(t.message||"操作失败")}}async function fe(){O.value=!0;try{const s=await je(h.value.kind,h.value.count);ee.value=s.codes,V.value=s.codes.join(`
`),v.success(`已生成 ${s.codes.length} 个兑换码`)}catch(s){v.error(s.message||"生成失败")}finally{O.value=!1}}function ge(){V.value&&navigator.clipboard.writeText(V.value).then(()=>v.success("已复制到剪贴板"),()=>v.error("复制失败"))}function be(){if(!V.value)return;const s=new Blob([V.value],{type:"text/plain;charset=utf-8"}),t=URL.createObjectURL(s),b=document.createElement("a");b.href=t,b.download=`兑换码_${h.value.kind}_${Date.now()}.txt`,b.click(),URL.revokeObjectURL(t),v.success("已下载")}return(s,t)=>{const b=u("el-icon"),F=u("el-menu-item"),we=u("el-menu"),D=u("el-col"),w=u("el-card"),ae=u("el-row"),Q=u("el-descriptions-item"),ye=u("el-descriptions"),le=u("el-input"),g=u("el-option"),S=u("el-select"),y=u("el-button"),r=u("el-table-column"),W=u("el-tag"),H=u("el-table"),he=u("el-pagination"),T=u("el-form-item"),ke=u("el-input-number"),se=u("el-form"),xe=u("el-dialog"),J=Ee("loading");return z(),ne("div",Ne,[o("div",Pe,[e(ae,{gutter:20},{default:a(()=>[e(D,{xs:24,sm:24,md:4,lg:4},{default:a(()=>[e(we,{"default-active":n.value,class:"admin-menu",onSelect:ce},{default:a(()=>[e(F,{index:"dashboard"},{default:a(()=>[e(b,null,{default:a(()=>[e($(De))]),_:1}),t[12]||(t[12]=o("span",null,"数据看板",-1))]),_:1}),e(F,{index:"users"},{default:a(()=>[e(b,null,{default:a(()=>[e($(ze))]),_:1}),t[13]||(t[13]=o("span",null,"用户管理",-1))]),_:1}),e(F,{index:"redemption-codes"},{default:a(()=>[e(b,null,{default:a(()=>[e($(Le))]),_:1}),t[14]||(t[14]=o("span",null,"兑换码",-1))]),_:1}),e(F,{index:"logs"},{default:a(()=>[e(b,null,{default:a(()=>[e($(Se))]),_:1}),t[15]||(t[15]=o("span",null,"操作日志",-1))]),_:1})]),_:1},8,["default-active"])]),_:1}),e(D,{xs:24,sm:24,md:20,lg:20},{default:a(()=>[k(o("div",Ke,[t[21]||(t[21]=o("h2",{class:"header-font"},"数据看板",-1)),e(ae,{gutter:20,class:"metrics-row"},{default:a(()=>[e(D,{xs:12,sm:12,md:6,lg:6},{default:a(()=>[e(w,{shadow:"hover"},{default:a(()=>[o("div",Ge,[o("div",Oe,f(c.value.user_count),1),t[16]||(t[16]=o("div",{class:"metric-label"},"总用户数",-1))])]),_:1})]),_:1}),e(D,{xs:12,sm:12,md:6,lg:6},{default:a(()=>[e(w,{shadow:"hover"},{default:a(()=>[o("div",Ae,[o("div",Qe,f(c.value.active_user_count),1),t[17]||(t[17]=o("div",{class:"metric-label"},"活跃用户",-1))])]),_:1})]),_:1}),e(D,{xs:12,sm:12,md:6,lg:6},{default:a(()=>[e(w,{shadow:"hover"},{default:a(()=>[o("div",We,[o("div",He,f(c.value.essay_count),1),t[18]||(t[18]=o("div",{class:"metric-label"},"作文提交量",-1))])]),_:1})]),_:1}),e(D,{xs:12,sm:12,md:6,lg:6},{default:a(()=>[e(w,{shadow:"hover"},{default:a(()=>[o("div",Je,[o("div",Xe,f(c.value.token_usage.total),1),t[19]||(t[19]=o("div",{class:"metric-label"},"Token使用总量",-1))])]),_:1})]),_:1})]),_:1}),e(w,{shadow:"never",class:"token-card"},{default:a(()=>[t[20]||(t[20]=o("h3",{class:"header-font"},"Token使用情况",-1)),e(ye,{column:_.value,border:""},{default:a(()=>[e(Q,{label:"今日使用"},{default:a(()=>[m(f(c.value.token_usage.today),1)]),_:1}),e(Q,{label:"本月使用"},{default:a(()=>[m(f(c.value.token_usage.this_month),1)]),_:1}),e(Q,{label:"总使用量"},{default:a(()=>[m(f(c.value.token_usage.total),1)]),_:1})]),_:1},8,["column"])]),_:1}),t[22]||(t[22]=o("p",{class:"dashboard-note"},"活跃用户：统计最近 7 天内有过登录的用户。",-1))],512),[[E,n.value==="dashboard"]]),k(o("div",Ye,[t[25]||(t[25]=o("h2",{class:"header-font"},"用户管理",-1)),e(w,{shadow:"never"},{default:a(()=>[o("div",Ze,[e(le,{modelValue:M.value,"onUpdate:modelValue":t[0]||(t[0]=l=>M.value=l),placeholder:"搜索用户...",class:"search-input",clearable:"",onKeyup:Te(U,["enter"])},{prefix:a(()=>[e(b,null,{default:a(()=>[e($($e))]),_:1})]),_:1},8,["modelValue"]),e(S,{modelValue:q.value,"onUpdate:modelValue":t[1]||(t[1]=l=>q.value=l),placeholder:"角色",class:"search-select",clearable:""},{default:a(()=>[e(g,{label:"学生",value:"student"}),e(g,{label:"管理员",value:"admin"})]),_:1},8,["modelValue"]),e(S,{modelValue:B.value,"onUpdate:modelValue":t[2]||(t[2]=l=>B.value=l),placeholder:"状态",class:"search-select",clearable:""},{default:a(()=>[e(g,{label:"正常",value:"active"}),e(g,{label:"禁用",value:"disabled"})]),_:1},8,["modelValue"]),e(y,{type:"primary",onClick:U},{default:a(()=>[...t[23]||(t[23]=[m("搜索",-1)])]),_:1})]),o("div",et,[k((z(),I(H,{data:R.value,style:{width:"100%","margin-top":"20px"}},{default:a(()=>[e(r,{prop:"id",label:"ID",width:"80"}),e(r,{prop:"nickname",label:"昵称"}),e(r,{prop:"email",label:"邮箱"}),e(r,{prop:"role",label:"角色",width:"100"},{default:a(({row:l})=>[e(W,{type:l.role==="admin"?"danger":"primary"},{default:a(()=>[m(f(l.role==="admin"?"管理员":"学生"),1)]),_:2},1032,["type"])]),_:1}),e(r,{prop:"status",label:"状态",width:"100"},{default:a(({row:l})=>[e(W,{type:l.status==="active"?"success":"info"},{default:a(()=>[m(f(l.status==="active"?"正常":"禁用"),1)]),_:2},1032,["type"])]),_:1}),e(r,{label:"操作",width:"200"},{default:a(({row:l})=>[e(y,{type:"primary",text:"",onClick:oe=>me(l)},{default:a(()=>[...t[24]||(t[24]=[m("编辑",-1)])]),_:1},8,["onClick"]),e(y,{type:l.status==="active"?"warning":"success",text:"",onClick:oe=>pe(l)},{default:a(()=>[m(f(l.status==="active"?"禁用":"启用"),1)]),_:2},1032,["type","onClick"])]),_:1})]),_:1},8,["data"])),[[J,p.value]])]),e(he,{"current-page":j.value,"onUpdate:currentPage":t[3]||(t[3]=l=>j.value=l),"page-size":N.value,"onUpdate:pageSize":t[4]||(t[4]=l=>N.value=l),total:X.value,layout:"total, prev, pager, next",style:{"margin-top":"20px"},onCurrentChange:U},null,8,["current-page","page-size","total"])]),_:1})],512),[[E,n.value==="users"]]),k(o("div",tt,[t[27]||(t[27]=o("h2",{class:"header-font"},"内容管理",-1)),e(w,{shadow:"never"},{default:a(()=>[o("div",at,[k((z(),I(H,{data:Y.value,class:"admin-table",style:{width:"100%"}},{default:a(()=>[e(r,{prop:"id",label:"ID",width:"80"}),e(r,{prop:"target_type",label:"类型",width:"120"}),e(r,{prop:"target_id",label:"目标ID",width:"100"}),e(r,{prop:"reason",label:"原因"}),e(r,{prop:"status",label:"状态",width:"100"},{default:a(({row:l})=>[e(W,{type:l.status==="resolved"?"success":"warning"},{default:a(()=>[m(f(l.status==="resolved"?"已处理":"待处理"),1)]),_:2},1032,["type"])]),_:1}),e(r,{label:"操作",width:"150"},{default:a(({row:l})=>[l.status==="open"?(z(),I(y,{key:0,type:"success",text:"",onClick:oe=>_e(l)},{default:a(()=>[...t[26]||(t[26]=[m(" 标记已处理 ",-1)])]),_:1},8,["onClick"])):de("",!0)]),_:1})]),_:1},8,["data"])),[[J,P.value]])])]),_:1})],512),[[E,n.value==="content"]]),k(o("div",lt,[t[31]||(t[31]=o("h2",{class:"header-font"},"生成兑换码",-1)),e(w,{shadow:"never"},{default:a(()=>[e(se,{model:h.value,"label-width":"80px",class:"redeem-form"},{default:a(()=>[e(T,{label:"类型"},{default:a(()=>[e(S,{modelValue:h.value.kind,"onUpdate:modelValue":t[5]||(t[5]=l=>h.value.kind=l),placeholder:"选择类型"},{default:a(()=>[e(g,{label:"10次卡",value:"quota_10"}),e(g,{label:"月卡",value:"month"}),e(g,{label:"年卡",value:"year"})]),_:1},8,["modelValue"])]),_:1}),e(T,{label:"数量"},{default:a(()=>[e(ke,{modelValue:h.value.count,"onUpdate:modelValue":t[6]||(t[6]=l=>h.value.count=l),min:1,max:100},null,8,["modelValue"])]),_:1}),e(T,null,{default:a(()=>[e(y,{type:"primary",loading:O.value,onClick:fe},{default:a(()=>[...t[28]||(t[28]=[m(" 生成 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),ee.value.length?(z(),ne("div",st,[o("div",ot,[e(y,{size:"small",onClick:ge},{default:a(()=>[...t[29]||(t[29]=[m("复制全部",-1)])]),_:1}),e(y,{size:"small",onClick:be},{default:a(()=>[...t[30]||(t[30]=[m("下载 txt",-1)])]),_:1})]),e(le,{modelValue:V.value,"onUpdate:modelValue":t[7]||(t[7]=l=>V.value=l),type:"textarea",rows:10,readonly:"",class:"redeem-codes-textarea"},null,8,["modelValue"])])):de("",!0)]),_:1})],512),[[E,n.value==="redemption-codes"]]),k(o("div",nt,[t[32]||(t[32]=o("h2",{class:"header-font"},"操作日志",-1)),e(w,{shadow:"never"},{default:a(()=>[o("div",dt,[k((z(),I(H,{data:Z.value,class:"admin-table",style:{width:"100%"}},{default:a(()=>[e(r,{prop:"id",label:"ID",width:"80"}),e(r,{prop:"action",label:"操作"}),e(r,{prop:"target_type",label:"目标类型",width:"120"}),e(r,{prop:"target_id",label:"目标ID",width:"100"}),e(r,{prop:"ip",label:"IP",width:"150"}),e(r,{prop:"created_at",label:"时间",width:"180"},{default:a(({row:l})=>[m(f(new Date(l.created_at).toLocaleString()),1)]),_:1})]),_:1},8,["data"])),[[J,K.value]])])]),_:1})],512),[[E,n.value==="logs"]])]),_:1})]),_:1})]),e(xe,{modelValue:L.value,"onUpdate:modelValue":t[11]||(t[11]=l=>L.value=l),title:"编辑用户",width:"500px",class:"edit-user-dialog"},{footer:a(()=>[e(y,{onClick:t[10]||(t[10]=l=>L.value=!1)},{default:a(()=>[...t[33]||(t[33]=[m("取消",-1)])]),_:1}),e(y,{type:"primary",onClick:ve},{default:a(()=>[...t[34]||(t[34]=[m("保存",-1)])]),_:1})]),default:a(()=>[e(se,{model:x.value,"label-width":"100px"},{default:a(()=>[e(T,{label:"角色"},{default:a(()=>[e(S,{modelValue:x.value.role,"onUpdate:modelValue":t[8]||(t[8]=l=>x.value.role=l)},{default:a(()=>[e(g,{label:"学生",value:"student"}),e(g,{label:"管理员",value:"admin"})]),_:1},8,["modelValue"])]),_:1}),e(T,{label:"状态"},{default:a(()=>[e(S,{modelValue:x.value.status,"onUpdate:modelValue":t[9]||(t[9]=l=>x.value.status=l)},{default:a(()=>[e(g,{label:"正常",value:"active"}),e(g,{label:"禁用",value:"disabled"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),rt=Fe(ut,[["__scopeId","data-v-950c1ff4"]]);export{rt as default};
//# sourceMappingURL=Dashboard-DaWz70xH.js.map
