import{d as S,m as G,l as M,c as v,e as a,r as p,w as s,j as C,a as n,f as r,J as O,g as u,K as P,D as $,o as c,E as m,_ as N,b as E,u as Q,n as X,C as Y,L as U,A as Z,M as tt,F as et,N as st}from"./index-DE8jxKp-.js";import{u as at}from"./essay-D4g_b-yw.js";import{e as ot,u as nt}from"./essay-Bk8B8jm0.js";const lt={class:"essay-editor"},rt={key:1,class:"essay-file-list"},it={class:"essay-file-item"},dt={class:"essay-file-name"},ut=S({__name:"EssayEditor",emits:["update:content","update:file"],setup(g,{expose:x,emit:i}){const f=i,e=G({title:"",prompt:"",content_text:""}),l=M([]);async function b(k){if(k.raw){if(k.raw.size>1024*1024){m.error("文件大小不能超过1MB"),l.value=[];return}try{const d=await ot(k.raw);e.content_text=d,f("update:content",d),f("update:file",k.raw)}catch{m.error("Word 解析失败，请确认文件格式"),l.value=[]}}}function V(){l.value=[],e.content_text="",f("update:file",null)}return x({form:e,clear:()=>{e.title="",e.prompt="",e.content_text="",l.value=[]}}),(k,d)=>{const D=p("el-input"),h=p("el-form-item"),I=p("el-icon"),F=p("el-upload"),R=p("el-button"),A=p("el-form");return c(),v("div",lt,[a(A,{model:e,"label-width":"80px"},{default:s(()=>[a(h,{label:"题目"},{default:s(()=>[a(D,{modelValue:e.title,"onUpdate:modelValue":d[0]||(d[0]=w=>e.title=w),placeholder:"请输入作文题目（可选）"},null,8,["modelValue"])]),_:1}),a(h,{label:"类型"},{default:s(()=>[a(D,{modelValue:e.prompt,"onUpdate:modelValue":d[1]||(d[1]=w=>e.prompt=w),placeholder:"请输入作文类型或提示（可选）"},null,8,["modelValue"])]),_:1}),a(h,{label:"内容"},{default:s(()=>[l.value.length?(c(),v("div",rt,[n("div",it,[a(I,null,{default:s(()=>[a(r(P))]),_:1}),n("span",dt,$(l.value[0]?.name),1),a(R,{type:"primary",link:"",onClick:V},{default:s(()=>[...d[6]||(d[6]=[u("删除",-1)])]),_:1})])])):(c(),C(F,{key:0,class:"essay-upload","file-list":l.value,"onUpdate:fileList":d[2]||(d[2]=w=>l.value=w),"auto-upload":!1,limit:1,"show-file-list":!1,"on-change":b,accept:".docx,.doc",drag:""},{tip:s(()=>[...d[4]||(d[4]=[n("div",{class:"el-upload__tip"},"支持Word文档，文件大小不超过1MB",-1)])]),default:s(()=>[a(I,{class:"el-icon--upload"},{default:s(()=>[a(r(O))]),_:1}),d[5]||(d[5]=n("div",{class:"el-upload__text"},[u("将Word文件拖到此处，或"),n("em",null,"点击上传")],-1))]),_:1},8,["file-list"])),a(D,{modelValue:e.content_text,"onUpdate:modelValue":d[3]||(d[3]=w=>e.content_text=w),type:"textarea",rows:15,placeholder:"或直接在此输入作文内容...",style:{"margin-top":"var(--spacing-md)"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])}}}),ct=N(ut,[["__scopeId","data-v-ff324c37"]]),ft={class:"correction-result"},pt={class:"stats-grid"},mt={class:"stat-item"},_t={class:"stat-value"},yt={class:"stat-item"},vt={class:"stat-value"},gt={class:"stat-item"},wt={class:"stat-value"},Et={key:0,class:"stat-item"},kt={class:"stat-value"},xt={class:"summary-text"},bt=["innerHTML"],ht=S({__name:"CorrectionResult",props:{correction:{}},setup(g){return(x,i)=>{const f=p("el-card");return c(),v("div",ft,[a(f,{shadow:"never",class:"stats-card"},{header:s(()=>[...i[0]||(i[0]=[n("h3",{class:"header-font"},"语言学统计",-1)])]),default:s(()=>[n("div",pt,[n("div",mt,[n("div",_t,$(g.correction.stats.word_count),1),i[1]||(i[1]=n("div",{class:"stat-label"},"字数",-1))]),n("div",yt,[n("div",vt,$(g.correction.stats.paragraph_count),1),i[2]||(i[2]=n("div",{class:"stat-label"},"段落数",-1))]),n("div",gt,[n("div",wt,$(g.correction.stats.typo_count),1),i[3]||(i[3]=n("div",{class:"stat-label"},"错别字",-1))]),g.correction.stats.sentence_count?(c(),v("div",Et,[n("div",kt,$(g.correction.stats.sentence_count),1),i[4]||(i[4]=n("div",{class:"stat-label"},"句子数",-1))])):E("",!0)])]),_:1}),a(f,{shadow:"never",class:"summary-card"},{header:s(()=>[...i[5]||(i[5]=[n("h3",{class:"header-font"},"评语与建议",-1)])]),default:s(()=>[n("p",xt,$(g.correction.summary),1)]),_:1}),a(f,{shadow:"never",class:"diff-card"},{header:s(()=>[...i[6]||(i[6]=[n("h3",{class:"header-font"},"修改痕迹",-1)])]),default:s(()=>[n("div",{class:"diff-content",innerHTML:g.correction.diff_html},null,8,bt)]),_:1})])}}}),Ct=N(ht,[["__scopeId","data-v-7faa380d"]]),$t={class:"correction-page"},Vt={class:"container"},It={class:"page-header"},Mt={key:0,class:"header-actions"},Dt={key:0},Ft={class:"submit-section"},Rt={class:"submit-actions"},At={key:1},Bt={key:2},Lt={class:"result-header"},St={class:"draft-op-row"},Nt={key:0,class:"drafts-empty-state"},Tt=S({__name:"Correction",setup(g){const x=Y(),i=Z(),f=Q(),e=at(),l=M(),b=M(!1),V=M(null);async function k(){const o=x.params.id;o?await e.fetchEssay(Number(o)):e.clearCurrent()}X(async()=>{await k(),f.isAuthenticated&&await e.fetchDrafts();const o=x.query.draftId;o&&U(()=>{const t=e.drafts.find(_=>_.id===Number(o));t&&l.value&&(l.value.form.title=t.title??"",l.value.form.content_text=t.content_text??""),i.replace({path:x.path,query:{}})})}),tt(()=>x.params.id,async()=>{await k()});async function d(){if(!l.value)return;const{form:o}=l.value;if(!o.content_text.trim()){m.warning("请输入作文内容");return}try{await e.submitEssay({title:o.title,prompt:o.prompt,content_text:o.content_text,source_type:"text"});const t=window.setInterval(async()=>{e.currentEssay&&(await e.fetchEssay(e.currentEssay.id),(e.currentEssay.status==="done"||e.currentEssay.status==="failed")&&window.clearInterval(t))},2e3);window.setTimeout(()=>window.clearInterval(t),1e4)}catch(t){m.error(t.message||"提交失败")}}function D(){e.currentEssay&&(V.value={title:e.currentEssay.title??"",prompt:e.currentEssay.prompt??"",content_text:e.currentEssay.content_text??""}),e.clearCurrent(),i.push("/essay/correction").then(()=>{U(()=>{if(l.value&&V.value){const o=V.value;l.value.form.title=o.title,l.value.form.prompt=o.prompt,l.value.form.content_text=o.content_text,V.value=null}})})}const h=M(!1),I=M(!1);async function F(){if(e.currentEssay){h.value=!0;try{await e.favoriteEssay(e.currentEssay.id),e.setCurrentEssayFavorited(!0),m.success("收藏成功"),e.fetchEssay(e.currentEssay.id).catch(()=>{})}catch(o){m.error(o.message||"收藏失败")}finally{h.value=!1}}}async function R(){if(e.currentEssay){I.value=!0;try{await nt(e.currentEssay.id),e.setCurrentEssayFavorited(!1),m.success("已取消收藏"),e.fetchEssay(e.currentEssay.id).catch(()=>{})}catch(o){m.error(o.message||"取消收藏失败")}finally{I.value=!1}}}async function A(){if(!l.value)return;const{form:o}=l.value;if(!o.content_text.trim()){m.warning("请输入作文内容");return}if(!f.isAuthenticated){m.warning("请先登录"),i.push("/login");return}try{await e.createDraft({title:o.title,content_text:o.content_text}),m.success("草稿已保存")}catch(t){m.error(t.message||"保存失败")}}function w(o){l.value&&(l.value.form.title=o.title||"",l.value.form.content_text=o.content_text),b.value=!1}async function z(o){try{await st.confirm("确定要删除这个草稿吗？","提示",{type:"warning"}),await e.deleteDraft(o),m.success("删除成功")}catch(t){t!=="cancel"&&m.error(t.message||"删除失败")}}return(o,t)=>{const _=p("el-button"),B=p("el-link"),T=p("el-alert"),W=p("el-result"),q=p("el-card"),L=p("el-table-column"),H=p("el-table"),j=p("el-empty"),J=p("el-dialog");return c(),v("div",$t,[n("div",Vt,[a(q,{shadow:"never"},{header:s(()=>[n("div",It,[t[7]||(t[7]=n("h2",{class:"header-font"},"作文批改",-1)),!r(e).currentEssay||r(e).currentEssay.status!=="done"&&r(e).currentEssay.status!=="processing"?(c(),v("div",Mt,[r(f).isMember?(c(),C(_,{key:0,onClick:t[0]||(t[0]=y=>b.value=!0)},{default:s(()=>[...t[6]||(t[6]=[u(" 草稿列表 ",-1)])]),_:1})):E("",!0)])):E("",!0)])]),default:s(()=>[!r(e).currentEssay||r(e).currentEssay.status!=="done"&&r(e).currentEssay.status!=="processing"?(c(),v("div",Dt,[a(ct,{ref_key:"editorRef",ref:l},null,512),n("div",Ft,[r(f).isAuthenticated?E("",!0):(c(),C(T,{key:0,title:"提示",type:"warning",closable:!1,"show-icon":""},{default:s(()=>[t[9]||(t[9]=u(" 未登录用户无法批改作文，",-1)),a(B,{type:"primary",onClick:t[1]||(t[1]=y=>o.$router.push("/login"))},{default:s(()=>[...t[8]||(t[8]=[u(" 立即登录 ",-1)])]),_:1})]),_:1})),r(f).isMember?E("",!0):(c(),C(T,{key:1,class:"draft-tip",title:"提示",type:"info",closable:!1,"show-icon":""},{default:s(()=>[a(B,{type:"primary",onClick:t[2]||(t[2]=y=>o.$router.push("/profile"))},{default:s(()=>[...t[10]||(t[10]=[u("开通会员",-1)])]),_:1}),t[12]||(t[12]=u(" 可保存草稿，可前往 ",-1)),a(B,{type:"primary",onClick:t[3]||(t[3]=y=>o.$router.push("/essay/history"))},{default:s(()=>[...t[11]||(t[11]=[u("历史记录",-1)])]),_:1}),t[13]||(t[13]=u(" 查看草稿。 ",-1))]),_:1})),n("div",Rt,[a(_,{type:"primary",size:"large",loading:r(e).loading,onClick:d},{default:s(()=>[...t[14]||(t[14]=[u(" 提交批改 ",-1)])]),_:1},8,["loading"]),r(f).isAuthenticated?(c(),C(_,{key:0,size:"large",disabled:!r(f).isMember,onClick:A},{default:s(()=>[...t[15]||(t[15]=[u(" 保存草稿 ",-1)])]),_:1},8,["disabled"])):E("",!0)])])])):r(e).currentEssay&&r(e).currentEssay.status==="processing"?(c(),v("div",At,[a(W,{icon:"loading",title:"正在批改中..."},{"sub-title":s(()=>[...t[16]||(t[16]=[n("p",null,"AI正在分析您的作文，请稍候",-1)])]),_:1})])):r(e).currentCorrection?(c(),v("div",Bt,[n("div",Lt,[a(_,{onClick:D},{default:s(()=>[...t[17]||(t[17]=[u("重新批改",-1)])]),_:1}),r(f).isAuthenticated?(c(),v(et,{key:0},[r(e).currentEssay?.is_favorited?(c(),C(_,{key:1,loading:I.value,onClick:R},{default:s(()=>[...t[19]||(t[19]=[u(" 取消收藏 ",-1)])]),_:1},8,["loading"])):(c(),C(_,{key:0,type:"primary",loading:h.value,onClick:F},{default:s(()=>[...t[18]||(t[18]=[u(" 收藏 ",-1)])]),_:1},8,["loading"]))],64)):E("",!0)]),a(Ct,{correction:r(e).currentCorrection},null,8,["correction"])])):E("",!0)]),_:1})]),a(J,{modelValue:b.value,"onUpdate:modelValue":t[5]||(t[5]=y=>b.value=y),title:"草稿列表",width:"600px"},{default:s(()=>[a(H,{data:r(e).drafts,class:"drafts-table",style:{width:"100%"}},{default:s(()=>[a(L,{prop:"title",label:"标题"}),a(L,{prop:"updated_at",label:"更新时间",width:"180"},{default:s(({row:y})=>[u($(new Date(y.updated_at).toLocaleString()),1)]),_:1}),a(L,{label:"操作",width:"140",align:"right"},{default:s(({row:y})=>[n("div",St,[a(_,{type:"primary",text:"",onClick:K=>w(y)},{default:s(()=>[...t[20]||(t[20]=[u("加载",-1)])]),_:1},8,["onClick"]),a(_,{type:"danger",text:"",onClick:K=>z(y.id)},{default:s(()=>[...t[21]||(t[21]=[u("删除",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"]),r(e).drafts.length===0?(c(),v("div",Nt,[a(j,{description:"暂无草稿"},{default:s(()=>[a(_,{type:"primary",onClick:t[4]||(t[4]=y=>b.value=!1)},{default:s(()=>[...t[22]||(t[22]=[u("开始编辑",-1)])]),_:1})]),_:1})])):E("",!0)]),_:1},8,["modelValue"])])}}}),qt=N(Tt,[["__scopeId","data-v-dcae80db"]]);export{qt as default};
//# sourceMappingURL=Correction-Cxsu7wKq.js.map
