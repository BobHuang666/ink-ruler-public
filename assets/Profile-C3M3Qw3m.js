import{a1 as Ue,d as Ie,u as Me,k as p,l as z,I as D,m as Fe,C as Re,R as De,J as Se,c as V,a as s,e as a,w as l,r as f,g as d,t as v,N as E,f as le,a2 as se,F as Q,x as $e,b as X,p as qe,y as ze,A as Ee,E as r,o as k,_ as Be}from"./index-Bn_Xs3lU.js";import{m as oe}from"./format-CCCypCfS.js";import{s as ne,u as te,c as Le,a as Ne}from"./user-BtEeGdpS.js";async function Te(Y){return(await Ue.post("/feedbacks",Y)).data}const Ae={class:"profile-page"},Ke={class:"container"},We={class:"avatar-section"},Je={class:"avatar-section__name header-font"},je={class:"avatar-section__email"},Ge={class:"avatar-section__role"},He={class:"avatar-section__meta"},Oe={class:"ink-drops"},Qe={class:"avatar-section__actions"},Xe={class:"checkin-dialog"},Ye={class:"checkin-week-tip"},Ze={class:"checkin-ink-block"},ea={class:"checkin-ink-value"},aa={class:"checkin-grid"},la={class:"checkin-card-day"},sa={class:"checkin-card-reward"},oa={key:0,class:"checkin-card-done"},na={class:"checkin-result-area"},ta={class:"checkin-result-reward"},ra={key:0,class:"password-email-hint"},da={class:"password-code-row"},ia={class:"security-section"},ua={key:0,class:"cancel-email-hint"},ca={class:"cancel-code-row"},ma=Ie({__name:"Profile",setup(Y){const B=Ee(),re=Re(),i=Me(),L=p("info"),N=p(),T=p(),u=z({nickname:"",email:"",phone:"",avatar:""}),t=z({email_code:"",oldPassword:"",newPassword:"",confirmPassword:""}),A=D(()=>i.user?.email?oe(i.user.email):""),K=D(()=>i.user?.email?oe(i.user.email):""),W=p(!1),h=p(0);let P=null;const g=z({content:"",contact:""}),M=p(!1),J=p(!1),j=p(!1),C=p(0);let x=null;const c=z({password:"",email_code:""}),U=p(!1),y=p(null),G=p(!1),I=p(0),b=p(!1),de=[10,10,10,10,10,20,20],H=D(()=>y.value?y.value.week_count:I.value),ie=D(()=>b.value?Math.max(0,I.value-1):I.value),ue=D(()=>y.value?.ink_drops??i.user?.ink_drops??0);function ce(){U.value=!1,B.push("/membership?tab=inkLog")}function me(){y.value&&(I.value=y.value.week_count,y.value.already_signed&&(b.value=!0)),y.value=null}const pe={nickname:[{required:!0,message:"请输入昵称",trigger:"blur"},{min:2,max:20,message:"昵称长度在2到20个字符",trigger:"blur"}]},fe={oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(n,e,S)=>{e!==t.newPassword?S(new Error("两次输入的密码不一致")):S()},trigger:"blur"}]};async function ve(){if(!(h.value>0)){W.value=!0;try{await ne(),r.success(`验证码已发送至 ${A.value}，请查收`),h.value=60,P=setInterval(()=>{h.value--,h.value<=0&&P&&(clearInterval(P),P=null)},1e3)}catch(n){r.error(n.message||"发送失败")}finally{W.value=!1}}}Fe(()=>{const n=re.query.tab;n&&["info","password","feedback","security"].includes(n)&&(L.value=n),i.user&&(u.nickname=i.user.nickname,u.email=i.user.email||"",u.phone=i.user.phone||"",u.avatar=i.user.avatar||"")}),De(()=>i.user,n=>{n&&(I.value=n.checkin_week_count??0,b.value=n.checkin_today_done??!1)},{immediate:!0});async function we(){N.value&&await N.value.validate(async n=>{if(n)try{await te({nickname:u.nickname}),await i.fetchUser(),r.success("更新成功")}catch(e){r.error(e.message||"更新失败")}})}async function _e(){if(T.value){if(!t.email_code.trim()||t.email_code.length!==4){r.warning("请输入邮箱验证码（4位）");return}await T.value.validate(async n=>{if(n)try{await te({password_old:t.oldPassword,password_new:t.newPassword,email_code:t.email_code}),r.success("密码修改成功"),t.email_code="",t.oldPassword="",t.newPassword="",t.confirmPassword=""}catch(e){r.error(e.message||"密码修改失败")}})}}async function ke(){G.value=!0;try{const n=await Ne(),e=Number(n?.week_count??0);y.value={...n,week_count:e},I.value=e,b.value=!0,await i.fetchUser(),n.already_signed||r.success(`签到成功，获得 ${n.reward} 墨滴`)}catch(n){r.error(n.message||"签到失败")}finally{G.value=!1}}async function ge(){if(!g.content.trim()){r.warning("请输入反馈内容");return}try{await Te({content:g.content.trim(),contact:g.contact.trim()||void 0}),r.success("反馈提交成功，感谢您的建议！"),g.content="",g.contact=""}catch(n){r.error(n.message||"提交失败")}}function ye(){c.password="",c.email_code=""}function be(){c.password="",c.email_code="",M.value=!0}async function he(){if(!(C.value>0)){j.value=!0;try{await ne(),r.success(`验证码已发送至 ${K.value}，请查收`),C.value=60,x=setInterval(()=>{C.value--,C.value<=0&&x&&(clearInterval(x),x=null)},1e3)}catch(n){r.error(n.message||"发送失败")}finally{j.value=!1}}}Se(()=>{x&&clearInterval(x),P&&clearInterval(P)});async function O(){if(!c.password.trim()){r.warning("请输入当前密码");return}if(!c.email_code.trim()||c.email_code.length!==4){r.warning("请输入邮箱验证码（4位）");return}J.value=!0;try{await Le(c.password,c.email_code),i.clearLocal(),M.value=!1,r.success("账号已注销"),B.replace("/")}catch(n){r.error(n.message||"注销失败")}finally{J.value=!1}}return(n,e)=>{const S=f("el-avatar"),Z=f("el-tag"),w=f("el-button"),F=f("el-card"),Ce=f("el-link"),ee=f("el-dialog"),ae=f("el-col"),_=f("el-input"),m=f("el-form-item"),$=f("el-form"),q=f("el-tab-pane"),Ve=f("el-alert"),Pe=f("el-tabs"),xe=f("el-row");return k(),V("div",Ae,[s("div",Ke,[a(xe,{gutter:20},{default:l(()=>[a(ae,{xs:24,sm:6},{default:l(()=>[a(F,{shadow:"never",class:"profile-card"},{default:l(()=>[s("div",We,[a(S,{size:88,src:u.avatar,class:"avatar-section__avatar"},{default:l(()=>[d(v(u.nickname?.[0]),1)]),_:1},8,["src"]),s("h3",Je,v(u.nickname),1),s("p",je,v(u.email),1),s("div",Ge,[le(i).isMember?(k(),E(Z,{key:0,type:"success",size:"small"},{default:l(()=>[...e[18]||(e[18]=[d("会员",-1)])]),_:1})):(k(),E(Z,{key:1,type:"info",size:"small"},{default:l(()=>[...e[19]||(e[19]=[d("普通用户",-1)])]),_:1}))]),s("div",He,[s("span",Oe,"墨滴："+v(le(i).user?.ink_drops??0),1)]),s("div",Qe,[a(w,{type:b.value?"default":"primary",plain:b.value,size:"default",class:se(["avatar-section__checkin-btn",{"avatar-section__checkin-btn--done":b.value}]),onClick:e[0]||(e[0]=o=>U.value=!0)},{default:l(()=>[d(v(b.value?"已签到":"签到"),1)]),_:1},8,["type","plain","class"])])])]),_:1}),a(ee,{modelValue:U.value,"onUpdate:modelValue":e[3]||(e[3]=o=>U.value=o),title:"每日签到",width:"400px",class:"app-dialog checkin-dialog-wrap","align-center":"","destroy-on-close":"",onClose:me},{default:l(()=>[s("div",Xe,[s("p",Ye,"本周累计签到 "+v(H.value)+" 天",1),s("div",Ze,[e[21]||(e[21]=s("span",{class:"checkin-ink-icon","aria-hidden":"true"},[s("svg",{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[s("path",{d:"M12 2.5c0 0-5 8-5 13a5 5 0 0 0 10 0c0-5-5-13-5-13z",fill:"currentColor"})])],-1)),e[22]||(e[22]=s("span",{class:"checkin-ink-label"},"墨滴：",-1)),s("span",ea,v(ue.value),1),a(Ce,{type:"primary",underline:"hover",class:"checkin-ink-detail",onClick:ce},{default:l(()=>[...e[20]||(e[20]=[d("明细 >",-1)])]),_:1})]),y.value===null?(k(),V(Q,{key:0},[s("div",aa,[(k(),V(Q,null,$e(de,(o,R)=>s("div",{key:R,class:se(["checkin-grid-card",{"is-current":R===ie.value,"is-signed":R<H.value}])},[s("span",la,v(R+1)+"天",1),e[23]||(e[23]=s("span",{class:"checkin-card-star","aria-hidden":"true"},[s("svg",{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[s("path",{d:"M12 2.5c0 0-5 8-5 13a5 5 0 0 0 10 0c0-5-5-13-5-13z",fill:"currentColor"})])],-1)),s("span",sa,v(o)+" 墨滴",1),e[24]||(e[24]=s("span",{class:"checkin-card-vip"},"VIP+5",-1)),R<H.value?(k(),V("span",oa,"✓")):X("",!0)],2)),64))]),b.value?(k(),E(w,{key:0,class:"checkin-btn-done checkin-btn-done-inline",onClick:e[1]||(e[1]=o=>U.value=!1)},{default:l(()=>[...e[25]||(e[25]=[d(" 今日已签到 ",-1)])]),_:1})):(k(),E(w,{key:1,class:"checkin-btn-submit",loading:G.value,onClick:ke},{default:l(()=>[...e[26]||(e[26]=[d(" 立即签到 ",-1)])]),_:1},8,["loading"]))],64)):(k(),V(Q,{key:1},[s("div",na,[e[27]||(e[27]=s("div",{class:"checkin-result-star-wrap"},[s("span",{class:"checkin-result-star","aria-hidden":"true"},[s("svg",{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[s("path",{d:"M12 2.5c0 0-5 8-5 13a5 5 0 0 0 10 0c0-5-5-13-5-13z",fill:"currentColor"})])])],-1)),s("p",ta,"+"+v(y.value.reward)+" 墨滴",1),e[28]||(e[28]=s("p",{class:"checkin-result-msg"},"恭喜获得今日签到奖励！",-1))]),a(w,{class:"checkin-btn-done",onClick:e[2]||(e[2]=o=>U.value=!1)},{default:l(()=>[...e[29]||(e[29]=[d("今日已签到",-1)])]),_:1})],64))])]),_:1},8,["modelValue"])]),_:1}),a(ae,{xs:24,sm:18},{default:l(()=>[a(Pe,{modelValue:L.value,"onUpdate:modelValue":e[17]||(e[17]=o=>L.value=o),class:"profile-tabs"},{default:l(()=>[a(q,{label:"个人信息",name:"info"},{default:l(()=>[a(F,{shadow:"never"},{default:l(()=>[a($,{model:u,rules:pe,ref_key:"formRef",ref:N,class:"profile-form","label-width":"100px"},{default:l(()=>[a(m,{label:"昵称",prop:"nickname"},{default:l(()=>[a(_,{modelValue:u.nickname,"onUpdate:modelValue":e[4]||(e[4]=o=>u.nickname=o)},null,8,["modelValue"])]),_:1}),a(m,{label:"邮箱"},{default:l(()=>[a(_,{modelValue:u.email,"onUpdate:modelValue":e[5]||(e[5]=o=>u.email=o),disabled:""},null,8,["modelValue"])]),_:1}),a(m,{label:"手机号"},{default:l(()=>[a(_,{modelValue:u.phone,"onUpdate:modelValue":e[6]||(e[6]=o=>u.phone=o),disabled:""},null,8,["modelValue"])]),_:1}),a(m,null,{default:l(()=>[a(w,{type:"primary",onClick:we},{default:l(()=>[...e[30]||(e[30]=[d("保存",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(q,{label:"修改密码",name:"password"},{default:l(()=>[a(F,{shadow:"never"},{default:l(()=>[A.value?(k(),V("p",ra," 将向您的邮箱 "+v(A.value)+" 发送验证码 ",1)):X("",!0),a($,{model:t,rules:fe,ref_key:"passwordFormRef",ref:T,class:"profile-form","label-width":"100px"},{default:l(()=>[a(m,{label:"验证码",required:""},{default:l(()=>[s("div",da,[a(_,{modelValue:t.email_code,"onUpdate:modelValue":e[7]||(e[7]=o=>t.email_code=o),placeholder:"邮箱验证码（4位）",maxlength:"4",class:"password-code-input"},null,8,["modelValue"]),a(w,{type:"primary",disabled:h.value>0,loading:W.value,onClick:ve},{default:l(()=>[d(v(h.value>0?`${h.value}s 后重试`:"获取验证码"),1)]),_:1},8,["disabled","loading"])])]),_:1}),a(m,{label:"原密码",prop:"oldPassword"},{default:l(()=>[a(_,{modelValue:t.oldPassword,"onUpdate:modelValue":e[8]||(e[8]=o=>t.oldPassword=o),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(m,{label:"新密码",prop:"newPassword"},{default:l(()=>[a(_,{modelValue:t.newPassword,"onUpdate:modelValue":e[9]||(e[9]=o=>t.newPassword=o),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(m,{label:"确认密码",prop:"confirmPassword"},{default:l(()=>[a(_,{modelValue:t.confirmPassword,"onUpdate:modelValue":e[10]||(e[10]=o=>t.confirmPassword=o),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(m,null,{default:l(()=>[a(w,{type:"primary",onClick:_e},{default:l(()=>[...e[31]||(e[31]=[d("修改密码",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(q,{label:"反馈建议",name:"feedback"},{default:l(()=>[a(F,{shadow:"never"},{default:l(()=>[a($,{model:g,class:"profile-form","label-width":"100px"},{default:l(()=>[a(m,{label:"反馈内容"},{default:l(()=>[a(_,{modelValue:g.content,"onUpdate:modelValue":e[11]||(e[11]=o=>g.content=o),type:"textarea",rows:6,placeholder:"请输入您的反馈或建议..."},null,8,["modelValue"])]),_:1}),a(m,{label:"联系方式"},{default:l(()=>[a(_,{modelValue:g.contact,"onUpdate:modelValue":e[12]||(e[12]=o=>g.contact=o),placeholder:"邮箱或手机号（可选）"},null,8,["modelValue"])]),_:1}),a(m,null,{default:l(()=>[a(w,{type:"primary",onClick:ge},{default:l(()=>[...e[32]||(e[32]=[d("提交反馈",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(q,{label:"账号安全",name:"security"},{default:l(()=>[a(F,{shadow:"never"},{default:l(()=>[s("div",ia,[e[34]||(e[34]=s("h4",null,"注销账号",-1)),e[35]||(e[35]=s("p",{class:"security-desc"},"注销后账号及关联数据将被删除且无法恢复，请谨慎操作。",-1)),a(w,{type:"danger",plain:"",onClick:be},{default:l(()=>[...e[33]||(e[33]=[d("申请注销账号",-1)])]),_:1})])]),_:1}),a(ee,{modelValue:M.value,"onUpdate:modelValue":e[16]||(e[16]=o=>M.value=o),title:"注销账号",width:"400px",class:"cancel-account-dialog app-dialog","close-on-click-modal":!1,onClosed:ye},{footer:l(()=>[a(w,{onClick:e[15]||(e[15]=o=>M.value=!1)},{default:l(()=>[...e[37]||(e[37]=[d("取消",-1)])]),_:1}),a(w,{type:"danger",loading:J.value,onClick:O},{default:l(()=>[...e[38]||(e[38]=[d(" 确认注销 ",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(Ve,{class:"tip-alert cancel-dialog-tip",title:"注销说明",type:"warning",closable:!1,"show-icon":""},{default:l(()=>[...e[36]||(e[36]=[d(" 注销后账号及关联数据将被删除且无法恢复，请谨慎操作。 ",-1)])]),_:1}),K.value?(k(),V("p",ua," 将向您的邮箱 "+v(K.value)+" 发送验证码 ",1)):X("",!0),a($,{model:c,"label-width":"80px",onSubmit:qe(O,["prevent"])},{default:l(()=>[a(m,{label:"验证码",required:""},{default:l(()=>[s("div",ca,[a(_,{modelValue:c.email_code,"onUpdate:modelValue":e[13]||(e[13]=o=>c.email_code=o),placeholder:"邮箱验证码（4位）",maxlength:"4","show-word-limit":"",class:"cancel-code-input"},null,8,["modelValue"]),a(w,{type:"primary",disabled:C.value>0,loading:j.value,onClick:he},{default:l(()=>[d(v(C.value>0?`${C.value}s 后重试`:"获取验证码"),1)]),_:1},8,["disabled","loading"])])]),_:1}),a(m,{label:"当前密码",required:""},{default:l(()=>[a(_,{modelValue:c.password,"onUpdate:modelValue":e[14]||(e[14]=o=>c.password=o),type:"password","show-password":"",placeholder:"请输入当前密码以确认",onKeyup:ze(O,["enter"])},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})])])}}}),_a=Be(ma,[["__scopeId","data-v-c730b2ad"]]);export{_a as default};
//# sourceMappingURL=Profile-C3M3Qw3m.js.map
