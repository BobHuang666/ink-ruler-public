import{R as x,d as ue,u as ce,l as v,m as E,n as me,M as pe,c as D,a as y,e as a,w as t,r,j as F,g as n,D as b,f as G,b as H,s as fe,P as _e,F as we,x as ve,q as ye,y as be,E as i,A as ge,o as p,_ as ke}from"./index-BeVUFvTo.js";import{u as Ve,j as he}from"./essay-Dh0PJN41.js";async function J(f){await x.patch("/users/me",f);const l=(await x.get("/users/me")).data,g=l.membership;return{id:l.id,email:l.email,phone:l.phone,nickname:l.nickname||"",avatar:l.avatar,role:l.role,status:l.status,created_at:l.created_at??"",updated_at:l.updated_at??"",...g&&{membership:{id:0,user_id:l.id,plan:g.plan,started_at:"",expired_at:g.expired_at,status:g.status,created_at:"",updated_at:""}}}}async function Pe(){return(await x.get("/memberships/me")).data}async function Ce(f){return(await x.post("/memberships/purchase",{plan:f})).data}async function xe(f){await x.post("/users/me/cancel",{password:f})}async function Ue(f){return(await x.post("/feedbacks",f)).data}const De={class:"profile-page"},Fe={class:"container"},Me={class:"avatar-section"},Se={class:"email"},Le={key:0,class:"membership-info"},Re={class:"membership-actions"},qe={class:"favorites-list"},Ee={class:"favorite-time"},Ae={class:"security-section"},Be=ue({__name:"Profile",setup(f){const M=ge(),l=ce(),g=v("info"),A=v(),B=v(),k=v(null),d=E({nickname:"",email:"",phone:"",avatar:""}),u=E({oldPassword:"",newPassword:"",confirmPassword:""}),m=E({content:"",contact:""}),U=v(!1),N=v(!1),V=E({password:""}),P=v([]),S=v(!1),$=v(null),O={nickname:[{required:!0,message:"请输入昵称",trigger:"blur"},{min:2,max:20,message:"昵称长度在2到20个字符",trigger:"blur"}]},Q={oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(o,e,L)=>{e!==u.newPassword?L(new Error("两次输入的密码不一致")):L()},trigger:"blur"}]};me(async()=>{l.user&&(d.nickname=l.user.nickname,d.email=l.user.email||"",d.phone=l.user.phone||"",d.avatar=l.user.avatar||""),await Y()}),pe(g,o=>{o==="favorites"&&W()});async function W(){S.value=!0;try{P.value=await he()}catch{P.value=[]}finally{S.value=!1}}async function X(o){$.value=o.essay_id;try{await Ve(o.essay_id),P.value=P.value.filter(e=>e.essay_id!==o.essay_id),i.success("已取消收藏")}catch(e){i.error(e.message||"取消收藏失败")}finally{$.value=null}}async function Y(){try{k.value=await Pe()}catch{}}async function Z(){A.value&&await A.value.validate(async o=>{if(o)try{await J({nickname:d.nickname}),await l.fetchUser(),i.success("更新成功")}catch(e){i.error(e.message||"更新失败")}})}async function ee(){B.value&&await B.value.validate(async o=>{if(o)try{await J({password_old:u.oldPassword,password_new:u.newPassword}),i.success("密码修改成功"),u.oldPassword="",u.newPassword="",u.confirmPassword=""}catch(e){i.error(e.message||"密码修改失败")}})}async function K(){try{const o=await Ce("student");k.value=o,await l.fetchUser(),i.success("会员购买成功")}catch(o){i.error(o.message||"购买失败")}}async function ae(){if(!m.content.trim()){i.warning("请输入反馈内容");return}try{await Ue({content:m.content.trim(),contact:m.contact.trim()||void 0}),i.success("反馈提交成功，感谢您的建议！"),m.content="",m.contact=""}catch(o){i.error(o.message||"提交失败")}}function te(){V.password="",U.value=!0}async function I(){if(!V.password.trim()){i.warning("请输入当前密码");return}N.value=!0;try{await xe(V.password),l.clearLocal(),U.value=!1,i.success("账号已注销"),M.replace("/")}catch(o){i.error(o.message||"注销失败")}finally{N.value=!1}}return(o,e)=>{const L=r("el-avatar"),j=r("el-tag"),h=r("el-card"),T=r("el-col"),_=r("el-input"),c=r("el-form-item"),w=r("el-button"),R=r("el-form"),C=r("el-tab-pane"),q=r("el-descriptions-item"),se=r("el-descriptions"),z=r("el-empty"),le=r("router-link"),oe=r("el-alert"),ne=r("el-dialog"),re=r("el-tabs"),de=r("el-row"),ie=_e("loading");return p(),D("div",De,[y("div",Fe,[a(de,{gutter:20},{default:t(()=>[a(T,{span:6},{default:t(()=>[a(h,{shadow:"never",class:"profile-card"},{default:t(()=>[y("div",Me,[a(L,{size:100,src:d.avatar},{default:t(()=>[n(b(d.nickname?.[0]),1)]),_:1},8,["src"]),y("h3",null,b(d.nickname),1),y("p",Se,b(d.email),1),G(l).isMember?(p(),F(j,{key:0,type:"success"},{default:t(()=>[...e[13]||(e[13]=[n("会员",-1)])]),_:1})):(p(),F(j,{key:1,type:"info"},{default:t(()=>[...e[14]||(e[14]=[n("普通用户",-1)])]),_:1}))])]),_:1})]),_:1}),a(T,{span:18},{default:t(()=>[a(re,{modelValue:g.value,"onUpdate:modelValue":e[12]||(e[12]=s=>g.value=s)},{default:t(()=>[a(C,{label:"个人信息",name:"info"},{default:t(()=>[a(h,{shadow:"never"},{default:t(()=>[a(R,{model:d,rules:O,ref_key:"formRef",ref:A,"label-width":"100px"},{default:t(()=>[a(c,{label:"昵称",prop:"nickname"},{default:t(()=>[a(_,{modelValue:d.nickname,"onUpdate:modelValue":e[0]||(e[0]=s=>d.nickname=s)},null,8,["modelValue"])]),_:1}),a(c,{label:"邮箱"},{default:t(()=>[a(_,{modelValue:d.email,"onUpdate:modelValue":e[1]||(e[1]=s=>d.email=s),disabled:""},null,8,["modelValue"])]),_:1}),a(c,{label:"手机号"},{default:t(()=>[a(_,{modelValue:d.phone,"onUpdate:modelValue":e[2]||(e[2]=s=>d.phone=s),disabled:""},null,8,["modelValue"])]),_:1}),a(c,null,{default:t(()=>[a(w,{type:"primary",onClick:Z},{default:t(()=>[...e[15]||(e[15]=[n("保存",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(C,{label:"修改密码",name:"password"},{default:t(()=>[a(h,{shadow:"never"},{default:t(()=>[a(R,{model:u,rules:Q,ref_key:"passwordFormRef",ref:B,"label-width":"100px"},{default:t(()=>[a(c,{label:"原密码",prop:"oldPassword"},{default:t(()=>[a(_,{modelValue:u.oldPassword,"onUpdate:modelValue":e[3]||(e[3]=s=>u.oldPassword=s),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(c,{label:"新密码",prop:"newPassword"},{default:t(()=>[a(_,{modelValue:u.newPassword,"onUpdate:modelValue":e[4]||(e[4]=s=>u.newPassword=s),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(c,{label:"确认密码",prop:"confirmPassword"},{default:t(()=>[a(_,{modelValue:u.confirmPassword,"onUpdate:modelValue":e[5]||(e[5]=s=>u.confirmPassword=s),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(c,null,{default:t(()=>[a(w,{type:"primary",onClick:ee},{default:t(()=>[...e[16]||(e[16]=[n("修改密码",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(C,{label:"会员信息",name:"membership"},{default:t(()=>[a(h,{shadow:"never"},{default:t(()=>[k.value?(p(),D("div",Le,[a(se,{column:2,border:""},{default:t(()=>[a(q,{label:"会员计划"},{default:t(()=>[n(b(k.value.plan),1)]),_:1}),a(q,{label:"状态"},{default:t(()=>[a(j,{type:k.value.status==="active"?"success":"info"},{default:t(()=>[n(b(k.value.status==="active"?"有效":"已过期"),1)]),_:1},8,["type"])]),_:1}),a(q,{label:"开始时间"},{default:t(()=>[n(b(new Date(k.value.started_at).toLocaleDateString()),1)]),_:1}),a(q,{label:"到期时间"},{default:t(()=>[n(b(new Date(k.value.expired_at).toLocaleDateString()),1)]),_:1})]),_:1}),y("div",Re,[G(l).isMember?H("",!0):(p(),F(w,{key:0,type:"primary",onClick:K},{default:t(()=>[...e[17]||(e[17]=[n(" 升级会员 ",-1)])]),_:1}))])])):(p(),F(z,{key:1,description:"您还不是会员"},{default:t(()=>[a(w,{type:"primary",onClick:K},{default:t(()=>[...e[18]||(e[18]=[n("购买会员",-1)])]),_:1})]),_:1}))]),_:1})]),_:1}),a(C,{label:"收藏夹",name:"favorites"},{default:t(()=>[a(h,{shadow:"never"},{default:t(()=>[fe((p(),D("div",qe,[P.value.length?(p(!0),D(we,{key:0},ve(P.value,s=>(p(),D("div",{key:s.favorite_id,class:"favorite-item"},[a(le,{to:`/essay/${s.essay_id}`,class:"favorite-title"},{default:t(()=>[n(b(s.title||"无标题"),1)]),_:2},1032,["to"]),y("span",Ee,b(new Date(s.essay_created_at).toLocaleString()),1),a(w,{type:"danger",text:"",loading:$.value===s.essay_id,onClick:$e=>X(s)},{default:t(()=>[...e[19]||(e[19]=[n(" 取消收藏 ",-1)])]),_:1},8,["loading","onClick"])]))),128)):S.value?H("",!0):(p(),F(z,{key:1,description:"暂无收藏"}))])),[[ie,S.value]])]),_:1})]),_:1}),a(C,{label:"反馈建议",name:"feedback"},{default:t(()=>[a(h,{shadow:"never"},{default:t(()=>[a(R,{model:m,"label-width":"100px"},{default:t(()=>[a(c,{label:"反馈内容"},{default:t(()=>[a(_,{modelValue:m.content,"onUpdate:modelValue":e[6]||(e[6]=s=>m.content=s),type:"textarea",rows:6,placeholder:"请输入您的反馈或建议..."},null,8,["modelValue"])]),_:1}),a(c,{label:"联系方式"},{default:t(()=>[a(_,{modelValue:m.contact,"onUpdate:modelValue":e[7]||(e[7]=s=>m.contact=s),placeholder:"邮箱或手机号（可选）"},null,8,["modelValue"])]),_:1}),a(c,null,{default:t(()=>[a(w,{type:"primary",onClick:ae},{default:t(()=>[...e[20]||(e[20]=[n("提交反馈",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(C,{label:"账号安全",name:"security"},{default:t(()=>[a(h,{shadow:"never"},{default:t(()=>[y("div",Ae,[e[22]||(e[22]=y("h4",null,"注销账号",-1)),e[23]||(e[23]=y("p",{class:"security-desc"},"注销后账号及关联数据将被删除且无法恢复，请谨慎操作。",-1)),a(w,{type:"danger",plain:"",onClick:te},{default:t(()=>[...e[21]||(e[21]=[n("申请注销账号",-1)])]),_:1})])]),_:1}),a(ne,{modelValue:U.value,"onUpdate:modelValue":e[10]||(e[10]=s=>U.value=s),title:"注销账号",width:"400px","close-on-click-modal":!1,onClosed:e[11]||(e[11]=s=>V.password="")},{footer:t(()=>[a(w,{onClick:e[9]||(e[9]=s=>U.value=!1)},{default:t(()=>[...e[25]||(e[25]=[n("取消",-1)])]),_:1}),a(w,{type:"danger",loading:N.value,onClick:I},{default:t(()=>[...e[26]||(e[26]=[n(" 确认注销 ",-1)])]),_:1},8,["loading"])]),default:t(()=>[a(oe,{type:"warning",closable:!1,"show-icon":"",class:"cancel-dialog-tip"},{default:t(()=>[...e[24]||(e[24]=[n(" 注销后账号及关联数据将被删除且无法恢复，请谨慎操作。确认无误后请输入当前密码并点击「确认注销」。 ",-1)])]),_:1}),a(R,{model:V,"label-width":"80px",onSubmit:ye(I,["prevent"])},{default:t(()=>[a(c,{label:"当前密码",required:""},{default:t(()=>[a(_,{modelValue:V.password,"onUpdate:modelValue":e[8]||(e[8]=s=>V.password=s),type:"password","show-password":"",placeholder:"请输入当前密码以确认",onKeyup:be(I,["enter"])},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})])])}}}),Ke=ke(Be,[["__scopeId","data-v-0c535fca"]]);export{Ke as default};
//# sourceMappingURL=Profile-DWBiYTP6.js.map
