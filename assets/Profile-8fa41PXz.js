import{R as D,d as ye,u as be,l as f,m as A,n as ge,M as ke,c as B,a as h,e as a,w as t,r,j as V,g as o,D as c,f as Y,b as he,s as Z,P as Ve,q as Pe,y as Ce,E as d,A as xe,o as p,_ as Ue}from"./index-DuIC7plb.js";import{u as Fe,j as De}from"./essay--3Qb8fiE.js";import{u as Me,g as Se}from"./classic-l3kYh4Uo.js";async function ee(w){await D.patch("/users/me",w);const n=(await D.get("/users/me")).data,b=n.membership;return{id:n.id,email:n.email,phone:n.phone,nickname:n.nickname||"",avatar:n.avatar,role:n.role,status:n.status,created_at:n.created_at??"",updated_at:n.updated_at??"",...b&&{membership:{id:0,user_id:n.id,plan:b.plan,started_at:"",expired_at:b.expired_at,status:b.status,created_at:"",updated_at:""}}}}async function $e(){return(await D.get("/memberships/me")).data}async function Le(w){return(await D.post("/memberships/purchase",{plan:w})).data}async function Re(w){await D.post("/users/me/cancel",{password:w})}async function qe(w){return(await D.post("/feedbacks",w)).data}const Ee={class:"profile-page"},Ae={class:"container"},Be={class:"avatar-section"},Ie={class:"header-font"},Ne={class:"email"},je={key:0,class:"membership-info"},Ke={class:"membership-actions"},Te={key:0,class:"table-scroll-wrap"},ze={key:0,class:"table-scroll-wrap"},Ge={class:"security-section"},He=ye({__name:"Profile",setup(w){const S=xe(),n=be(),b=f("info"),I=f(),N=f(),g=f(null),i=A({nickname:"",email:"",phone:"",avatar:""}),u=A({oldPassword:"",newPassword:"",confirmPassword:""}),v=A({content:"",contact:""}),M=f(!1),j=f(!1),P=A({password:""}),x=f([]),$=f(!1),K=f(null),U=f([]),L=f(!1),T=f(null),ae={nickname:[{required:!0,message:"请输入昵称",trigger:"blur"},{min:2,max:20,message:"昵称长度在2到20个字符",trigger:"blur"}]},te={oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(s,e,R)=>{e!==u.newPassword?R(new Error("两次输入的密码不一致")):R()},trigger:"blur"}]};ge(async()=>{n.user&&(i.nickname=n.user.nickname,i.email=n.user.email||"",i.phone=n.user.phone||"",i.avatar=n.user.avatar||""),await re()}),ke(b,s=>{s==="favorites"&&le(),s==="classicFavorites"&&oe()});async function le(){$.value=!0;try{x.value=await De()}catch{x.value=[]}finally{$.value=!1}}async function se(s){K.value=s.essay_id;try{await Fe(s.essay_id),x.value=x.value.filter(e=>e.essay_id!==s.essay_id),d.success("已取消收藏")}catch(e){d.error(e.message||"取消收藏失败")}finally{K.value=null}}async function oe(){L.value=!0;try{U.value=await Se()}catch{U.value=[]}finally{L.value=!1}}async function ne(s){T.value=s.id;try{await Me(s.id),U.value=U.value.filter(e=>e.id!==s.id),d.success("已取消收藏")}catch(e){d.error(e.message||"取消收藏失败")}finally{T.value=null}}async function re(){try{g.value=await $e()}catch{}}async function ie(){I.value&&await I.value.validate(async s=>{if(s)try{await ee({nickname:i.nickname}),await n.fetchUser(),d.success("更新成功")}catch(e){d.error(e.message||"更新失败")}})}async function de(){N.value&&await N.value.validate(async s=>{if(s)try{await ee({password_old:u.oldPassword,password_new:u.newPassword}),d.success("密码修改成功"),u.oldPassword="",u.newPassword="",u.confirmPassword=""}catch(e){d.error(e.message||"密码修改失败")}})}async function J(){try{const s=await Le("student");g.value=s,await n.fetchUser(),d.success("会员购买成功")}catch(s){d.error(s.message||"购买失败")}}async function ue(){if(!v.content.trim()){d.warning("请输入反馈内容");return}try{await qe({content:v.content.trim(),contact:v.contact.trim()||void 0}),d.success("反馈提交成功，感谢您的建议！"),v.content="",v.contact=""}catch(s){d.error(s.message||"提交失败")}}function ce(){P.password="",M.value=!0}async function z(){if(!P.password.trim()){d.warning("请输入当前密码");return}j.value=!0;try{await Re(P.password),n.clearLocal(),M.value=!1,d.success("账号已注销"),S.replace("/")}catch(s){d.error(s.message||"注销失败")}finally{j.value=!1}}return(s,e)=>{const R=r("el-avatar"),G=r("el-tag"),k=r("el-card"),O=r("el-col"),y=r("el-input"),m=r("el-form-item"),_=r("el-button"),q=r("el-form"),C=r("el-tab-pane"),E=r("el-descriptions-item"),me=r("el-descriptions"),H=r("el-empty"),Q=r("router-link"),F=r("el-table-column"),W=r("el-table"),fe=r("el-alert"),pe=r("el-dialog"),_e=r("el-tabs"),ve=r("el-row"),X=Ve("loading");return p(),B("div",Ee,[h("div",Ae,[a(ve,{gutter:20},{default:t(()=>[a(O,{xs:24,sm:24,md:6,lg:6},{default:t(()=>[a(k,{shadow:"never",class:"profile-card"},{default:t(()=>[h("div",Be,[a(R,{size:100,src:i.avatar},{default:t(()=>[o(c(i.nickname?.[0]),1)]),_:1},8,["src"]),h("h3",Ie,c(i.nickname),1),h("p",Ne,c(i.email),1),Y(n).isMember?(p(),V(G,{key:0,type:"success"},{default:t(()=>[...e[14]||(e[14]=[o("会员",-1)])]),_:1})):(p(),V(G,{key:1,type:"info"},{default:t(()=>[...e[15]||(e[15]=[o("普通用户",-1)])]),_:1}))])]),_:1})]),_:1}),a(O,{xs:24,sm:24,md:18,lg:18},{default:t(()=>[a(_e,{modelValue:b.value,"onUpdate:modelValue":e[13]||(e[13]=l=>b.value=l),class:"profile-tabs"},{default:t(()=>[a(C,{label:"个人信息",name:"info"},{default:t(()=>[a(k,{shadow:"never"},{default:t(()=>[a(q,{model:i,rules:ae,ref_key:"formRef",ref:I,class:"profile-form","label-width":"100px"},{default:t(()=>[a(m,{label:"昵称",prop:"nickname"},{default:t(()=>[a(y,{modelValue:i.nickname,"onUpdate:modelValue":e[0]||(e[0]=l=>i.nickname=l)},null,8,["modelValue"])]),_:1}),a(m,{label:"邮箱"},{default:t(()=>[a(y,{modelValue:i.email,"onUpdate:modelValue":e[1]||(e[1]=l=>i.email=l),disabled:""},null,8,["modelValue"])]),_:1}),a(m,{label:"手机号"},{default:t(()=>[a(y,{modelValue:i.phone,"onUpdate:modelValue":e[2]||(e[2]=l=>i.phone=l),disabled:""},null,8,["modelValue"])]),_:1}),a(m,null,{default:t(()=>[a(_,{type:"primary",onClick:ie},{default:t(()=>[...e[16]||(e[16]=[o("保存",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(C,{label:"修改密码",name:"password"},{default:t(()=>[a(k,{shadow:"never"},{default:t(()=>[a(q,{model:u,rules:te,ref_key:"passwordFormRef",ref:N,class:"profile-form","label-width":"100px"},{default:t(()=>[a(m,{label:"原密码",prop:"oldPassword"},{default:t(()=>[a(y,{modelValue:u.oldPassword,"onUpdate:modelValue":e[3]||(e[3]=l=>u.oldPassword=l),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(m,{label:"新密码",prop:"newPassword"},{default:t(()=>[a(y,{modelValue:u.newPassword,"onUpdate:modelValue":e[4]||(e[4]=l=>u.newPassword=l),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(m,{label:"确认密码",prop:"confirmPassword"},{default:t(()=>[a(y,{modelValue:u.confirmPassword,"onUpdate:modelValue":e[5]||(e[5]=l=>u.confirmPassword=l),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(m,null,{default:t(()=>[a(_,{type:"primary",onClick:de},{default:t(()=>[...e[17]||(e[17]=[o("修改密码",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(C,{label:"会员信息",name:"membership"},{default:t(()=>[a(k,{shadow:"never"},{default:t(()=>[g.value?(p(),B("div",je,[a(me,{column:1,border:""},{default:t(()=>[a(E,{label:"会员计划"},{default:t(()=>[o(c(g.value.plan),1)]),_:1}),a(E,{label:"状态"},{default:t(()=>[a(G,{type:g.value.status==="active"?"success":"info"},{default:t(()=>[o(c(g.value.status==="active"?"有效":"已过期"),1)]),_:1},8,["type"])]),_:1}),a(E,{label:"开始时间"},{default:t(()=>[o(c(new Date(g.value.started_at).toLocaleDateString()),1)]),_:1}),a(E,{label:"到期时间"},{default:t(()=>[o(c(new Date(g.value.expired_at).toLocaleDateString()),1)]),_:1})]),_:1}),h("div",Ke,[Y(n).isMember?he("",!0):(p(),V(_,{key:0,type:"primary",onClick:J},{default:t(()=>[...e[18]||(e[18]=[o(" 升级会员 ",-1)])]),_:1}))])])):(p(),V(H,{key:1,description:"您还不是会员"},{default:t(()=>[a(_,{type:"primary",onClick:J},{default:t(()=>[...e[19]||(e[19]=[o("购买会员",-1)])]),_:1})]),_:1}))]),_:1})]),_:1}),a(C,{label:"收藏夹",name:"favorites"},{default:t(()=>[a(k,{shadow:"never"},{default:t(()=>[x.value.length||$.value?(p(),B("div",Te,[Z((p(),V(W,{data:x.value,class:"profile-table",style:{width:"100%"}},{default:t(()=>[a(F,{prop:"title",label:"标题","min-width":"120"},{default:t(({row:l})=>[a(Q,{to:`/essay/${l.essay_id}`,class:"table-link"},{default:t(()=>[o(c(l.title||"无标题"),1)]),_:2},1032,["to"])]),_:1}),a(F,{label:"收藏时间","min-width":"150"},{default:t(({row:l})=>[o(c(new Date(l.essay_created_at).toLocaleString()),1)]),_:1}),a(F,{label:"操作","min-width":"100",align:"right"},{default:t(({row:l})=>[a(_,{type:"danger",text:"",loading:K.value===l.essay_id,onClick:we=>se(l)},{default:t(()=>[...e[20]||(e[20]=[o(" 取消收藏 ",-1)])]),_:1},8,["loading","onClick"])]),_:1})]),_:1},8,["data"])),[[X,$.value]])])):(p(),V(H,{key:1,description:"暂无收藏"}))]),_:1})]),_:1}),a(C,{label:"素材收藏",name:"classicFavorites"},{default:t(()=>[a(k,{shadow:"never"},{default:t(()=>[U.value.length||L.value?(p(),B("div",ze,[Z((p(),V(W,{data:U.value,class:"profile-table",style:{width:"100%"}},{default:t(()=>[a(F,{label:"内容","min-width":"180"},{default:t(({row:l})=>[a(Q,{to:`/classic/item/${l.id}`,class:"table-link"},{default:t(()=>[o(c(l.original_text?.slice(0,50))+c((l.original_text?.length??0)>50?"…":""),1)]),_:2},1032,["to"])]),_:1}),a(F,{label:"作者/朝代","min-width":"100"},{default:t(({row:l})=>[o(c(l.author)+" "+c(l.dynasty),1)]),_:1}),a(F,{label:"操作","min-width":"100",align:"right"},{default:t(({row:l})=>[a(_,{type:"danger",text:"",loading:T.value===l.id,onClick:we=>ne(l)},{default:t(()=>[...e[21]||(e[21]=[o(" 取消收藏 ",-1)])]),_:1},8,["loading","onClick"])]),_:1})]),_:1},8,["data"])),[[X,L.value]])])):(p(),V(H,{key:1,description:"暂无素材收藏"},{default:t(()=>[a(_,{type:"primary",onClick:e[6]||(e[6]=l=>s.$router.push("/classic"))},{default:t(()=>[...e[22]||(e[22]=[o("去素材中心",-1)])]),_:1})]),_:1}))]),_:1})]),_:1}),a(C,{label:"反馈建议",name:"feedback"},{default:t(()=>[a(k,{shadow:"never"},{default:t(()=>[a(q,{model:v,class:"profile-form","label-width":"100px"},{default:t(()=>[a(m,{label:"反馈内容"},{default:t(()=>[a(y,{modelValue:v.content,"onUpdate:modelValue":e[7]||(e[7]=l=>v.content=l),type:"textarea",rows:6,placeholder:"请输入您的反馈或建议..."},null,8,["modelValue"])]),_:1}),a(m,{label:"联系方式"},{default:t(()=>[a(y,{modelValue:v.contact,"onUpdate:modelValue":e[8]||(e[8]=l=>v.contact=l),placeholder:"邮箱或手机号（可选）"},null,8,["modelValue"])]),_:1}),a(m,null,{default:t(()=>[a(_,{type:"primary",onClick:ue},{default:t(()=>[...e[23]||(e[23]=[o("提交反馈",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(C,{label:"账号安全",name:"security"},{default:t(()=>[a(k,{shadow:"never"},{default:t(()=>[h("div",Ge,[e[25]||(e[25]=h("h4",null,"注销账号",-1)),e[26]||(e[26]=h("p",{class:"security-desc"},"注销后账号及关联数据将被删除且无法恢复，请谨慎操作。",-1)),a(_,{type:"danger",plain:"",onClick:ce},{default:t(()=>[...e[24]||(e[24]=[o("申请注销账号",-1)])]),_:1})])]),_:1}),a(pe,{modelValue:M.value,"onUpdate:modelValue":e[11]||(e[11]=l=>M.value=l),title:"注销账号",width:"400px",class:"cancel-account-dialog","close-on-click-modal":!1,onClosed:e[12]||(e[12]=l=>P.password="")},{footer:t(()=>[a(_,{onClick:e[10]||(e[10]=l=>M.value=!1)},{default:t(()=>[...e[28]||(e[28]=[o("取消",-1)])]),_:1}),a(_,{type:"danger",loading:j.value,onClick:z},{default:t(()=>[...e[29]||(e[29]=[o(" 确认注销 ",-1)])]),_:1},8,["loading"])]),default:t(()=>[a(fe,{class:"tip-alert cancel-dialog-tip",title:"提示",type:"warning",closable:!1,"show-icon":""},{default:t(()=>[...e[27]||(e[27]=[o(" 注销后账号及关联数据将被删除且无法恢复，请谨慎操作。确认无误后请输入当前密码并点击「确认注销」。 ",-1)])]),_:1}),a(q,{model:P,"label-width":"80px",onSubmit:Pe(z,["prevent"])},{default:t(()=>[a(m,{label:"当前密码",required:""},{default:t(()=>[a(y,{modelValue:P.password,"onUpdate:modelValue":e[9]||(e[9]=l=>P.password=l),type:"password","show-password":"",placeholder:"请输入当前密码以确认",onKeyup:Ce(z,["enter"])},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})])])}}}),Xe=Ue(He,[["__scopeId","data-v-7b19dd17"]]);export{Xe as default};
//# sourceMappingURL=Profile-8fa41PXz.js.map
