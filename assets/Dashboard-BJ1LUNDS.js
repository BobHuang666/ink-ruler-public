import{a1 as V,d as Le,k as n,m as $e,J as Se,E as p,c as le,a as o,e,w as a,r as c,f as E,ac as Te,s as Fe,ad as Ee,ae as Re,q as x,v as R,t as v,g as i,y as qe,af as Me,N as B,$ as Be,b as se,o as z,_ as Ne}from"./index-DECpGxzK.js";async function Pe(){return(await V.get("/admin/metrics")).data}async function je(d){const u=d.page??1,_=d.size??10,m=await V.get("/admin/users",{params:{q:d.q,role:d.role,status:d.status,page:u,size:_}});return{items:(m.data.list??[]).map(f=>({id:f.id,email:f.email,phone:f.phone,nickname:f.nickname??"",avatar:f.avatar,role:f.role,status:f.status,ink_drops:f.ink_drops??0,membership_label:f.membership_label??"非会员",created_at:f.created_at??"",updated_at:f.updated_at??""})),total:m.data.total??0,page:u,size:_}}async function ve(d,u){await V.patch(`/admin/users/${d}`,u)}async function Ae(d,u){await V.post(`/admin/users/${d}/ink-drops`,{amount:u})}async function Oe(d){const u=d?.page??1,_=d?.size??20,m=await V.get("/admin/logs",{params:{page:u,size:_}});return{items:m.data.list??[],total:m.data.total??0,page:u,size:_}}async function Ge(d){const u=d?.page??1,_=d?.size??10,m=await V.get("/admin/flags",{params:{page:u,size:_}});return{items:m.data.list??[],total:m.data.total??0,page:u,size:_}}async function Ke(d,u){await V.patch(`/admin/flags/${d}`,{status:u})}async function Je(d,u){return(await V.post("/admin/redemption-codes",{kind:d,count:u})).data}const Qe={class:"admin-page"},We={class:"admin-container"},He={class:"dashboard-content"},Xe={class:"metric-item"},Ye={class:"metric-value"},Ze={class:"metric-item"},et={class:"metric-value"},tt={class:"metric-item"},at={class:"metric-value"},lt={class:"metric-item"},st={class:"metric-value"},ot={class:"users-content"},nt={class:"search-bar"},ut={class:"table-scroll-wrap"},dt={class:"content-content"},it={class:"table-scroll-wrap"},rt={class:"redemption-codes-content"},ct={key:0,class:"redeem-result"},mt={class:"redeem-result-actions"},pt={class:"logs-content"},vt={class:"table-scroll-wrap"},ft={key:0,class:"ink-drops-target"},_t=Le({__name:"Dashboard",setup(d){const u=n("dashboard"),_=n(3),m=n({user_count:0,active_user_count:0,essay_count:0,token_usage:{total:0,today:0,this_month:0}}),N=n([]),f=n(!1),P=n(""),j=n(""),A=n(""),O=n(1),G=n(10),oe=n(0),ne=n([]),K=n(!1),ue=n([]),J=n(!1),S=n(!1),C=n({role:"",status:""}),Q=n(null),T=n(!1),k=n(null),I=n({amount:1e3}),W=n(!1),h=n({kind:"quota_10",count:5}),H=n(!1),de=n([]),U=n("");function X(){_.value=window.innerWidth>=768?3:1}$e(async()=>{X(),window.addEventListener("resize",X),await fe(),await D(),await ie(),await _e()}),Se(()=>{window.removeEventListener("resize",X)});async function fe(){try{m.value=await Pe()}catch(s){p.error(s.message||"获取数据失败")}}async function D(){f.value=!0;try{const s=await je({q:P.value,role:j.value,status:A.value,page:O.value,size:G.value});N.value=s.items,oe.value=s.total}catch(s){p.error(s.message||"获取用户列表失败")}finally{f.value=!1}}async function ie(){K.value=!0;try{const s=await Ge({});ne.value=s.items}catch(s){p.error(s.message||"获取内容标记失败")}finally{K.value=!1}}async function _e(){J.value=!0;try{const s=await Oe({});ue.value=s.items}catch(s){p.error(s.message||"获取日志失败")}finally{J.value=!1}}function ge(s){s!==u.value&&(u.value=s)}function be(s){Q.value=s.id,C.value={role:s.role,status:s.status},S.value=!0}async function ye(){if(Q.value)try{await ve(Q.value,C.value),p.success("更新成功"),S.value=!1,await D()}catch(s){p.error(s.message||"更新失败")}}async function we(s){try{await ve(s.id,{status:s.status==="active"?"disabled":"active"}),p.success("操作成功"),await D()}catch(t){p.error(t.message||"操作失败")}}function ke(s){k.value=s,I.value={amount:1e3},T.value=!0}async function he(){if(!(!k.value||I.value.amount<1)){W.value=!0;try{await Ae(k.value.id,I.value.amount),p.success("已添加墨滴"),T.value=!1,k.value=null,await D()}catch(s){p.error(s.message||"添加失败")}finally{W.value=!1}}}async function xe(s){try{await Ke(s.id,"resolved"),p.success("标记已处理"),await ie()}catch(t){p.error(t.message||"操作失败")}}async function Ve(){H.value=!0;try{const s=await Je(h.value.kind,h.value.count);de.value=s.codes,U.value=s.codes.join(`
`),p.success(`已生成 ${s.codes.length} 个兑换码`)}catch(s){p.error(s.message||"生成失败")}finally{H.value=!1}}function Ce(){U.value&&navigator.clipboard.writeText(U.value).then(()=>p.success("已复制到剪贴板"),()=>p.error("复制失败"))}function Ue(){if(!U.value)return;const s=new Blob([U.value],{type:"text/plain;charset=utf-8"}),t=URL.createObjectURL(s),y=document.createElement("a");y.href=t,y.download=`兑换码_${h.value.kind}_${Date.now()}.txt`,y.click(),URL.revokeObjectURL(t),p.success("已下载")}return(s,t)=>{const y=c("el-icon"),q=c("el-menu-item"),De=c("el-menu"),L=c("el-col"),w=c("el-card"),re=c("el-row"),Y=c("el-descriptions-item"),ze=c("el-descriptions"),ce=c("el-input"),b=c("el-option"),F=c("el-select"),g=c("el-button"),r=c("el-table-column"),M=c("el-tag"),Z=c("el-table"),Ie=c("el-pagination"),$=c("el-form-item"),me=c("el-input-number"),ee=c("el-form"),pe=c("el-dialog"),te=Be("loading");return z(),le("div",Qe,[o("div",We,[e(re,{gutter:20},{default:a(()=>[e(L,{xs:24,sm:4},{default:a(()=>[e(De,{"default-active":u.value,class:"admin-menu",onSelect:ge},{default:a(()=>[e(q,{index:"dashboard"},{default:a(()=>[e(y,null,{default:a(()=>[e(E(Te))]),_:1}),t[15]||(t[15]=o("span",null,"数据看板",-1))]),_:1}),e(q,{index:"users"},{default:a(()=>[e(y,null,{default:a(()=>[e(E(Fe))]),_:1}),t[16]||(t[16]=o("span",null,"用户管理",-1))]),_:1}),e(q,{index:"redemption-codes"},{default:a(()=>[e(y,null,{default:a(()=>[e(E(Ee))]),_:1}),t[17]||(t[17]=o("span",null,"兑换码",-1))]),_:1}),e(q,{index:"logs"},{default:a(()=>[e(y,null,{default:a(()=>[e(E(Re))]),_:1}),t[18]||(t[18]=o("span",null,"操作日志",-1))]),_:1})]),_:1},8,["default-active"])]),_:1}),e(L,{xs:24,sm:20},{default:a(()=>[x(o("div",He,[t[24]||(t[24]=o("h2",{class:"header-font"},"数据看板",-1)),e(re,{gutter:20,class:"metrics-row"},{default:a(()=>[e(L,{xs:12,sm:6},{default:a(()=>[e(w,{shadow:"hover"},{default:a(()=>[o("div",Xe,[o("div",Ye,v(m.value.user_count),1),t[19]||(t[19]=o("div",{class:"metric-label"},"总用户数",-1))])]),_:1})]),_:1}),e(L,{xs:12,sm:6},{default:a(()=>[e(w,{shadow:"hover"},{default:a(()=>[o("div",Ze,[o("div",et,v(m.value.active_user_count),1),t[20]||(t[20]=o("div",{class:"metric-label"},"活跃用户",-1))])]),_:1})]),_:1}),e(L,{xs:12,sm:6},{default:a(()=>[e(w,{shadow:"hover"},{default:a(()=>[o("div",tt,[o("div",at,v(m.value.essay_count),1),t[21]||(t[21]=o("div",{class:"metric-label"},"作文提交量",-1))])]),_:1})]),_:1}),e(L,{xs:12,sm:6},{default:a(()=>[e(w,{shadow:"hover"},{default:a(()=>[o("div",lt,[o("div",st,v(m.value.token_usage.total),1),t[22]||(t[22]=o("div",{class:"metric-label"},"Token使用总量",-1))])]),_:1})]),_:1})]),_:1}),e(w,{shadow:"never",class:"token-card"},{default:a(()=>[t[23]||(t[23]=o("h3",{class:"header-font"},"Token使用情况",-1)),e(ze,{column:_.value,border:""},{default:a(()=>[e(Y,{label:"今日使用"},{default:a(()=>[i(v(m.value.token_usage.today),1)]),_:1}),e(Y,{label:"本月使用"},{default:a(()=>[i(v(m.value.token_usage.this_month),1)]),_:1}),e(Y,{label:"总使用量"},{default:a(()=>[i(v(m.value.token_usage.total),1)]),_:1})]),_:1},8,["column"])]),_:1}),t[25]||(t[25]=o("p",{class:"dashboard-note"},"活跃用户：统计最近 7 天内有过登录的用户。",-1))],512),[[R,u.value==="dashboard"]]),x(o("div",ot,[t[29]||(t[29]=o("h2",{class:"header-font"},"用户管理",-1)),e(w,{shadow:"never"},{default:a(()=>[o("div",nt,[e(ce,{modelValue:P.value,"onUpdate:modelValue":t[0]||(t[0]=l=>P.value=l),placeholder:"搜索用户...",class:"search-input",clearable:"",onKeyup:qe(D,["enter"])},{prefix:a(()=>[e(y,null,{default:a(()=>[e(E(Me))]),_:1})]),_:1},8,["modelValue"]),e(F,{modelValue:j.value,"onUpdate:modelValue":t[1]||(t[1]=l=>j.value=l),placeholder:"角色",class:"search-select",clearable:""},{default:a(()=>[e(b,{label:"学生",value:"student"}),e(b,{label:"管理员",value:"admin"})]),_:1},8,["modelValue"]),e(F,{modelValue:A.value,"onUpdate:modelValue":t[2]||(t[2]=l=>A.value=l),placeholder:"状态",class:"search-select",clearable:""},{default:a(()=>[e(b,{label:"正常",value:"active"}),e(b,{label:"禁用",value:"disabled"})]),_:1},8,["modelValue"]),e(g,{type:"primary",onClick:D},{default:a(()=>[...t[26]||(t[26]=[i("搜索",-1)])]),_:1})]),o("div",ut,[x((z(),B(Z,{data:N.value,style:{width:"100%","margin-top":"20px"}},{default:a(()=>[e(r,{prop:"id",label:"ID",width:"80"}),e(r,{prop:"nickname",label:"昵称"}),e(r,{prop:"email",label:"邮箱"}),e(r,{prop:"role",label:"角色",width:"100"},{default:a(({row:l})=>[e(M,{type:l.role==="admin"?"danger":"primary"},{default:a(()=>[i(v(l.role==="admin"?"管理员":"学生"),1)]),_:2},1032,["type"])]),_:1}),e(r,{prop:"status",label:"状态",width:"100"},{default:a(({row:l})=>[e(M,{type:l.status==="active"?"success":"info"},{default:a(()=>[i(v(l.status==="active"?"正常":"禁用"),1)]),_:2},1032,["type"])]),_:1}),e(r,{prop:"membership_label",label:"会员",width:"110"},{default:a(({row:l})=>[e(M,{type:l.membership_label==="会员"?"warning":l.membership_label!=="非会员"?"primary":"info"},{default:a(()=>[i(v(l.membership_label??"非会员"),1)]),_:2},1032,["type"])]),_:1}),e(r,{prop:"ink_drops",label:"墨滴",width:"90",align:"center"},{default:a(({row:l})=>[i(v(l.ink_drops??0),1)]),_:1}),e(r,{label:"操作",width:"260"},{default:a(({row:l})=>[e(g,{type:"primary",text:"",onClick:ae=>be(l)},{default:a(()=>[...t[27]||(t[27]=[i("编辑",-1)])]),_:1},8,["onClick"]),e(g,{type:"primary",text:"",onClick:ae=>ke(l)},{default:a(()=>[...t[28]||(t[28]=[i("添加墨滴",-1)])]),_:1},8,["onClick"]),e(g,{type:l.status==="active"?"warning":"success",text:"",onClick:ae=>we(l)},{default:a(()=>[i(v(l.status==="active"?"禁用":"启用"),1)]),_:2},1032,["type","onClick"])]),_:1})]),_:1},8,["data"])),[[te,f.value]])]),e(Ie,{"current-page":O.value,"onUpdate:currentPage":t[3]||(t[3]=l=>O.value=l),"page-size":G.value,"onUpdate:pageSize":t[4]||(t[4]=l=>G.value=l),total:oe.value,layout:"total, prev, pager, next",style:{"margin-top":"20px"},onCurrentChange:D},null,8,["current-page","page-size","total"])]),_:1})],512),[[R,u.value==="users"]]),x(o("div",dt,[t[31]||(t[31]=o("h2",{class:"header-font"},"内容管理",-1)),e(w,{shadow:"never"},{default:a(()=>[o("div",it,[x((z(),B(Z,{data:ne.value,class:"admin-table",style:{width:"100%"}},{default:a(()=>[e(r,{prop:"id",label:"ID",width:"80"}),e(r,{prop:"target_type",label:"类型",width:"120"}),e(r,{prop:"target_id",label:"目标ID",width:"100"}),e(r,{prop:"reason",label:"原因"}),e(r,{prop:"status",label:"状态",width:"100"},{default:a(({row:l})=>[e(M,{type:l.status==="resolved"?"success":"warning"},{default:a(()=>[i(v(l.status==="resolved"?"已处理":"待处理"),1)]),_:2},1032,["type"])]),_:1}),e(r,{label:"操作",width:"150"},{default:a(({row:l})=>[l.status==="open"?(z(),B(g,{key:0,type:"success",text:"",onClick:ae=>xe(l)},{default:a(()=>[...t[30]||(t[30]=[i(" 标记已处理 ",-1)])]),_:1},8,["onClick"])):se("",!0)]),_:1})]),_:1},8,["data"])),[[te,K.value]])])]),_:1})],512),[[R,u.value==="content"]]),x(o("div",rt,[t[35]||(t[35]=o("h2",{class:"header-font"},"生成兑换码",-1)),e(w,{shadow:"never"},{default:a(()=>[e(ee,{model:h.value,"label-width":"80px",class:"redeem-form"},{default:a(()=>[e($,{label:"类型"},{default:a(()=>[e(F,{modelValue:h.value.kind,"onUpdate:modelValue":t[5]||(t[5]=l=>h.value.kind=l),placeholder:"选择类型"},{default:a(()=>[e(b,{label:"10 次次数卡",value:"quota_10"}),e(b,{label:"月卡",value:"month"}),e(b,{label:"年卡",value:"year"})]),_:1},8,["modelValue"])]),_:1}),e($,{label:"数量"},{default:a(()=>[e(me,{modelValue:h.value.count,"onUpdate:modelValue":t[6]||(t[6]=l=>h.value.count=l),min:1,max:100},null,8,["modelValue"])]),_:1}),e($,null,{default:a(()=>[e(g,{type:"primary",loading:H.value,onClick:Ve},{default:a(()=>[...t[32]||(t[32]=[i(" 生成 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),de.value.length?(z(),le("div",ct,[o("div",mt,[e(g,{size:"small",onClick:Ce},{default:a(()=>[...t[33]||(t[33]=[i("复制全部",-1)])]),_:1}),e(g,{size:"small",onClick:Ue},{default:a(()=>[...t[34]||(t[34]=[i("下载 txt",-1)])]),_:1})]),e(ce,{modelValue:U.value,"onUpdate:modelValue":t[7]||(t[7]=l=>U.value=l),type:"textarea",rows:10,readonly:"",class:"redeem-codes-textarea"},null,8,["modelValue"])])):se("",!0)]),_:1})],512),[[R,u.value==="redemption-codes"]]),x(o("div",pt,[t[36]||(t[36]=o("h2",{class:"header-font"},"操作日志",-1)),e(w,{shadow:"never"},{default:a(()=>[o("div",vt,[x((z(),B(Z,{data:ue.value,class:"admin-table",style:{width:"100%"}},{default:a(()=>[e(r,{prop:"id",label:"ID",width:"80"}),e(r,{prop:"action",label:"操作"}),e(r,{prop:"target_type",label:"目标类型",width:"120"}),e(r,{prop:"target_id",label:"目标ID",width:"100"}),e(r,{prop:"ip",label:"IP",width:"150"}),e(r,{prop:"created_at",label:"时间",width:"180"},{default:a(({row:l})=>[i(v(new Date(l.created_at).toLocaleString()),1)]),_:1})]),_:1},8,["data"])),[[te,J.value]])])]),_:1})],512),[[R,u.value==="logs"]])]),_:1})]),_:1})]),e(pe,{modelValue:S.value,"onUpdate:modelValue":t[11]||(t[11]=l=>S.value=l),title:"编辑用户",width:"500px",class:"edit-user-dialog"},{footer:a(()=>[e(g,{onClick:t[10]||(t[10]=l=>S.value=!1)},{default:a(()=>[...t[37]||(t[37]=[i("取消",-1)])]),_:1}),e(g,{type:"primary",onClick:ye},{default:a(()=>[...t[38]||(t[38]=[i("保存",-1)])]),_:1})]),default:a(()=>[e(ee,{model:C.value,"label-width":"100px"},{default:a(()=>[e($,{label:"角色"},{default:a(()=>[e(F,{modelValue:C.value.role,"onUpdate:modelValue":t[8]||(t[8]=l=>C.value.role=l)},{default:a(()=>[e(b,{label:"学生",value:"student"}),e(b,{label:"管理员",value:"admin"})]),_:1},8,["modelValue"])]),_:1}),e($,{label:"状态"},{default:a(()=>[e(F,{modelValue:C.value.status,"onUpdate:modelValue":t[9]||(t[9]=l=>C.value.status=l)},{default:a(()=>[e(b,{label:"正常",value:"active"}),e(b,{label:"禁用",value:"disabled"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),e(pe,{modelValue:T.value,"onUpdate:modelValue":t[14]||(t[14]=l=>T.value=l),title:"添加墨滴",width:"400px"},{footer:a(()=>[e(g,{onClick:t[13]||(t[13]=l=>T.value=!1)},{default:a(()=>[...t[40]||(t[40]=[i("取消",-1)])]),_:1}),e(g,{type:"primary",loading:W.value,onClick:he},{default:a(()=>[...t[41]||(t[41]=[i("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[k.value?(z(),le("p",ft," 用户："+v(k.value.nickname||k.value.email)+"（ID: "+v(k.value.id)+"） ",1)):se("",!0),e(ee,{model:I.value,"label-width":"80px"},{default:a(()=>[e($,{label:"数量"},{default:a(()=>[e(me,{modelValue:I.value.amount,"onUpdate:modelValue":t[12]||(t[12]=l=>I.value.amount=l),min:1,max:99999},null,8,["modelValue"])]),_:1}),t[39]||(t[39]=o("p",{class:"ink-drops-hint"},"请输入 1～99999",-1))]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),bt=Ne(_t,[["__scopeId","data-v-8f6efa4a"]]);export{bt as default};
//# sourceMappingURL=Dashboard-BJ1LUNDS.js.map
