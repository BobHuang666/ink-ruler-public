import{d as te,u as ae,k as m,I as ne,m as se,C as oe,R as le,c as v,a as t,e as n,w as s,r as c,N as x,g as r,y as ie,t as i,F as A,b as L,f as V,x as ce,q as re,$ as de,a2 as ue,E as _,U as $,o as d,_ as pe}from"./index-Bn_Xs3lU.js";import{g as I,r as me,b as _e,e as ge,d as fe}from"./user-BtEeGdpS.js";const ve={class:"membership-page"},he={class:"container"},be={class:"membership-intro"},ke={key:0,class:"membership-info"},ye={key:1,class:"membership-info"},we={class:"ink-exchange-section"},xe={class:"ink-balance"},Le={class:"ink-exchange-cards"},Ce={class:"ink-card-title"},Te={class:"ink-card-desc"},Be={class:"ink-card-cost"},qe={class:"ink-cost-num"},De={key:0,class:"ink-hint"},Ee={class:"membership-redeem"},Me={class:"redeem-box"},Se={class:"ink-log-section"},Ve={class:"ink-balance"},k="inkruler@163.com",U=20,$e=te({__name:"Membership",setup(Ie){const F=oe(),g=ae(),y=m("info"),a=m(null),h=m(""),C=m(!1),T=m(""),H=[{type:"quota_10",title:"10 次次数卡",desc:"可批改 10 篇作文，不限期使用",cost:900},{type:"month",title:"1 个月会员",desc:"30 天内无限次批改",cost:1500},{type:"year",title:"1 年会员",desc:"一年内无限次批改，更划算",cost:15e3}];async function z(){try{await window.navigator.clipboard.writeText(k),_.success("已复制到剪贴板")}catch{_.error("复制失败")}}const N=ne(()=>!!(a.value?.started_at&&a.value?.expired_at&&!String(a.value.expired_at).startsWith("0001"))),B=m([]),q=m(!1),D=m(1),E=m(0),W={register_gift:"注册赠送",checkin:"签到",correct:"批改消耗",exchange_quota_10:"兑换10次次数卡",exchange_month:"兑换月会员",exchange_year:"兑换年会员",admin_grant:"管理员增加"},j={quota_10:"10 次次数卡",month:"1 个月会员",year:"1 年会员"};async function G(){try{a.value=await I()}catch{}}async function J(){const o=h.value.trim();if(!o)return;let e;try{const{kind:p}=await me(o);e=j[p]??p}catch{_.error("兑换码无效或已使用");return}if(await $.confirm(`每个兑换码仅可使用一次，确定使用兑换码「${o}」兑换「${e}」吗？`,"兑换提示",{confirmButtonText:"确认兑换",cancelButtonText:"取消",type:"info",customClass:"app-dialog"}).catch(()=>!1)){C.value=!0;try{await _e(o),await g.fetchUser(),a.value=await I(),h.value="",_.success("兑换成功")}catch(p){_.error(p.message||"兑换失败")}finally{C.value=!1}}}async function O(o){const{type:e,title:u,cost:p}=o,b=g.user?.ink_drops??0;if(b<p){const f=`墨滴不足，可联系 <span class="app-dialog-email" data-email="${k}">${k}</span> 获取更多服务`,M=$.alert(f,"提示",{confirmButtonText:"确定",customClass:"app-dialog",dangerouslyUseHTMLString:!0});setTimeout(()=>{document.querySelectorAll(".app-dialog-email").forEach(w=>{w.addEventListener("click",()=>{window.navigator.clipboard.writeText(k).then(()=>_.success("已复制到剪贴板"),()=>_.error("复制失败"))})})},50),await M;return}if(await $.confirm(`将消耗 ${p} 墨滴兑换「${u}」。
当前墨滴：${b}`,"消耗确认",{confirmButtonText:"确认继续",cancelButtonText:"取消",type:"info",customClass:"app-dialog"}).catch(()=>!1)){T.value=e;try{await ge(e),await g.fetchUser(),a.value=await I(),_.success("兑换成功")}catch(f){_.error(f.message||"兑换失败")}finally{T.value=""}}}async function P(){q.value=!0;try{const o=await fe({page:D.value,size:U});E.value=o.total,B.value=(o.list||[]).map(e=>({...e,kind_label:W[e.kind]||e.kind}))}catch{B.value=[]}finally{q.value=!1}}function Q(o){D.value=o,P()}return se(async()=>{const o=F.query.tab;(o==="inkLog"||o==="info")&&(y.value=o),await G()}),le(y,o=>{o==="inkLog"&&P()}),(o,e)=>{const u=c("el-descriptions-item"),p=c("el-tag"),b=c("el-descriptions"),K=c("el-empty"),f=c("el-button"),M=c("el-input"),w=c("el-card"),R=c("el-tab-pane"),S=c("el-table-column"),X=c("el-table"),Y=c("el-pagination"),Z=c("el-tabs"),ee=de("loading");return d(),v("div",ve,[t("div",he,[e[12]||(e[12]=t("h1",{class:"page-title header-font"},"会员中心",-1)),n(Z,{modelValue:y.value,"onUpdate:modelValue":e[1]||(e[1]=l=>y.value=l),class:"membership-tabs"},{default:s(()=>[n(R,{label:"会员信息",name:"info"},{default:s(()=>[n(w,{shadow:"never"},{default:s(()=>[t("div",be,[t("p",null,[e[2]||(e[2]=r(" 如需获得更多服务，可使用",-1)),e[3]||(e[3]=t("span",{class:"ink-highlight"},"墨滴",-1)),e[4]||(e[4]=r("兑换，或联系 ",-1)),t("span",{class:"contact-email",role:"button",tabindex:"0",onClick:z,onKeydown:ie(z,["enter"])},i(k),32),e[5]||(e[5]=r(" 获取兑换码。 ",-1))])]),N.value&&a.value||a.value&&(a.value.quota_remaining??0)>0?(d(),v(A,{key:0},[e[6]||(e[6]=t("h3",{class:"membership-info-title"},"会员信息",-1)),N.value&&a.value?(d(),v("div",ke,[n(b,{column:1,border:"",class:"membership-descriptions"},{default:s(()=>[n(u,{label:"会员计划"},{default:s(()=>[r(i(a.value.plan),1)]),_:1}),n(u,{label:"状态"},{default:s(()=>[n(p,{type:a.value.status==="active"?"success":"info"},{default:s(()=>[r(i(a.value.status==="active"?"有效":"已过期"),1)]),_:1},8,["type"])]),_:1}),n(u,{label:"开始时间"},{default:s(()=>[r(i(new Date(a.value.started_at).toLocaleDateString()),1)]),_:1}),n(u,{label:"到期时间"},{default:s(()=>[r(i(new Date(a.value.expired_at).toLocaleDateString()),1)]),_:1}),(a.value.quota_remaining??0)>0?(d(),x(u,{key:0,label:"次数卡剩余"},{default:s(()=>[r(i(a.value.quota_remaining),1)]),_:1})):L("",!0)]),_:1})])):a.value&&(a.value.quota_remaining??0)>0?(d(),v("div",ye,[n(b,{column:1,border:"",class:"membership-descriptions"},{default:s(()=>[n(u,{label:"次数卡剩余"},{default:s(()=>[r(i(a.value.quota_remaining),1)]),_:1})]),_:1})])):L("",!0)],64)):(d(),x(K,{key:1,description:"您还不是会员",class:"membership-empty"})),t("div",we,[e[9]||(e[9]=t("h3",{class:"ink-exchange-title"},"墨滴兑换",-1)),t("p",xe,"当前墨滴："+i(V(g).user?.ink_drops??0),1),t("div",Le,[(d(),v(A,null,ce(H,l=>t("div",{key:l.type,class:"ink-exchange-card"},[t("div",Ce,i(l.title),1),t("p",Te,i(l.desc),1),t("div",Be,[t("span",qe,i(l.cost),1),e[7]||(e[7]=t("span",{class:"ink-cost-unit"},"墨滴",-1))]),n(f,{type:"primary",size:"default",class:"ink-card-btn",loading:T.value===l.type,onClick:Ue=>O(l)},{default:s(()=>[...e[8]||(e[8]=[r(" 兑换 ",-1)])]),_:1},8,["loading","onClick"])])),64))]),(V(g).user?.ink_drops??0)<900?(d(),v("p",De," 墨滴可通过签到获得 ")):L("",!0)]),t("div",Ee,[e[11]||(e[11]=t("h3",{class:"membership-redeem-title"},"兑换码",-1)),t("div",Me,[n(M,{modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=l=>h.value=l),placeholder:"请输入兑换码",clearable:"",maxlength:"64",class:"redeem-input"},null,8,["modelValue"]),n(f,{type:"primary",loading:C.value,disabled:!h.value.trim(),onClick:J},{default:s(()=>[...e[10]||(e[10]=[r(" 兑换 ",-1)])]),_:1},8,["loading","disabled"])])])]),_:1})]),_:1}),n(R,{label:"墨滴明细",name:"inkLog"},{default:s(()=>[n(w,{shadow:"never"},{default:s(()=>[t("div",Se,[t("p",Ve,"当前墨滴："+i(V(g).user?.ink_drops??0),1),re((d(),x(X,{data:B.value,class:"profile-table",style:{width:"100%"}},{default:s(()=>[n(S,{prop:"kind_label",label:"类型","min-width":"100"}),n(S,{prop:"amount",label:"变动","min-width":"80"},{default:s(({row:l})=>[t("span",{class:ue(l.amount>=0?"ink-plus":"ink-minus")},i(l.amount>=0?"+":"")+i(l.amount),3)]),_:1}),n(S,{prop:"created_at",label:"时间","min-width":"160"},{default:s(({row:l})=>[r(i(new Date(l.created_at).toLocaleString()),1)]),_:1})]),_:1},8,["data"])),[[ee,q.value]]),E.value>U?(d(),x(Y,{key:0,class:"ink-log-pagination",layout:"prev, pager, next","current-page":D.value,"page-size":U,total:E.value,onCurrentChange:Q},null,8,["current-page","total"])):L("",!0)])]),_:1})]),_:1})]),_:1},8,["modelValue"])])])}}}),Pe=pe($e,[["__scopeId","data-v-91ba7f2f"]]);export{Pe as default};
//# sourceMappingURL=Membership-3mtEiXCW.js.map
