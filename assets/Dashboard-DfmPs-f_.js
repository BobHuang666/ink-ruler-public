import{W as V,d as Le,l as n,n as Se,K as $e,E as v,c as le,a as o,e,w as a,r as i,f as E,a7 as Te,t as Fe,a8 as Ee,a9 as Re,s as x,v as R,D as p,g as r,y as Me,aa as qe,j as q,U as Be,b as se,o as z,_ as je}from"./index-D4Y8RUFA.js";async function Ne(){return(await V.get("/admin/metrics")).data}async function Pe(d){const u=d.page??1,_=d.size??10,m=await V.get("/admin/users",{params:{q:d.q,role:d.role,status:d.status,page:u,size:_}});return{items:(m.data.list??[]).map(f=>({id:f.id,email:f.email,phone:f.phone,nickname:f.nickname??"",avatar:f.avatar,role:f.role,status:f.status,ink_drops:f.ink_drops??0,created_at:f.created_at??"",updated_at:f.updated_at??""})),total:m.data.total??0,page:u,size:_}}async function pe(d,u){await V.patch(`/admin/users/${d}`,u)}async function Ae(d,u){await V.post(`/admin/users/${d}/ink-drops`,{amount:u})}async function Ke(d){const u=d?.page??1,_=d?.size??20,m=await V.get("/admin/logs",{params:{page:u,size:_}});return{items:m.data.list??[],total:m.data.total??0,page:u,size:_}}async function Oe(d){const u=d?.page??1,_=d?.size??10,m=await V.get("/admin/flags",{params:{page:u,size:_}});return{items:m.data.list??[],total:m.data.total??0,page:u,size:_}}async function Ge(d,u){await V.patch(`/admin/flags/${d}`,{status:u})}async function We(d,u){return(await V.post("/admin/redemption-codes",{kind:d,count:u})).data}const Qe={class:"admin-page"},He={class:"admin-container"},Je={class:"dashboard-content"},Xe={class:"metric-item"},Ye={class:"metric-value"},Ze={class:"metric-item"},et={class:"metric-value"},tt={class:"metric-item"},at={class:"metric-value"},lt={class:"metric-item"},st={class:"metric-value"},ot={class:"users-content"},nt={class:"search-bar"},ut={class:"table-scroll-wrap"},dt={class:"content-content"},it={class:"table-scroll-wrap"},rt={class:"redemption-codes-content"},ct={key:0,class:"redeem-result"},mt={class:"redeem-result-actions"},vt={class:"logs-content"},pt={class:"table-scroll-wrap"},ft={key:0,class:"ink-drops-target"},_t=Le({__name:"Dashboard",setup(d){const u=n("dashboard"),_=n(3),m=n({user_count:0,active_user_count:0,essay_count:0,token_usage:{total:0,today:0,this_month:0}}),B=n([]),f=n(!1),j=n(""),N=n(""),P=n(""),A=n(1),K=n(10),oe=n(0),ne=n([]),O=n(!1),ue=n([]),G=n(!1),$=n(!1),C=n({role:"",status:""}),W=n(null),T=n(!1),k=n(null),I=n({amount:1e3}),Q=n(!1),h=n({kind:"quota_10",count:5}),H=n(!1),de=n([]),U=n("");function J(){_.value=window.innerWidth>=768?3:1}Se(async()=>{J(),window.addEventListener("resize",J),await fe(),await D(),await ie(),await _e()}),$e(()=>{window.removeEventListener("resize",J)});async function fe(){try{m.value=await Ne()}catch(s){v.error(s.message||"获取数据失败")}}async function D(){f.value=!0;try{const s=await Pe({q:j.value,role:N.value,status:P.value,page:A.value,size:K.value});B.value=s.items,oe.value=s.total}catch(s){v.error(s.message||"获取用户列表失败")}finally{f.value=!1}}async function ie(){O.value=!0;try{const s=await Oe({});ne.value=s.items}catch(s){v.error(s.message||"获取内容标记失败")}finally{O.value=!1}}async function _e(){G.value=!0;try{const s=await Ke({});ue.value=s.items}catch(s){v.error(s.message||"获取日志失败")}finally{G.value=!1}}function ge(s){s!==u.value&&(u.value=s)}function be(s){W.value=s.id,C.value={role:s.role,status:s.status},$.value=!0}async function we(){if(W.value)try{await pe(W.value,C.value),v.success("更新成功"),$.value=!1,await D()}catch(s){v.error(s.message||"更新失败")}}async function ye(s){try{await pe(s.id,{status:s.status==="active"?"disabled":"active"}),v.success("操作成功"),await D()}catch(t){v.error(t.message||"操作失败")}}function ke(s){k.value=s,I.value={amount:1e3},T.value=!0}async function he(){if(!(!k.value||I.value.amount<1)){Q.value=!0;try{await Ae(k.value.id,I.value.amount),v.success("已添加墨滴"),T.value=!1,k.value=null,await D()}catch(s){v.error(s.message||"添加失败")}finally{Q.value=!1}}}async function xe(s){try{await Ge(s.id,"resolved"),v.success("标记已处理"),await ie()}catch(t){v.error(t.message||"操作失败")}}async function Ve(){H.value=!0;try{const s=await We(h.value.kind,h.value.count);de.value=s.codes,U.value=s.codes.join(`
`),v.success(`已生成 ${s.codes.length} 个兑换码`)}catch(s){v.error(s.message||"生成失败")}finally{H.value=!1}}function Ce(){U.value&&navigator.clipboard.writeText(U.value).then(()=>v.success("已复制到剪贴板"),()=>v.error("复制失败"))}function Ue(){if(!U.value)return;const s=new Blob([U.value],{type:"text/plain;charset=utf-8"}),t=URL.createObjectURL(s),w=document.createElement("a");w.href=t,w.download=`兑换码_${h.value.kind}_${Date.now()}.txt`,w.click(),URL.revokeObjectURL(t),v.success("已下载")}return(s,t)=>{const w=i("el-icon"),M=i("el-menu-item"),De=i("el-menu"),L=i("el-col"),y=i("el-card"),re=i("el-row"),X=i("el-descriptions-item"),ze=i("el-descriptions"),ce=i("el-input"),b=i("el-option"),F=i("el-select"),g=i("el-button"),c=i("el-table-column"),Y=i("el-tag"),Z=i("el-table"),Ie=i("el-pagination"),S=i("el-form-item"),me=i("el-input-number"),ee=i("el-form"),ve=i("el-dialog"),te=Be("loading");return z(),le("div",Qe,[o("div",He,[e(re,{gutter:20},{default:a(()=>[e(L,{xs:24,sm:4},{default:a(()=>[e(De,{"default-active":u.value,class:"admin-menu",onSelect:ge},{default:a(()=>[e(M,{index:"dashboard"},{default:a(()=>[e(w,null,{default:a(()=>[e(E(Te))]),_:1}),t[15]||(t[15]=o("span",null,"数据看板",-1))]),_:1}),e(M,{index:"users"},{default:a(()=>[e(w,null,{default:a(()=>[e(E(Fe))]),_:1}),t[16]||(t[16]=o("span",null,"用户管理",-1))]),_:1}),e(M,{index:"redemption-codes"},{default:a(()=>[e(w,null,{default:a(()=>[e(E(Ee))]),_:1}),t[17]||(t[17]=o("span",null,"兑换码",-1))]),_:1}),e(M,{index:"logs"},{default:a(()=>[e(w,null,{default:a(()=>[e(E(Re))]),_:1}),t[18]||(t[18]=o("span",null,"操作日志",-1))]),_:1})]),_:1},8,["default-active"])]),_:1}),e(L,{xs:24,sm:20},{default:a(()=>[x(o("div",Je,[t[24]||(t[24]=o("h2",{class:"header-font"},"数据看板",-1)),e(re,{gutter:20,class:"metrics-row"},{default:a(()=>[e(L,{xs:12,sm:6},{default:a(()=>[e(y,{shadow:"hover"},{default:a(()=>[o("div",Xe,[o("div",Ye,p(m.value.user_count),1),t[19]||(t[19]=o("div",{class:"metric-label"},"总用户数",-1))])]),_:1})]),_:1}),e(L,{xs:12,sm:6},{default:a(()=>[e(y,{shadow:"hover"},{default:a(()=>[o("div",Ze,[o("div",et,p(m.value.active_user_count),1),t[20]||(t[20]=o("div",{class:"metric-label"},"活跃用户",-1))])]),_:1})]),_:1}),e(L,{xs:12,sm:6},{default:a(()=>[e(y,{shadow:"hover"},{default:a(()=>[o("div",tt,[o("div",at,p(m.value.essay_count),1),t[21]||(t[21]=o("div",{class:"metric-label"},"作文提交量",-1))])]),_:1})]),_:1}),e(L,{xs:12,sm:6},{default:a(()=>[e(y,{shadow:"hover"},{default:a(()=>[o("div",lt,[o("div",st,p(m.value.token_usage.total),1),t[22]||(t[22]=o("div",{class:"metric-label"},"Token使用总量",-1))])]),_:1})]),_:1})]),_:1}),e(y,{shadow:"never",class:"token-card"},{default:a(()=>[t[23]||(t[23]=o("h3",{class:"header-font"},"Token使用情况",-1)),e(ze,{column:_.value,border:""},{default:a(()=>[e(X,{label:"今日使用"},{default:a(()=>[r(p(m.value.token_usage.today),1)]),_:1}),e(X,{label:"本月使用"},{default:a(()=>[r(p(m.value.token_usage.this_month),1)]),_:1}),e(X,{label:"总使用量"},{default:a(()=>[r(p(m.value.token_usage.total),1)]),_:1})]),_:1},8,["column"])]),_:1}),t[25]||(t[25]=o("p",{class:"dashboard-note"},"活跃用户：统计最近 7 天内有过登录的用户。",-1))],512),[[R,u.value==="dashboard"]]),x(o("div",ot,[t[29]||(t[29]=o("h2",{class:"header-font"},"用户管理",-1)),e(y,{shadow:"never"},{default:a(()=>[o("div",nt,[e(ce,{modelValue:j.value,"onUpdate:modelValue":t[0]||(t[0]=l=>j.value=l),placeholder:"搜索用户...",class:"search-input",clearable:"",onKeyup:Me(D,["enter"])},{prefix:a(()=>[e(w,null,{default:a(()=>[e(E(qe))]),_:1})]),_:1},8,["modelValue"]),e(F,{modelValue:N.value,"onUpdate:modelValue":t[1]||(t[1]=l=>N.value=l),placeholder:"角色",class:"search-select",clearable:""},{default:a(()=>[e(b,{label:"学生",value:"student"}),e(b,{label:"管理员",value:"admin"})]),_:1},8,["modelValue"]),e(F,{modelValue:P.value,"onUpdate:modelValue":t[2]||(t[2]=l=>P.value=l),placeholder:"状态",class:"search-select",clearable:""},{default:a(()=>[e(b,{label:"正常",value:"active"}),e(b,{label:"禁用",value:"disabled"})]),_:1},8,["modelValue"]),e(g,{type:"primary",onClick:D},{default:a(()=>[...t[26]||(t[26]=[r("搜索",-1)])]),_:1})]),o("div",ut,[x((z(),q(Z,{data:B.value,style:{width:"100%","margin-top":"20px"}},{default:a(()=>[e(c,{prop:"id",label:"ID",width:"80"}),e(c,{prop:"nickname",label:"昵称"}),e(c,{prop:"email",label:"邮箱"}),e(c,{prop:"role",label:"角色",width:"100"},{default:a(({row:l})=>[e(Y,{type:l.role==="admin"?"danger":"primary"},{default:a(()=>[r(p(l.role==="admin"?"管理员":"学生"),1)]),_:2},1032,["type"])]),_:1}),e(c,{prop:"status",label:"状态",width:"100"},{default:a(({row:l})=>[e(Y,{type:l.status==="active"?"success":"info"},{default:a(()=>[r(p(l.status==="active"?"正常":"禁用"),1)]),_:2},1032,["type"])]),_:1}),e(c,{prop:"ink_drops",label:"墨滴",width:"90",align:"center"},{default:a(({row:l})=>[r(p(l.ink_drops??0),1)]),_:1}),e(c,{label:"操作",width:"260"},{default:a(({row:l})=>[e(g,{type:"primary",text:"",onClick:ae=>be(l)},{default:a(()=>[...t[27]||(t[27]=[r("编辑",-1)])]),_:1},8,["onClick"]),e(g,{type:"primary",text:"",onClick:ae=>ke(l)},{default:a(()=>[...t[28]||(t[28]=[r("添加墨滴",-1)])]),_:1},8,["onClick"]),e(g,{type:l.status==="active"?"warning":"success",text:"",onClick:ae=>ye(l)},{default:a(()=>[r(p(l.status==="active"?"禁用":"启用"),1)]),_:2},1032,["type","onClick"])]),_:1})]),_:1},8,["data"])),[[te,f.value]])]),e(Ie,{"current-page":A.value,"onUpdate:currentPage":t[3]||(t[3]=l=>A.value=l),"page-size":K.value,"onUpdate:pageSize":t[4]||(t[4]=l=>K.value=l),total:oe.value,layout:"total, prev, pager, next",style:{"margin-top":"20px"},onCurrentChange:D},null,8,["current-page","page-size","total"])]),_:1})],512),[[R,u.value==="users"]]),x(o("div",dt,[t[31]||(t[31]=o("h2",{class:"header-font"},"内容管理",-1)),e(y,{shadow:"never"},{default:a(()=>[o("div",it,[x((z(),q(Z,{data:ne.value,class:"admin-table",style:{width:"100%"}},{default:a(()=>[e(c,{prop:"id",label:"ID",width:"80"}),e(c,{prop:"target_type",label:"类型",width:"120"}),e(c,{prop:"target_id",label:"目标ID",width:"100"}),e(c,{prop:"reason",label:"原因"}),e(c,{prop:"status",label:"状态",width:"100"},{default:a(({row:l})=>[e(Y,{type:l.status==="resolved"?"success":"warning"},{default:a(()=>[r(p(l.status==="resolved"?"已处理":"待处理"),1)]),_:2},1032,["type"])]),_:1}),e(c,{label:"操作",width:"150"},{default:a(({row:l})=>[l.status==="open"?(z(),q(g,{key:0,type:"success",text:"",onClick:ae=>xe(l)},{default:a(()=>[...t[30]||(t[30]=[r(" 标记已处理 ",-1)])]),_:1},8,["onClick"])):se("",!0)]),_:1})]),_:1},8,["data"])),[[te,O.value]])])]),_:1})],512),[[R,u.value==="content"]]),x(o("div",rt,[t[35]||(t[35]=o("h2",{class:"header-font"},"生成兑换码",-1)),e(y,{shadow:"never"},{default:a(()=>[e(ee,{model:h.value,"label-width":"80px",class:"redeem-form"},{default:a(()=>[e(S,{label:"类型"},{default:a(()=>[e(F,{modelValue:h.value.kind,"onUpdate:modelValue":t[5]||(t[5]=l=>h.value.kind=l),placeholder:"选择类型"},{default:a(()=>[e(b,{label:"10次卡",value:"quota_10"}),e(b,{label:"月卡",value:"month"}),e(b,{label:"年卡",value:"year"})]),_:1},8,["modelValue"])]),_:1}),e(S,{label:"数量"},{default:a(()=>[e(me,{modelValue:h.value.count,"onUpdate:modelValue":t[6]||(t[6]=l=>h.value.count=l),min:1,max:100},null,8,["modelValue"])]),_:1}),e(S,null,{default:a(()=>[e(g,{type:"primary",loading:H.value,onClick:Ve},{default:a(()=>[...t[32]||(t[32]=[r(" 生成 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),de.value.length?(z(),le("div",ct,[o("div",mt,[e(g,{size:"small",onClick:Ce},{default:a(()=>[...t[33]||(t[33]=[r("复制全部",-1)])]),_:1}),e(g,{size:"small",onClick:Ue},{default:a(()=>[...t[34]||(t[34]=[r("下载 txt",-1)])]),_:1})]),e(ce,{modelValue:U.value,"onUpdate:modelValue":t[7]||(t[7]=l=>U.value=l),type:"textarea",rows:10,readonly:"",class:"redeem-codes-textarea"},null,8,["modelValue"])])):se("",!0)]),_:1})],512),[[R,u.value==="redemption-codes"]]),x(o("div",vt,[t[36]||(t[36]=o("h2",{class:"header-font"},"操作日志",-1)),e(y,{shadow:"never"},{default:a(()=>[o("div",pt,[x((z(),q(Z,{data:ue.value,class:"admin-table",style:{width:"100%"}},{default:a(()=>[e(c,{prop:"id",label:"ID",width:"80"}),e(c,{prop:"action",label:"操作"}),e(c,{prop:"target_type",label:"目标类型",width:"120"}),e(c,{prop:"target_id",label:"目标ID",width:"100"}),e(c,{prop:"ip",label:"IP",width:"150"}),e(c,{prop:"created_at",label:"时间",width:"180"},{default:a(({row:l})=>[r(p(new Date(l.created_at).toLocaleString()),1)]),_:1})]),_:1},8,["data"])),[[te,G.value]])])]),_:1})],512),[[R,u.value==="logs"]])]),_:1})]),_:1})]),e(ve,{modelValue:$.value,"onUpdate:modelValue":t[11]||(t[11]=l=>$.value=l),title:"编辑用户",width:"500px",class:"edit-user-dialog"},{footer:a(()=>[e(g,{onClick:t[10]||(t[10]=l=>$.value=!1)},{default:a(()=>[...t[37]||(t[37]=[r("取消",-1)])]),_:1}),e(g,{type:"primary",onClick:we},{default:a(()=>[...t[38]||(t[38]=[r("保存",-1)])]),_:1})]),default:a(()=>[e(ee,{model:C.value,"label-width":"100px"},{default:a(()=>[e(S,{label:"角色"},{default:a(()=>[e(F,{modelValue:C.value.role,"onUpdate:modelValue":t[8]||(t[8]=l=>C.value.role=l)},{default:a(()=>[e(b,{label:"学生",value:"student"}),e(b,{label:"管理员",value:"admin"})]),_:1},8,["modelValue"])]),_:1}),e(S,{label:"状态"},{default:a(()=>[e(F,{modelValue:C.value.status,"onUpdate:modelValue":t[9]||(t[9]=l=>C.value.status=l)},{default:a(()=>[e(b,{label:"正常",value:"active"}),e(b,{label:"禁用",value:"disabled"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),e(ve,{modelValue:T.value,"onUpdate:modelValue":t[14]||(t[14]=l=>T.value=l),title:"添加墨滴",width:"400px"},{footer:a(()=>[e(g,{onClick:t[13]||(t[13]=l=>T.value=!1)},{default:a(()=>[...t[40]||(t[40]=[r("取消",-1)])]),_:1}),e(g,{type:"primary",loading:Q.value,onClick:he},{default:a(()=>[...t[41]||(t[41]=[r("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[k.value?(z(),le("p",ft," 用户："+p(k.value.nickname||k.value.email)+"（ID: "+p(k.value.id)+"） ",1)):se("",!0),e(ee,{model:I.value,"label-width":"80px"},{default:a(()=>[e(S,{label:"数量"},{default:a(()=>[e(me,{modelValue:I.value.amount,"onUpdate:modelValue":t[12]||(t[12]=l=>I.value.amount=l),min:1,max:99999},null,8,["modelValue"])]),_:1}),t[39]||(t[39]=o("p",{class:"ink-drops-hint"},"请输入 1～99999",-1))]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),bt=je(_t,[["__scopeId","data-v-d5fb7ce4"]]);export{bt as default};
//# sourceMappingURL=Dashboard-DfmPs-f_.js.map
