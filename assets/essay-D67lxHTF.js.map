{"version":3,"file":"essay-D67lxHTF.js","sources":["../../src/api/essay.ts","../../src/stores/essay.ts"],"sourcesContent":["import request from '@/utils/request'\nimport type {\n  Essay,\n  EssayDetail,\n  Correction,\n  CorrectionStats,\n  SubmitEssayRequest,\n  SubmitEssayResponse,\n  Draft,\n} from '@/types/essay'\nimport type { PageResponse } from '@/types/api'\n\nfunction mapEssayFromApi(d: Record<string, unknown>): Essay {\n  return {\n    id: d.id as number,\n    user_id: d.user_id as number,\n    title: d.title as string | undefined,\n    prompt: d.prompt as string | undefined,\n    source_type: ((d.source_type as string) || 'text') as Essay['source_type'],\n    content_text: (d.content_text as string) || '',\n    word_count: (d.word_count as number) ?? 0,\n    paragraphs: (d.paragraphs as number) ?? 0,\n    status: (d.status as Essay['status']) || 'pending',\n    created_at: (d.created_at as string) ?? '',\n    updated_at: (d.updated_at as string) ?? '',\n  }\n}\n\nconst defaultCorrectionStats: CorrectionStats = {\n  word_count: 0,\n  paragraph_count: 0,\n  typo_count: 0,\n}\n\nfunction mapCorrectionFromApi(d: Record<string, unknown>): Correction {\n  const stats = d.stats\n  const statsObj =\n    typeof stats === 'string'\n      ? (JSON.parse(stats || '{}') as CorrectionStats)\n      : (stats as CorrectionStats)\n  return {\n    id: d.id as number,\n    essay_id: d.essay_id as number,\n    summary: (d.summary as string) ?? '',\n    stats: statsObj?.word_count != null ? statsObj : defaultCorrectionStats,\n    diff_html: (d.diff_html as string) ?? '',\n    raw_json: (typeof d.raw_json === 'string' ? JSON.parse(d.raw_json || '{}') : d.raw_json) ?? {},\n    model_name: (d.model_name as string) ?? '',\n    token_usage:\n      (typeof d.token_usage === 'string' ? JSON.parse(d.token_usage || '{}') : d.token_usage) ?? {},\n    created_at: (d.created_at as string) ?? '',\n    updated_at: (d.updated_at as string) ?? '',\n  }\n}\n\n// 提交作文：若有 file 需在调用前将内容转为 content_text\nexport async function submitEssay(data: SubmitEssayRequest): Promise<SubmitEssayResponse> {\n  let contentText = data.content_text ?? ''\n  if (data.file) {\n    contentText = await readFileAsText(data.file)\n  }\n  const res = await request.post<{ essay_id: number; status: string }>('/essays', {\n    title: data.title,\n    prompt: data.prompt,\n    content_text: contentText,\n    source_type: data.source_type || 'text',\n  })\n  return { essay_id: res.data.essay_id, status: res.data.status as SubmitEssayResponse['status'] }\n}\n\nfunction readFileAsText(file: File): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader()\n    reader.onload = (e) => resolve((e.target?.result as string) || '')\n    reader.onerror = () => reject(new Error('文件读取失败'))\n    reader.readAsText(file)\n  })\n}\n\n// 作文详情（含可选批改摘要）\nexport async function getEssay(id: number): Promise<EssayDetail> {\n  const res = await request.get<{\n    essay: Record<string, unknown>\n    correction_summary?: { summary: string; stats: string }\n  }>(`/essays/${id}`)\n  const essay = mapEssayFromApi(res.data.essay)\n  const detail: EssayDetail = { ...essay }\n  if (res.data.correction_summary) {\n    const cs = res.data.correction_summary\n    let stats: CorrectionStats = defaultCorrectionStats\n    try {\n      const parsed = typeof cs.stats === 'string' ? JSON.parse(cs.stats) : cs.stats\n      if (parsed && typeof parsed.word_count === 'number') {\n        stats = parsed as CorrectionStats\n      }\n    } catch {\n      /**/\n    }\n    detail.correction = {\n      id: 0,\n      essay_id: id,\n      summary: cs.summary,\n      stats,\n      diff_html: '',\n      raw_json: {},\n      model_name: '',\n      token_usage: {},\n      created_at: '',\n      updated_at: '',\n    }\n  }\n  return detail\n}\n\n// 批改结果\nexport async function getCorrection(id: number): Promise<Correction> {\n  const res = await request.get<Record<string, unknown>>(`/essays/${id}/correction`)\n  return mapCorrectionFromApi(res.data)\n}\n\n// 作文历史列表\nexport async function getEssayHistory(params: {\n  page?: number\n  size?: number\n  status?: string\n}): Promise<PageResponse<Essay>> {\n  const page = params.page ?? 1\n  const size = params.size ?? 10\n  const res = await request.get<{ list: Record<string, unknown>[]; total: number }>('/essays', {\n    params: { page, size, status: params.status },\n  })\n  const items = (res.data.list ?? []).map(mapEssayFromApi)\n  return { items, total: res.data.total ?? 0, page, size }\n}\n\n// 删除作文\nexport async function deleteEssay(id: number): Promise<void> {\n  await request.delete(`/essays/${id}`)\n}\n\n// 收藏作文\nexport async function favoriteEssay(\n  id: number,\n  targetType: 'essay' | 'correction' = 'essay'\n): Promise<void> {\n  await request.post(`/essays/${id}/favorite`, { target_type: targetType })\n}\n\n// 创建草稿\nexport async function createDraft(data: { title?: string; content_text: string }): Promise<Draft> {\n  const res = await request.post<{ draft_id: number }>('/drafts', data)\n  const getRes = await request.get<Record<string, unknown>>(`/drafts/${res.data.draft_id}`)\n  const d = getRes.data\n  return {\n    id: d.id as number,\n    user_id: d.user_id as number,\n    title: d.title as string | undefined,\n    content_text: (d.content_text as string) ?? '',\n    created_at: (d.created_at as string) ?? '',\n    updated_at: (d.updated_at as string) ?? '',\n  }\n}\n\n// 草稿列表\nexport async function getDrafts(params?: { page?: number; size?: number }): Promise<Draft[]> {\n  const page = params?.page ?? 1\n  const size = params?.size ?? 500\n  const res = await request.get<{ list: Record<string, unknown>[]; total: number }>('/drafts', {\n    params: { page, size },\n  })\n  const list = res.data.list ?? []\n  return list.map((d) => ({\n    id: d.id as number,\n    user_id: d.user_id as number,\n    title: d.title as string | undefined,\n    content_text: (d.content_text as string) ?? '',\n    created_at: (d.created_at as string) ?? '',\n    updated_at: (d.updated_at as string) ?? '',\n  }))\n}\n","import { defineStore } from 'pinia'\nimport { ref } from 'vue'\nimport type { Essay, EssayDetail, Correction, Draft } from '@/types/essay'\nimport * as essayApi from '@/api/essay'\n\nexport const useEssayStore = defineStore('essay', () => {\n  const currentEssay = ref<EssayDetail | null>(null)\n  const currentCorrection = ref<Correction | null>(null)\n  const history = ref<Essay[]>([])\n  const drafts = ref<Draft[]>([])\n  const loading = ref(false)\n\n  async function submitEssay(data: {\n    title?: string\n    prompt?: string\n    content_text?: string\n    file?: File\n    source_type: 'text' | 'docx' | 'image' | 'pdf'\n  }) {\n    loading.value = true\n    try {\n      const response = await essayApi.submitEssay(data)\n      const essay = await essayApi.getEssay(response.essay_id)\n      currentEssay.value = essay\n      return essay\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function fetchEssay(id: number) {\n    loading.value = true\n    try {\n      const essay = await essayApi.getEssay(id)\n      currentEssay.value = essay\n      if (essay.correction) {\n        currentCorrection.value = essay.correction\n      }\n      return essay\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function fetchCorrection(id: number) {\n    loading.value = true\n    try {\n      const correction = await essayApi.getCorrection(id)\n      currentCorrection.value = correction\n      return correction\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function fetchHistory(params?: { page?: number; size?: number; status?: string }) {\n    loading.value = true\n    try {\n      const response = await essayApi.getEssayHistory(params || {})\n      history.value = response.items\n      return response\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function deleteEssay(id: number) {\n    await essayApi.deleteEssay(id)\n    await fetchHistory()\n  }\n\n  async function favoriteEssay(id: number) {\n    await essayApi.favoriteEssay(id)\n  }\n\n  async function fetchDrafts() {\n    loading.value = true\n    try {\n      const draftList = await essayApi.getDrafts()\n      drafts.value = draftList\n      return draftList\n    } finally {\n      loading.value = false\n    }\n  }\n\n  async function createDraft(data: { title?: string; content_text: string }) {\n    const draft = await essayApi.createDraft(data)\n    await fetchDrafts()\n    return draft\n  }\n\n  function clearCurrent() {\n    currentEssay.value = null\n    currentCorrection.value = null\n  }\n\n  return {\n    currentEssay,\n    currentCorrection,\n    history,\n    drafts,\n    loading,\n    submitEssay,\n    fetchEssay,\n    fetchCorrection,\n    fetchHistory,\n    deleteEssay,\n    favoriteEssay,\n    fetchDrafts,\n    createDraft,\n    clearCurrent,\n  }\n})\n"],"names":["mapEssayFromApi","d","defaultCorrectionStats","mapCorrectionFromApi","stats","statsObj","submitEssay","data","contentText","readFileAsText","res","request","file","resolve","reject","reader","e","getEssay","id","detail","cs","parsed","getCorrection","getEssayHistory","params","page","size","deleteEssay","favoriteEssay","targetType","createDraft","getDrafts","useEssayStore","defineStore","currentEssay","ref","currentCorrection","history","drafts","loading","response","essayApi.submitEssay","essay","essayApi.getEssay","fetchEssay","fetchCorrection","correction","essayApi.getCorrection","fetchHistory","essayApi.getEssayHistory","essayApi.deleteEssay","essayApi.favoriteEssay","fetchDrafts","draftList","essayApi.getDrafts","draft","essayApi.createDraft","clearCurrent"],"mappings":"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"}