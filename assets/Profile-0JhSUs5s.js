import{V as q,d as Le,u as Re,l as c,m as j,J as te,n as Te,Q as Ae,K as Be,c as F,a as w,e as a,w as l,r as i,j as C,g as o,D as u,f as Ne,b as se,s as ue,S as Ke,q as je,y as ze,E as r,A as Je,o as p,_ as Qe}from"./index-Ce45WVGD.js";import{m as ce}from"./format-CCCypCfS.js";import{u as We,j as Ge}from"./essay-DD6aH8xv.js";import{u as He,g as Oe}from"./classic-CFnwBeaU.js";async function me(h){await q.patch("/users/me",h);const n=(await q.get("/users/me")).data,k=n.membership;return{id:n.id,email:n.email,phone:n.phone,nickname:n.nickname||"",avatar:n.avatar,role:n.role,status:n.status,created_at:n.created_at??"",updated_at:n.updated_at??"",...k&&{membership:{id:0,user_id:n.id,plan:k.plan,started_at:"",expired_at:k.expired_at,status:k.status,quota_remaining:k.quota_remaining??void 0,created_at:"",updated_at:""}}}}async function fe(){return(await q.get("/memberships/me")).data}async function Xe(h){return(await q.post("/memberships/redeem",{code:h})).data}async function pe(){await q.post("/users/me/send-email-code")}async function Ye(h,S){await q.post("/users/me/cancel",{password:h,email_code:S})}async function Ze(h){return(await q.post("/feedbacks",h)).data}const ea={class:"profile-page"},aa={class:"container"},la={class:"avatar-section"},ta={class:"header-font"},sa={class:"email"},oa={key:0,class:"password-email-hint"},na={class:"password-code-row"},ra={key:0,class:"membership-info"},da={key:1,class:"membership-info"},ia={class:"membership-redeem"},ua={class:"redeem-row"},ca={key:0,class:"table-scroll-wrap"},ma={key:0,class:"table-scroll-wrap"},fa={class:"security-section"},pa={key:0,class:"cancel-email-hint"},va={class:"cancel-code-row"},_a=Le({__name:"Profile",setup(h){const S=Je(),n=Re(),k=c("info"),z=c(),J=c(),m=c(null),R=c(""),Q=c(!1),f=j({nickname:"",email:"",phone:"",avatar:""}),d=j({email_code:"",oldPassword:"",newPassword:"",confirmPassword:""}),W=te(()=>n.user?.email?ce(n.user.email):""),G=te(()=>n.user?.email?ce(n.user.email):""),ve=te(()=>!!(m.value?.started_at&&m.value?.expired_at&&!String(m.value.expired_at).startsWith("0001"))),H=c(!1),P=c(0);let D=null;const b=j({content:"",contact:""}),T=c(!1),O=c(!1),X=c(!1),x=c(0);let M=null;const v=j({password:"",email_code:""}),$=c([]),A=c(!1),Y=c(null),I=c([]),B=c(!1),Z=c(null),_e={nickname:[{required:!0,message:"请输入昵称",trigger:"blur"},{min:2,max:20,message:"昵称长度在2到20个字符",trigger:"blur"}]},we={oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(s,e,N)=>{e!==d.newPassword?N(new Error("两次输入的密码不一致")):N()},trigger:"blur"}]};async function ye(){if(!(P.value>0)){H.value=!0;try{await pe(),r.success(`验证码已发送至 ${W.value}，请查收`),P.value=60,D=setInterval(()=>{P.value--,P.value<=0&&D&&(clearInterval(D),D=null)},1e3)}catch(s){r.error(s.message||"发送失败")}finally{H.value=!1}}}Te(async()=>{n.user&&(f.nickname=n.user.nickname,f.email=n.user.email||"",f.phone=n.user.phone||"",f.avatar=n.user.avatar||""),await Ve()}),Ae(k,s=>{s==="favorites"&&ge(),s==="classicFavorites"&&he()});async function ge(){A.value=!0;try{$.value=await Ge()}catch{$.value=[]}finally{A.value=!1}}async function be(s){Y.value=s.essay_id;try{await We(s.essay_id),$.value=$.value.filter(e=>e.essay_id!==s.essay_id),r.success("已取消收藏")}catch(e){r.error(e.message||"取消收藏失败")}finally{Y.value=null}}async function he(){B.value=!0;try{I.value=await Oe()}catch{I.value=[]}finally{B.value=!1}}async function ke(s){Z.value=s.id;try{await He(s.id),I.value=I.value.filter(e=>e.id!==s.id),r.success("已取消收藏")}catch(e){r.error(e.message||"取消收藏失败")}finally{Z.value=null}}async function Ve(){try{m.value=await fe()}catch{}}async function Ce(){z.value&&await z.value.validate(async s=>{if(s)try{await me({nickname:f.nickname}),await n.fetchUser(),r.success("更新成功")}catch(e){r.error(e.message||"更新失败")}})}async function Pe(){if(J.value){if(!d.email_code.trim()||d.email_code.length!==4){r.warning("请输入4位验证码");return}await J.value.validate(async s=>{if(s)try{await me({password_old:d.oldPassword,password_new:d.newPassword,email_code:d.email_code}),r.success("密码修改成功"),d.email_code="",d.oldPassword="",d.newPassword="",d.confirmPassword=""}catch(e){r.error(e.message||"密码修改失败")}})}}async function xe(){const s=R.value.trim();if(s){Q.value=!0;try{await Xe(s),await n.fetchUser(),m.value=await fe(),R.value="",r.success("兑换成功")}catch(e){r.error(e.message||"兑换失败")}finally{Q.value=!1}}}async function Ue(){if(!b.content.trim()){r.warning("请输入反馈内容");return}try{await Ze({content:b.content.trim(),contact:b.contact.trim()||void 0}),r.success("反馈提交成功，感谢您的建议！"),b.content="",b.contact=""}catch(s){r.error(s.message||"提交失败")}}function Fe(){v.password="",v.email_code=""}function qe(){v.password="",v.email_code="",T.value=!0}async function Se(){if(!(x.value>0)){X.value=!0;try{await pe(),r.success(`验证码已发送至 ${G.value}，请查收`),x.value=60,M=setInterval(()=>{x.value--,x.value<=0&&M&&(clearInterval(M),M=null)},1e3)}catch(s){r.error(s.message||"发送失败")}finally{X.value=!1}}}Be(()=>{M&&clearInterval(M),D&&clearInterval(D)});async function ee(){if(!v.password.trim()){r.warning("请输入当前密码");return}if(!v.email_code.trim()||v.email_code.length!==4){r.warning("请输入4位验证码");return}O.value=!0;try{await Ye(v.password,v.email_code),n.clearLocal(),T.value=!1,r.success("账号已注销"),S.replace("/")}catch(s){r.error(s.message||"注销失败")}finally{O.value=!1}}return(s,e)=>{const N=i("el-avatar"),ae=i("el-tag"),V=i("el-card"),oe=i("el-col"),y=i("el-input"),_=i("el-form-item"),g=i("el-button"),K=i("el-form"),U=i("el-tab-pane"),E=i("el-descriptions-item"),ne=i("el-descriptions"),le=i("el-empty"),re=i("router-link"),L=i("el-table-column"),de=i("el-table"),De=i("el-alert"),Me=i("el-dialog"),$e=i("el-tabs"),Ie=i("el-row"),ie=Ke("loading");return p(),F("div",ea,[w("div",aa,[a(Ie,{gutter:20},{default:l(()=>[a(oe,{xs:24,sm:24,md:6,lg:6},{default:l(()=>[a(V,{shadow:"never",class:"profile-card"},{default:l(()=>[w("div",la,[a(N,{size:100,src:f.avatar},{default:l(()=>[o(u(f.nickname?.[0]),1)]),_:1},8,["src"]),w("h3",ta,u(f.nickname),1),w("p",sa,u(f.email),1),Ne(n).isMember?(p(),C(ae,{key:0,type:"success"},{default:l(()=>[...e[16]||(e[16]=[o("会员",-1)])]),_:1})):(p(),C(ae,{key:1,type:"info"},{default:l(()=>[...e[17]||(e[17]=[o("普通用户",-1)])]),_:1}))])]),_:1})]),_:1}),a(oe,{xs:24,sm:24,md:18,lg:18},{default:l(()=>[a($e,{modelValue:k.value,"onUpdate:modelValue":e[15]||(e[15]=t=>k.value=t),class:"profile-tabs"},{default:l(()=>[a(U,{label:"个人信息",name:"info"},{default:l(()=>[a(V,{shadow:"never"},{default:l(()=>[a(K,{model:f,rules:_e,ref_key:"formRef",ref:z,class:"profile-form","label-width":"100px"},{default:l(()=>[a(_,{label:"昵称",prop:"nickname"},{default:l(()=>[a(y,{modelValue:f.nickname,"onUpdate:modelValue":e[0]||(e[0]=t=>f.nickname=t)},null,8,["modelValue"])]),_:1}),a(_,{label:"邮箱"},{default:l(()=>[a(y,{modelValue:f.email,"onUpdate:modelValue":e[1]||(e[1]=t=>f.email=t),disabled:""},null,8,["modelValue"])]),_:1}),a(_,{label:"手机号"},{default:l(()=>[a(y,{modelValue:f.phone,"onUpdate:modelValue":e[2]||(e[2]=t=>f.phone=t),disabled:""},null,8,["modelValue"])]),_:1}),a(_,null,{default:l(()=>[a(g,{type:"primary",onClick:Ce},{default:l(()=>[...e[18]||(e[18]=[o("保存",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(U,{label:"修改密码",name:"password"},{default:l(()=>[a(V,{shadow:"never"},{default:l(()=>[W.value?(p(),F("p",oa," 将向您的邮箱 "+u(W.value)+" 发送验证码 ",1)):se("",!0),a(K,{model:d,rules:we,ref_key:"passwordFormRef",ref:J,class:"profile-form","label-width":"100px"},{default:l(()=>[a(_,{label:"验证码",required:""},{default:l(()=>[w("div",na,[a(y,{modelValue:d.email_code,"onUpdate:modelValue":e[3]||(e[3]=t=>d.email_code=t),placeholder:"4位验证码",maxlength:"4",class:"password-code-input"},null,8,["modelValue"]),a(g,{type:"primary",disabled:P.value>0,loading:H.value,onClick:ye},{default:l(()=>[o(u(P.value>0?`${P.value}s 后重试`:"获取验证码"),1)]),_:1},8,["disabled","loading"])])]),_:1}),a(_,{label:"原密码",prop:"oldPassword"},{default:l(()=>[a(y,{modelValue:d.oldPassword,"onUpdate:modelValue":e[4]||(e[4]=t=>d.oldPassword=t),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(_,{label:"新密码",prop:"newPassword"},{default:l(()=>[a(y,{modelValue:d.newPassword,"onUpdate:modelValue":e[5]||(e[5]=t=>d.newPassword=t),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(_,{label:"确认密码",prop:"confirmPassword"},{default:l(()=>[a(y,{modelValue:d.confirmPassword,"onUpdate:modelValue":e[6]||(e[6]=t=>d.confirmPassword=t),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),a(_,null,{default:l(()=>[a(g,{type:"primary",onClick:Pe},{default:l(()=>[...e[19]||(e[19]=[o("修改密码",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(U,{label:"会员信息",name:"membership"},{default:l(()=>[a(V,{shadow:"never"},{default:l(()=>[e[22]||(e[22]=w("div",{class:"membership-intro"},[w("p",null," 会员需通过站外购买获得，购买后将获得兑换码。如有需要请联系客服或查看站内公告获取购买方式与兑换码。 ")],-1)),ve.value&&m.value?(p(),F("div",ra,[a(ne,{column:1,border:""},{default:l(()=>[a(E,{label:"会员计划"},{default:l(()=>[o(u(m.value.plan),1)]),_:1}),a(E,{label:"状态"},{default:l(()=>[a(ae,{type:m.value.status==="active"?"success":"info"},{default:l(()=>[o(u(m.value.status==="active"?"有效":"已过期"),1)]),_:1},8,["type"])]),_:1}),a(E,{label:"开始时间"},{default:l(()=>[o(u(new Date(m.value.started_at).toLocaleDateString()),1)]),_:1}),a(E,{label:"到期时间"},{default:l(()=>[o(u(new Date(m.value.expired_at).toLocaleDateString()),1)]),_:1}),(m.value.quota_remaining??0)>0?(p(),C(E,{key:0,label:"次数卡剩余"},{default:l(()=>[o(u(m.value.quota_remaining),1)]),_:1})):se("",!0)]),_:1})])):m.value&&(m.value.quota_remaining??0)>0?(p(),F("div",da,[a(ne,{column:1,border:""},{default:l(()=>[a(E,{label:"次数卡剩余"},{default:l(()=>[o(u(m.value.quota_remaining),1)]),_:1})]),_:1})])):(p(),C(le,{key:2,description:"您还不是会员"})),w("div",ia,[e[21]||(e[21]=w("div",{class:"redeem-label"},"兑换码",-1)),w("div",ua,[a(y,{modelValue:R.value,"onUpdate:modelValue":e[7]||(e[7]=t=>R.value=t),placeholder:"请输入兑换码",clearable:"",maxlength:"64",class:"redeem-input"},null,8,["modelValue"]),a(g,{type:"primary",loading:Q.value,disabled:!R.value.trim(),onClick:xe},{default:l(()=>[...e[20]||(e[20]=[o(" 兑换 ",-1)])]),_:1},8,["loading","disabled"])])])]),_:1})]),_:1}),a(U,{label:"收藏夹",name:"favorites"},{default:l(()=>[a(V,{shadow:"never"},{default:l(()=>[$.value.length||A.value?(p(),F("div",ca,[ue((p(),C(de,{data:$.value,class:"profile-table",style:{width:"100%"}},{default:l(()=>[a(L,{prop:"title",label:"标题","min-width":"120"},{default:l(({row:t})=>[a(re,{to:`/essay/${t.essay_id}`,class:"table-link"},{default:l(()=>[o(u(t.title||"无标题"),1)]),_:2},1032,["to"])]),_:1}),a(L,{label:"收藏时间","min-width":"150"},{default:l(({row:t})=>[o(u(new Date(t.essay_created_at).toLocaleString()),1)]),_:1}),a(L,{label:"操作","min-width":"100",align:"right"},{default:l(({row:t})=>[a(g,{type:"danger",text:"",loading:Y.value===t.essay_id,onClick:Ee=>be(t)},{default:l(()=>[...e[23]||(e[23]=[o(" 取消收藏 ",-1)])]),_:1},8,["loading","onClick"])]),_:1})]),_:1},8,["data"])),[[ie,A.value]])])):(p(),C(le,{key:1,description:"暂无收藏"}))]),_:1})]),_:1}),a(U,{label:"素材收藏",name:"classicFavorites"},{default:l(()=>[a(V,{shadow:"never"},{default:l(()=>[I.value.length||B.value?(p(),F("div",ma,[ue((p(),C(de,{data:I.value,class:"profile-table",style:{width:"100%"}},{default:l(()=>[a(L,{label:"内容","min-width":"180"},{default:l(({row:t})=>[a(re,{to:`/classic/item/${t.id}`,class:"table-link"},{default:l(()=>[o(u(t.original_text?.slice(0,50))+u((t.original_text?.length??0)>50?"…":""),1)]),_:2},1032,["to"])]),_:1}),a(L,{label:"作者/朝代","min-width":"100"},{default:l(({row:t})=>[o(u(t.author)+" "+u(t.dynasty),1)]),_:1}),a(L,{label:"操作","min-width":"100",align:"right"},{default:l(({row:t})=>[a(g,{type:"danger",text:"",loading:Z.value===t.id,onClick:Ee=>ke(t)},{default:l(()=>[...e[24]||(e[24]=[o(" 取消收藏 ",-1)])]),_:1},8,["loading","onClick"])]),_:1})]),_:1},8,["data"])),[[ie,B.value]])])):(p(),C(le,{key:1,description:"暂无素材收藏"},{default:l(()=>[a(g,{type:"primary",onClick:e[8]||(e[8]=t=>s.$router.push("/classic"))},{default:l(()=>[...e[25]||(e[25]=[o("去素材中心",-1)])]),_:1})]),_:1}))]),_:1})]),_:1}),a(U,{label:"反馈建议",name:"feedback"},{default:l(()=>[a(V,{shadow:"never"},{default:l(()=>[a(K,{model:b,class:"profile-form","label-width":"100px"},{default:l(()=>[a(_,{label:"反馈内容"},{default:l(()=>[a(y,{modelValue:b.content,"onUpdate:modelValue":e[9]||(e[9]=t=>b.content=t),type:"textarea",rows:6,placeholder:"请输入您的反馈或建议..."},null,8,["modelValue"])]),_:1}),a(_,{label:"联系方式"},{default:l(()=>[a(y,{modelValue:b.contact,"onUpdate:modelValue":e[10]||(e[10]=t=>b.contact=t),placeholder:"邮箱或手机号（可选）"},null,8,["modelValue"])]),_:1}),a(_,null,{default:l(()=>[a(g,{type:"primary",onClick:Ue},{default:l(()=>[...e[26]||(e[26]=[o("提交反馈",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),a(U,{label:"账号安全",name:"security"},{default:l(()=>[a(V,{shadow:"never"},{default:l(()=>[w("div",fa,[e[28]||(e[28]=w("h4",null,"注销账号",-1)),e[29]||(e[29]=w("p",{class:"security-desc"},"注销后账号及关联数据将被删除且无法恢复，请谨慎操作。",-1)),a(g,{type:"danger",plain:"",onClick:qe},{default:l(()=>[...e[27]||(e[27]=[o("申请注销账号",-1)])]),_:1})])]),_:1}),a(Me,{modelValue:T.value,"onUpdate:modelValue":e[14]||(e[14]=t=>T.value=t),title:"注销账号",width:"400px",class:"cancel-account-dialog","close-on-click-modal":!1,onClosed:Fe},{footer:l(()=>[a(g,{onClick:e[13]||(e[13]=t=>T.value=!1)},{default:l(()=>[...e[31]||(e[31]=[o("取消",-1)])]),_:1}),a(g,{type:"danger",loading:O.value,onClick:ee},{default:l(()=>[...e[32]||(e[32]=[o(" 确认注销 ",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(De,{class:"tip-alert cancel-dialog-tip",title:"提示",type:"warning",closable:!1,"show-icon":""},{default:l(()=>[...e[30]||(e[30]=[o(" 注销后账号及关联数据将被删除且无法恢复，请谨慎操作。请先获取验证码，再输入当前密码与验证码并点击「确认注销」。 ",-1)])]),_:1}),G.value?(p(),F("p",pa," 将向您的邮箱 "+u(G.value)+" 发送验证码 ",1)):se("",!0),a(K,{model:v,"label-width":"80px",onSubmit:je(ee,["prevent"])},{default:l(()=>[a(_,{label:"验证码",required:""},{default:l(()=>[w("div",va,[a(y,{modelValue:v.email_code,"onUpdate:modelValue":e[11]||(e[11]=t=>v.email_code=t),placeholder:"4位验证码",maxlength:"4","show-word-limit":"",class:"cancel-code-input"},null,8,["modelValue"]),a(g,{type:"primary",disabled:x.value>0,loading:X.value,onClick:Se},{default:l(()=>[o(u(x.value>0?`${x.value}s 后重试`:"获取验证码"),1)]),_:1},8,["disabled","loading"])])]),_:1}),a(_,{label:"当前密码",required:""},{default:l(()=>[a(y,{modelValue:v.password,"onUpdate:modelValue":e[12]||(e[12]=t=>v.password=t),type:"password","show-password":"",placeholder:"请输入当前密码以确认",onKeyup:ze(ee,["enter"])},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})])])}}}),ka=Qe(_a,[["__scopeId","data-v-65b987cb"]]);export{ka as default};
//# sourceMappingURL=Profile-0JhSUs5s.js.map
