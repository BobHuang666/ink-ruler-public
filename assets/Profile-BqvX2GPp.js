import{V as F,d as Ie,u as Ee,l as m,m as K,J as re,n as qe,Q as Le,K as Re,c as q,a as g,e,w as l,r as i,j as C,g as n,D as u,f as de,b as ae,s as ie,S as Ae,q as Be,y as Ne,E as r,A as Te,o as _,_ as Ke}from"./index-BN8HEDSF.js";import{m as ue}from"./format-CCCypCfS.js";import{u as je,j as ze}from"./essay-CN05qPJr.js";import{u as Je,g as Qe}from"./classic-HeyjI9HZ.js";async function ce(b){await F.patch("/users/me",b);const o=(await F.get("/users/me")).data,h=o.membership;return{id:o.id,email:o.email,phone:o.phone,nickname:o.nickname||"",avatar:o.avatar,role:o.role,status:o.status,created_at:o.created_at??"",updated_at:o.updated_at??"",...h&&{membership:{id:0,user_id:o.id,plan:h.plan,started_at:"",expired_at:h.expired_at,status:h.status,created_at:"",updated_at:""}}}}async function Ge(){return(await F.get("/memberships/me")).data}async function He(b){return(await F.post("/memberships/purchase",{plan:b})).data}async function me(){await F.post("/users/me/send-email-code")}async function Oe(b,S){await F.post("/users/me/cancel",{password:b,email_code:S})}async function We(b){return(await F.post("/feedbacks",b)).data}const Xe={class:"profile-page"},Ye={class:"container"},Ze={class:"avatar-section"},ea={class:"header-font"},aa={class:"email"},la={key:0,class:"password-email-hint"},ta={class:"password-code-row"},sa={key:0,class:"membership-info"},oa={class:"membership-actions"},na={key:0,class:"table-scroll-wrap"},ra={key:0,class:"table-scroll-wrap"},da={class:"security-section"},ia={key:0,class:"cancel-email-hint"},ua={class:"cancel-code-row"},ca=Ie({__name:"Profile",setup(b){const S=Te(),o=Ee(),h=m("info"),j=m(),z=m(),k=m(null),c=K({nickname:"",email:"",phone:"",avatar:""}),d=K({email_code:"",oldPassword:"",newPassword:"",confirmPassword:""}),J=re(()=>o.user?.email?ue(o.user.email):""),Q=re(()=>o.user?.email?ue(o.user.email):""),G=m(!1),P=m(0);let D=null;const y=K({content:"",contact:""}),L=m(!1),H=m(!1),O=m(!1),x=m(0);let M=null;const f=K({password:"",email_code:""}),$=m([]),R=m(!1),W=m(null),I=m([]),A=m(!1),X=m(null),fe={nickname:[{required:!0,message:"请输入昵称",trigger:"blur"},{min:2,max:20,message:"昵称长度在2到20个字符",trigger:"blur"}]},pe={oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(s,a,B)=>{a!==d.newPassword?B(new Error("两次输入的密码不一致")):B()},trigger:"blur"}]};async function _e(){if(!(P.value>0)){G.value=!0;try{await me(),r.success(`验证码已发送至 ${J.value}，请查收`),P.value=60,D=setInterval(()=>{P.value--,P.value<=0&&D&&(clearInterval(D),D=null)},1e3)}catch(s){r.error(s.message||"发送失败")}finally{G.value=!1}}}qe(async()=>{o.user&&(c.nickname=o.user.nickname,c.email=o.user.email||"",c.phone=o.user.phone||"",c.avatar=o.user.avatar||""),await be()}),Le(h,s=>{s==="favorites"&&ve(),s==="classicFavorites"&&ye()});async function ve(){R.value=!0;try{$.value=await ze()}catch{$.value=[]}finally{R.value=!1}}async function we(s){W.value=s.essay_id;try{await je(s.essay_id),$.value=$.value.filter(a=>a.essay_id!==s.essay_id),r.success("已取消收藏")}catch(a){r.error(a.message||"取消收藏失败")}finally{W.value=null}}async function ye(){A.value=!0;try{I.value=await Qe()}catch{I.value=[]}finally{A.value=!1}}async function ge(s){X.value=s.id;try{await Je(s.id),I.value=I.value.filter(a=>a.id!==s.id),r.success("已取消收藏")}catch(a){r.error(a.message||"取消收藏失败")}finally{X.value=null}}async function be(){try{k.value=await Ge()}catch{}}async function he(){j.value&&await j.value.validate(async s=>{if(s)try{await ce({nickname:c.nickname}),await o.fetchUser(),r.success("更新成功")}catch(a){r.error(a.message||"更新失败")}})}async function ke(){if(z.value){if(!d.email_code.trim()||d.email_code.length!==4){r.warning("请输入4位验证码");return}await z.value.validate(async s=>{if(s)try{await ce({password_old:d.oldPassword,password_new:d.newPassword,email_code:d.email_code}),r.success("密码修改成功"),d.email_code="",d.oldPassword="",d.newPassword="",d.confirmPassword=""}catch(a){r.error(a.message||"密码修改失败")}})}}async function le(){try{const s=await He("student");k.value=s,await o.fetchUser(),r.success("会员购买成功")}catch(s){r.error(s.message||"购买失败")}}async function Ve(){if(!y.content.trim()){r.warning("请输入反馈内容");return}try{await We({content:y.content.trim(),contact:y.contact.trim()||void 0}),r.success("反馈提交成功，感谢您的建议！"),y.content="",y.contact=""}catch(s){r.error(s.message||"提交失败")}}function Ce(){f.password="",f.email_code=""}function Pe(){f.password="",f.email_code="",L.value=!0}async function xe(){if(!(x.value>0)){O.value=!0;try{await me(),r.success(`验证码已发送至 ${Q.value}，请查收`),x.value=60,M=setInterval(()=>{x.value--,x.value<=0&&M&&(clearInterval(M),M=null)},1e3)}catch(s){r.error(s.message||"发送失败")}finally{O.value=!1}}}Re(()=>{M&&clearInterval(M),D&&clearInterval(D)});async function Y(){if(!f.password.trim()){r.warning("请输入当前密码");return}if(!f.email_code.trim()||f.email_code.length!==4){r.warning("请输入4位验证码");return}H.value=!0;try{await Oe(f.password,f.email_code),o.clearLocal(),L.value=!1,r.success("账号已注销"),S.replace("/")}catch(s){r.error(s.message||"注销失败")}finally{H.value=!1}}return(s,a)=>{const B=i("el-avatar"),Z=i("el-tag"),V=i("el-card"),te=i("el-col"),w=i("el-input"),p=i("el-form-item"),v=i("el-button"),N=i("el-form"),U=i("el-tab-pane"),T=i("el-descriptions-item"),Ue=i("el-descriptions"),ee=i("el-empty"),se=i("router-link"),E=i("el-table-column"),oe=i("el-table"),Fe=i("el-alert"),Se=i("el-dialog"),De=i("el-tabs"),Me=i("el-row"),ne=Ae("loading");return _(),q("div",Xe,[g("div",Ye,[e(Me,{gutter:20},{default:l(()=>[e(te,{xs:24,sm:24,md:6,lg:6},{default:l(()=>[e(V,{shadow:"never",class:"profile-card"},{default:l(()=>[g("div",Ze,[e(B,{size:100,src:c.avatar},{default:l(()=>[n(u(c.nickname?.[0]),1)]),_:1},8,["src"]),g("h3",ea,u(c.nickname),1),g("p",aa,u(c.email),1),de(o).isMember?(_(),C(Z,{key:0,type:"success"},{default:l(()=>[...a[15]||(a[15]=[n("会员",-1)])]),_:1})):(_(),C(Z,{key:1,type:"info"},{default:l(()=>[...a[16]||(a[16]=[n("普通用户",-1)])]),_:1}))])]),_:1})]),_:1}),e(te,{xs:24,sm:24,md:18,lg:18},{default:l(()=>[e(De,{modelValue:h.value,"onUpdate:modelValue":a[14]||(a[14]=t=>h.value=t),class:"profile-tabs"},{default:l(()=>[e(U,{label:"个人信息",name:"info"},{default:l(()=>[e(V,{shadow:"never"},{default:l(()=>[e(N,{model:c,rules:fe,ref_key:"formRef",ref:j,class:"profile-form","label-width":"100px"},{default:l(()=>[e(p,{label:"昵称",prop:"nickname"},{default:l(()=>[e(w,{modelValue:c.nickname,"onUpdate:modelValue":a[0]||(a[0]=t=>c.nickname=t)},null,8,["modelValue"])]),_:1}),e(p,{label:"邮箱"},{default:l(()=>[e(w,{modelValue:c.email,"onUpdate:modelValue":a[1]||(a[1]=t=>c.email=t),disabled:""},null,8,["modelValue"])]),_:1}),e(p,{label:"手机号"},{default:l(()=>[e(w,{modelValue:c.phone,"onUpdate:modelValue":a[2]||(a[2]=t=>c.phone=t),disabled:""},null,8,["modelValue"])]),_:1}),e(p,null,{default:l(()=>[e(v,{type:"primary",onClick:he},{default:l(()=>[...a[17]||(a[17]=[n("保存",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),e(U,{label:"修改密码",name:"password"},{default:l(()=>[e(V,{shadow:"never"},{default:l(()=>[J.value?(_(),q("p",la," 将向您的邮箱 "+u(J.value)+" 发送验证码 ",1)):ae("",!0),e(N,{model:d,rules:pe,ref_key:"passwordFormRef",ref:z,class:"profile-form","label-width":"100px"},{default:l(()=>[e(p,{label:"验证码",required:""},{default:l(()=>[g("div",ta,[e(w,{modelValue:d.email_code,"onUpdate:modelValue":a[3]||(a[3]=t=>d.email_code=t),placeholder:"4位验证码",maxlength:"4",class:"password-code-input"},null,8,["modelValue"]),e(v,{type:"primary",disabled:P.value>0,loading:G.value,onClick:_e},{default:l(()=>[n(u(P.value>0?`${P.value}s 后重试`:"获取验证码"),1)]),_:1},8,["disabled","loading"])])]),_:1}),e(p,{label:"原密码",prop:"oldPassword"},{default:l(()=>[e(w,{modelValue:d.oldPassword,"onUpdate:modelValue":a[4]||(a[4]=t=>d.oldPassword=t),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),e(p,{label:"新密码",prop:"newPassword"},{default:l(()=>[e(w,{modelValue:d.newPassword,"onUpdate:modelValue":a[5]||(a[5]=t=>d.newPassword=t),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),e(p,{label:"确认密码",prop:"confirmPassword"},{default:l(()=>[e(w,{modelValue:d.confirmPassword,"onUpdate:modelValue":a[6]||(a[6]=t=>d.confirmPassword=t),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),e(p,null,{default:l(()=>[e(v,{type:"primary",onClick:ke},{default:l(()=>[...a[18]||(a[18]=[n("修改密码",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),e(U,{label:"会员信息",name:"membership"},{default:l(()=>[e(V,{shadow:"never"},{default:l(()=>[k.value?(_(),q("div",sa,[e(Ue,{column:1,border:""},{default:l(()=>[e(T,{label:"会员计划"},{default:l(()=>[n(u(k.value.plan),1)]),_:1}),e(T,{label:"状态"},{default:l(()=>[e(Z,{type:k.value.status==="active"?"success":"info"},{default:l(()=>[n(u(k.value.status==="active"?"有效":"已过期"),1)]),_:1},8,["type"])]),_:1}),e(T,{label:"开始时间"},{default:l(()=>[n(u(new Date(k.value.started_at).toLocaleDateString()),1)]),_:1}),e(T,{label:"到期时间"},{default:l(()=>[n(u(new Date(k.value.expired_at).toLocaleDateString()),1)]),_:1})]),_:1}),g("div",oa,[de(o).isMember?ae("",!0):(_(),C(v,{key:0,type:"primary",onClick:le},{default:l(()=>[...a[19]||(a[19]=[n(" 升级会员 ",-1)])]),_:1}))])])):(_(),C(ee,{key:1,description:"您还不是会员"},{default:l(()=>[e(v,{type:"primary",onClick:le},{default:l(()=>[...a[20]||(a[20]=[n("购买会员",-1)])]),_:1})]),_:1}))]),_:1})]),_:1}),e(U,{label:"收藏夹",name:"favorites"},{default:l(()=>[e(V,{shadow:"never"},{default:l(()=>[$.value.length||R.value?(_(),q("div",na,[ie((_(),C(oe,{data:$.value,class:"profile-table",style:{width:"100%"}},{default:l(()=>[e(E,{prop:"title",label:"标题","min-width":"120"},{default:l(({row:t})=>[e(se,{to:`/essay/${t.essay_id}`,class:"table-link"},{default:l(()=>[n(u(t.title||"无标题"),1)]),_:2},1032,["to"])]),_:1}),e(E,{label:"收藏时间","min-width":"150"},{default:l(({row:t})=>[n(u(new Date(t.essay_created_at).toLocaleString()),1)]),_:1}),e(E,{label:"操作","min-width":"100",align:"right"},{default:l(({row:t})=>[e(v,{type:"danger",text:"",loading:W.value===t.essay_id,onClick:$e=>we(t)},{default:l(()=>[...a[21]||(a[21]=[n(" 取消收藏 ",-1)])]),_:1},8,["loading","onClick"])]),_:1})]),_:1},8,["data"])),[[ne,R.value]])])):(_(),C(ee,{key:1,description:"暂无收藏"}))]),_:1})]),_:1}),e(U,{label:"素材收藏",name:"classicFavorites"},{default:l(()=>[e(V,{shadow:"never"},{default:l(()=>[I.value.length||A.value?(_(),q("div",ra,[ie((_(),C(oe,{data:I.value,class:"profile-table",style:{width:"100%"}},{default:l(()=>[e(E,{label:"内容","min-width":"180"},{default:l(({row:t})=>[e(se,{to:`/classic/item/${t.id}`,class:"table-link"},{default:l(()=>[n(u(t.original_text?.slice(0,50))+u((t.original_text?.length??0)>50?"…":""),1)]),_:2},1032,["to"])]),_:1}),e(E,{label:"作者/朝代","min-width":"100"},{default:l(({row:t})=>[n(u(t.author)+" "+u(t.dynasty),1)]),_:1}),e(E,{label:"操作","min-width":"100",align:"right"},{default:l(({row:t})=>[e(v,{type:"danger",text:"",loading:X.value===t.id,onClick:$e=>ge(t)},{default:l(()=>[...a[22]||(a[22]=[n(" 取消收藏 ",-1)])]),_:1},8,["loading","onClick"])]),_:1})]),_:1},8,["data"])),[[ne,A.value]])])):(_(),C(ee,{key:1,description:"暂无素材收藏"},{default:l(()=>[e(v,{type:"primary",onClick:a[7]||(a[7]=t=>s.$router.push("/classic"))},{default:l(()=>[...a[23]||(a[23]=[n("去素材中心",-1)])]),_:1})]),_:1}))]),_:1})]),_:1}),e(U,{label:"反馈建议",name:"feedback"},{default:l(()=>[e(V,{shadow:"never"},{default:l(()=>[e(N,{model:y,class:"profile-form","label-width":"100px"},{default:l(()=>[e(p,{label:"反馈内容"},{default:l(()=>[e(w,{modelValue:y.content,"onUpdate:modelValue":a[8]||(a[8]=t=>y.content=t),type:"textarea",rows:6,placeholder:"请输入您的反馈或建议..."},null,8,["modelValue"])]),_:1}),e(p,{label:"联系方式"},{default:l(()=>[e(w,{modelValue:y.contact,"onUpdate:modelValue":a[9]||(a[9]=t=>y.contact=t),placeholder:"邮箱或手机号（可选）"},null,8,["modelValue"])]),_:1}),e(p,null,{default:l(()=>[e(v,{type:"primary",onClick:Ve},{default:l(()=>[...a[24]||(a[24]=[n("提交反馈",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),e(U,{label:"账号安全",name:"security"},{default:l(()=>[e(V,{shadow:"never"},{default:l(()=>[g("div",da,[a[26]||(a[26]=g("h4",null,"注销账号",-1)),a[27]||(a[27]=g("p",{class:"security-desc"},"注销后账号及关联数据将被删除且无法恢复，请谨慎操作。",-1)),e(v,{type:"danger",plain:"",onClick:Pe},{default:l(()=>[...a[25]||(a[25]=[n("申请注销账号",-1)])]),_:1})])]),_:1}),e(Se,{modelValue:L.value,"onUpdate:modelValue":a[13]||(a[13]=t=>L.value=t),title:"注销账号",width:"400px",class:"cancel-account-dialog","close-on-click-modal":!1,onClosed:Ce},{footer:l(()=>[e(v,{onClick:a[12]||(a[12]=t=>L.value=!1)},{default:l(()=>[...a[29]||(a[29]=[n("取消",-1)])]),_:1}),e(v,{type:"danger",loading:H.value,onClick:Y},{default:l(()=>[...a[30]||(a[30]=[n(" 确认注销 ",-1)])]),_:1},8,["loading"])]),default:l(()=>[e(Fe,{class:"tip-alert cancel-dialog-tip",title:"提示",type:"warning",closable:!1,"show-icon":""},{default:l(()=>[...a[28]||(a[28]=[n(" 注销后账号及关联数据将被删除且无法恢复，请谨慎操作。请先获取验证码，再输入当前密码与验证码并点击「确认注销」。 ",-1)])]),_:1}),Q.value?(_(),q("p",ia," 将向您的邮箱 "+u(Q.value)+" 发送验证码 ",1)):ae("",!0),e(N,{model:f,"label-width":"80px",onSubmit:Be(Y,["prevent"])},{default:l(()=>[e(p,{label:"验证码",required:""},{default:l(()=>[g("div",ua,[e(w,{modelValue:f.email_code,"onUpdate:modelValue":a[10]||(a[10]=t=>f.email_code=t),placeholder:"4位验证码",maxlength:"4","show-word-limit":"",class:"cancel-code-input"},null,8,["modelValue"]),e(v,{type:"primary",disabled:x.value>0,loading:O.value,onClick:xe},{default:l(()=>[n(u(x.value>0?`${x.value}s 后重试`:"获取验证码"),1)]),_:1},8,["disabled","loading"])])]),_:1}),e(p,{label:"当前密码",required:""},{default:l(()=>[e(w,{modelValue:f.password,"onUpdate:modelValue":a[11]||(a[11]=t=>f.password=t),type:"password","show-password":"",placeholder:"请输入当前密码以确认",onKeyup:Ne(Y,["enter"])},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})])])}}}),wa=Ke(ca,[["__scopeId","data-v-1ced5d74"]]);export{wa as default};
//# sourceMappingURL=Profile-BqvX2GPp.js.map
